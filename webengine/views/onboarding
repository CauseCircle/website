{{ include /components/global/Onboarding/styles.html }}

<hr class="p-0 m-0" />

{{ include /components/global/Onboarding/personalInfo.html }}

{{ include /components/global/Onboarding/roleSelection.html }}

{{ include /components/global/Onboarding/npoAdditionChoice.html }}

{{ include /components/global/Onboarding/orgDetails.html }}

{{ include /components/global/Onboarding/orgMedia.html }}

{{ include /components/global/Onboarding/orgReview.html }}

{{ include /components/global/Onboarding/causeSelection.html }}

{{ include /components/global/Onboarding/npoSelection.html }}

{{ include /components/global/Onboarding/summary.html }}

<script type="module">
  $(document).ready(async function () {
    // Function to check for ZUID availability
    async function waitForZuid(maxAttempts = 30, interval = 1000) {
      for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        const userData = JSON.parse(localStorage.getItem("user"));
        const zuid = userData?.zuid;

        if (zuid) {
          console.log(`ZUID found after ${attempt} attempts`);
          return zuid;
        }

        console.log(
          `ZUID not available yet, attempt ${attempt}/${maxAttempts}`
        );

        if (attempt < maxAttempts) {
          await new Promise((resolve) => setTimeout(resolve, interval));
        }
      }

      console.error("ZUID not available after maximum attempts");
      return null;
    }

    // Wait for ZUID to become available
    const zuid = await waitForZuid();

    if (!zuid) {
      console.error("Unable to proceed without ZUID");
      return;
    }

    let userData = await window.getUserProfile(zuid); //first_name, last_name

    // Pre-populate personal info fields if user data exists
    if (userData?.data[0]) {
      const user = userData.data[0];
      if (user.first_name) $("#firstName").val(user.first_name);
      if (user.last_name) $("#lastName").val(user.last_name);
      if (user.email) $("#email").val(user.email);
    }

    async function updateUserProfile(zuid) {
      if (!userData?.data[0]) return;

      const currentUser = userData.data[0];
      const userZuid = zuid;

      // Edit the user data
      currentUser.user_type = selectedRole;

      // Add org data to currentUser object (but exclude from API call)
      if (isNPOFlow() && orgDetails) {
        currentUser.orgDetails = orgDetails;
      }
      // Sync orgMedia from window if it exists (set by orgMedia.html script)
      if (isNPOFlow() && window.orgMedia) {
        orgMedia = window.orgMedia;
      }
      if (isNPOFlow() && orgMedia) {
        currentUser.orgMedia = orgMedia;
      }

      // Handle existing favorite_causes if it's a relationship object
      if (
        currentUser.favorite_causes?.data &&
        Array.isArray(currentUser.favorite_causes.data)
      ) {
        // Extract existing ZUIDs that aren't in the selected list to preserve them
        const existingCauseZuids = currentUser.favorite_causes.data.map(
          (cause) => cause.meta.zuid
        );
        const preservedCauseZuids = existingCauseZuids.filter(
          (zuid) => !selectedCauses.includes(zuid)
        );

        // Combine preserved ZUIDs with newly selected ones
        currentUser.favorite_causes = [
          ...preservedCauseZuids,
          ...selectedCauses,
        ].join(",");
      } else {
        // If it's not a relationship object or doesn't exist, simply set the new value
        currentUser.favorite_causes = selectedCauses.join(",");
      }

      // Handle existing favorite_npos if it's a relationship object
      if (
        currentUser.favorite_npos?.data &&
        Array.isArray(currentUser.favorite_npos.data)
      ) {
        // Extract existing ZUIDs that aren't in the selected list to preserve them
        const existingNpoZuids = currentUser.favorite_npos.data.map(
          (npo) => npo.meta.zuid
        );
        const preservedNpoZuids = existingNpoZuids.filter(
          (zuid) => !selectedNPOs.includes(zuid)
        );

        // Combine preserved ZUIDs with newly selected ones
        currentUser.favorite_npos = [
          ...preservedNpoZuids,
          ...selectedNPOs,
        ].join(",");
      } else {
        // If it's not a relationship object or doesn't exist, simply set the new value
        currentUser.favorite_npos = selectedNPOs.join(",");
      }

      // Update user with the new data (exclude org data from API call)
      const updatedUser = await window.updateZestyUser(userZuid, {
        first_name: personalInfo.firstName,
        last_name: personalInfo.lastName,
        email: personalInfo.email,
        favorite_causes: currentUser.favorite_causes,
        favorite_npos: currentUser.favorite_npos,
        user_type: currentUser.user_type,
        isOnboarded: true,
      });
    }

    let currentStep = 1;
    let personalInfo = {
      firstName: "",
      lastName: "",
      email: "",
    };
    let selectedRole,
      selectedCauses = [],
      selectedNPOs = [],
      npoChoice = null, // 'add-npo' or 'customize-storyhub'
      orgDetails = null,
      orgMedia = null;

    // Helper function to determine if NPO flow should be used
    function isNPOFlow() {
      return selectedRole === 'volunteer' || selectedRole === 'staff';
    }

    // Define step arrays based on selected role and choices
    function getStepArray() {
      if (isNPOFlow()) {
        if (npoChoice === 'add-npo') {
          // Branch A: Add NPO flow
          return [
            "personalInfo",
            "roleSelection",
            "npoAdditionChoice",
            "orgDetails",
            "orgMedia",
            "orgReview",
            "causeSelection",
            "npoSelection",
            "summary"
          ];
        } else if (npoChoice === 'customize-storyhub') {
          // Branch B: Customize StoryHub flow
          return [
            "personalInfo",
            "roleSelection",
            "npoAdditionChoice",
            "causeSelection",
            "npoSelection",
            "summary"
          ];
        } else {
          // Before choice is made
          return [
            "personalInfo",
            "roleSelection",
            "npoAdditionChoice"
          ];
        }
      } else {
        // Regular flow
        return [
          "personalInfo",
          "roleSelection",
          "causeSelection",
          "npoSelection",
          "summary"
        ];
      }
    }

    function updateStepUI() {
      const stepArray = getStepArray();
      const currentStepId = stepArray[currentStep - 1];
      const totalSteps = stepArray.length;

      // Hide all sections
      $(
        "#personalInfo, #roleSelection, #npoAdditionChoice, #orgDetails, #orgMedia, #orgReview, #causeSelection, #npoSelection, #summary"
      ).addClass("d-none");

      // Show current step
      $(`#${currentStepId}`).removeClass("d-none");

      // Update prev/next buttons
      $(".prevBtn").toggleClass("d-none", currentStep === 1);
      $("#nextBtn").text(currentStep === totalSteps ? "Complete" : "Next");

      // Update steps indicator (if exists)
      $("#stepsIndicator .step-item").each(function () {
        const stepNumber = $(this).data("step");
        $(this).removeClass("active completed");
        if (stepNumber < currentStep) {
          $(this).addClass("completed");
          $(this).find(".step-icon").text("âœ“");
        } else if (stepNumber === currentStep) {
          $(this).addClass("active");
          $(this).find(".step-icon").text(stepNumber);
        } else {
          $(this).find(".step-icon").text(stepNumber);
        }
      });

      // Handle step-specific logic
      if (currentStepId === "causeSelection") {
        loadCauses();
      }
      if (currentStepId === "npoSelection") {
        loadNPOs();
      }
      if (currentStepId === "summary") {
        const localUser = localStorage.getItem("user");
        if (localUser) {
          updateUserProfile(JSON.parse(localUser).zuid);
        }
      }
      if (currentStepId === "orgMedia") {
        // Initialize window.orgMedia if not already set
        if (!window.orgMedia) {
          window.orgMedia = orgMedia || { logo: null, coverImage: null };
        }
        if (orgDetails) {
          // Update org name and description display
          $("#orgNameDisplay").text(orgDetails.name || "Your NPO");
          $("#orgDescriptionDisplay").text(orgDetails.description || "Add a short description about your organization");
        }
      }
    }

    $(".role-card").click(function () {
      const $card = $(this);
      const $iconContainer = $card.find(".p-2.rounded-circle");
      const $img = $iconContainer.find("img");
      
      // Remove selected state from all role cards
      $(".role-card").each(function() {
        const $otherCard = $(this);
        const $otherIconContainer = $otherCard.find(".p-2.rounded-circle");
        const $otherImg = $otherIconContainer.find("img");
        const originalSrc = $otherCard.data("original-img-src");
        
        if ($otherCard.hasClass("selected") && originalSrc) {
          // Restore original image
          $otherIconContainer.html(`<img src="${originalSrc}" style="max-width: 40px" />`);
        }
        $otherCard.removeClass("selected");
      });
      
      // Store original image source if not already stored
      if (!$card.data("original-img-src")) {
        $card.data("original-img-src", $img.attr("src"));
      }
      
      // Replace image with purple box and check icon
      $iconContainer.html('<i class="bi bi-check text-white"></i>');
      $iconContainer.css({
        "background-color": "#7b3fee",
        "width": "40px",
        "height": "40px"
      });
      
      $card.addClass("selected");
      selectedRole = $card.data("role");
    });

    $(".nextBtn").click(function () {
      const stepArray = getStepArray();
      const currentStepId = stepArray[currentStep - 1];

      // Validate personal info
      if (currentStepId === "personalInfo") {
        const firstName = $("#firstName").val().trim();
        const lastName = $("#lastName").val().trim();
        const email = $("#email").val().trim();

        if (!firstName || !lastName || !email) {
          alert("Please fill in all personal information fields");
          return;
        }

        if (!isValidEmail(email)) {
          alert("Please enter a valid email address");
          return;
        }

        personalInfo.firstName = firstName;
        personalInfo.lastName = lastName;
        personalInfo.email = email;
      }

      // Validate role selection
      if (currentStepId === "roleSelection" && !selectedRole) {
        alert("Please select a role");
        return;
      }

      // Validate NPO choice
      if (currentStepId === "npoAdditionChoice" && !npoChoice) {
        alert("Please select an option");
        return;
      }

      // Validate org details
      if (currentStepId === "orgDetails") {
        const npoName = $("#npoName").val().trim();
        const npoDescription = $("#npoDescription").val().trim();
        const causeArea = $("#causeArea").val().trim();
        const adminTerms = $("#adminTerms").is(":checked");

        if (!npoName || !npoDescription || !causeArea || !adminTerms) {
          alert("Please fill in all required fields and agree to the Admin Terms");
          return;
        }

        orgDetails = {
          name: npoName,
          description: npoDescription,
          causeArea: causeArea,
          termsAccepted: adminTerms
        };
      }

      // Move to next step
      if (currentStep < stepArray.length) {
        currentStep++;
        updateStepUI();
      }
    });

    $(".skipBtn").click(function () {
      const stepArray = getStepArray();
      const currentStepId = stepArray[currentStep - 1];

      // Handle skip for orgMedia
      if (currentStepId === "orgMedia") {
        orgMedia = {
          logo: null,
          coverImage: null
        };
        window.orgMedia = orgMedia;
      }

      if (currentStep < stepArray.length) {
        currentStep++;
        updateStepUI();
      }
    });

    // Email validation function
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    $(".prevBtn").click(function () {
      if (currentStep > 1) {
        currentStep--;
        updateStepUI();
      }
    });

    // Handle NPO choice card clicks
    $(document).on("click", ".npo-choice-card", function () {
      const $card = $(this);
      const choice = $card.data("choice");

      // Remove selected state from all choice cards
      $(".npo-choice-card").removeClass("selected");

      // Add selected state to clicked card
      $card.addClass("selected");
      npoChoice = choice;

      // Auto-advance to next step
      setTimeout(() => {
        const stepArray = getStepArray();
        if (currentStep < stepArray.length) {
          currentStep++;
          updateStepUI();
        }
      }, 300);
    });

    // Handle org review action card clicks
    $(document).on("click", ".org-action-card", function () {
      const $card = $(this);
      const action = $card.data("action");

      if (action === "manage-npo") {
        // Does nothing for now - just show visual feedback
        $card.addClass("selected");
        setTimeout(() => {
          $card.removeClass("selected");
        }, 500);
        return;
      } else if (action === "customize-storyhub") {
        // Remove selected state from all action cards
        $(".org-action-card").removeClass("selected");
        $card.addClass("selected");

        // Navigate to causeSelection
        const stepArray = getStepArray();
        const causeIndex = stepArray.indexOf("causeSelection");
        if (causeIndex !== -1) {
          currentStep = causeIndex + 1;
          updateStepUI();
        }
      }
    });

    // Handle description character counter
    $(document).on("input", "#npoDescription", function () {
      const length = $(this).val().length;
      $("#descriptionCharCount").text(length);
    });

    function searchNPOs(searchTerm) {
      const limit = searchTerm ? 5 : 100;

      $.ajax({
        url: "{{ $base_url }}mobileapp/npos.json",
        method: "GET",
        data: {
          limit: limit,
          search: searchTerm,
          page: 1,
        },
        success: function (data) {
          //logic here
        },
        error: function (error) {
          //logic here
        },
      });
    }

    function loadCauses(searchTerm) {
      const limit = searchTerm ? 5 : 25;

      // Show loading indicator
      $("#cause-loading").removeClass("d-none");
      $("#cause-container").addClass("d-none");

      $.ajax({
        url: "{{ $base_url }}mobileapp/causes.json",
        method: "GET",
        data: {
          limit: limit,
          search: searchTerm,
          page: 1,
        },
        success: function (response) {
          const causes = response.data;
          const causeContainer = $("#cause-container");
          causeContainer.empty();

          causes.forEach((cause) => {
            const imageUrl =
              typeof cause.image === "string" && cause.image.trim() !== ""
                ? cause.image
                : cause.image && cause.image.data && cause.image.data[0]
                ? cause.image.data[0].url
                : "https://placehold.co/100x100";
            const description = cause.description
              ? cause.description.substring(0, 100) + "..."
              : "No description available";

            const causeCard = `
              <div class="card cause-card" data-cause-id="${cause.zuid}">
                <div class="d-flex gap-2 align-items-center p-3">
                  <img src="${imageUrl}" alt="${cause.title}" style="width: 60px; height: 60px; object-fit: cover;">
                  <div class="flex-grow-1">
                    <p class="fs-5 mb-0 cause-title" style="font-size: 14px">${cause.title}</p>
                    <div class="text-muted mb-0 cause-description" style="font-size: 12px">${description}</div>
                  </div>
                </div>
              </div>
            `;
            causeContainer.append(causeCard);
          });

          // Add click event for cause selection
          $(".cause-card").click(function () {
            const $card = $(this);
            const causeId = $card.data("cause-id");
            const $img = $card.find("img");
            const originalSrc = $card.data("original-img-src") || $img.attr("src");
            
            // Store original image source if not already stored
            if (!$card.data("original-img-src")) {
              $card.data("original-img-src", originalSrc);
            }
            
            $card.toggleClass("selected"); // Toggle selection on click
            if ($card.hasClass("selected")) {
              // Replace image with purple box and check icon
              $img.replaceWith(`
                <div class="card-icon-container">
                  <i class="bi bi-check"></i>
                </div>
              `);
              selectedCauses.push(causeId); // Add to selected causes
            } else {
              // Restore original image
              $card.find(".card-icon-container").replaceWith(`<img src="${originalSrc}" alt="${$card.find('.cause-title').text()}" style="width: 60px; height: 60px; object-fit: cover;">`);
              selectedCauses = selectedCauses.filter((id) => id !== causeId); // Remove from selected causes
            }

            if (selectedCauses.length > 0) {
              $(".selectedCauses-btn").prop("disabled", false);
            } else {
              $(".selectedCauses-btn").prop("disabled", true);
            }
          });

          $(".selectedCauses-btn").prop("disabled", true);

          // Hide loading indicator and show results
          $("#cause-loading").addClass("d-none");
          $("#cause-container").removeClass("d-none");
        },
        error: function (error) {
          console.error("Error fetching causes:", error);
          // Hide loading indicator on error
          $("#cause-loading").addClass("d-none");
          $("#cause-container").removeClass("d-none");
        },
      });
    }

    // Debounce function for search input
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function loadNPOs(searchTerm) {
      const limit = searchTerm ? 5 : 25;

      // Show loading indicator
      $("#npo-loading").removeClass("d-none");
      $("#npo-container").addClass("d-none");

      $.ajax({
        url: "{{ $base_url }}mobileapp/npos.json",
        method: "GET",
        data: {
          limit: limit,
          search: searchTerm,
          page: 1,
        },
        success: function (response) {
          const npos = response.data;
          const npoContainer = $("#npo-container");
          npoContainer.empty();

          npos.forEach((npo) => {
            const imageUrl =
              npo.logo && npo.logo.data && npo.logo.data[0]
                ? npo.logo.data[0].url
                : "https://placehold.co/100x100";
            const description = npo.cause_description
              ? npo.cause_description.substring(0, 100) + "..."
              : "No description available";

            const npoCard = `
              <div class="card npo-card" data-npo-id="${npo.meta.zuid}">
                <div class="d-flex gap-2 align-items-center p-3">
                  <img src="${imageUrl}" alt="${npo.name}" style="width: 60px; height: 60px; object-fit: cover;">
                  <div class="card-content">
                    <p class="fs-5 mb-0 cause-title" style="font-size: 14px">${npo.name}</p>
                    <div class="text-muted mb-0 cause-description" style="font-size: 12px">${description}</div>
                  </div>
                </div>
              </div>
            `;
            npoContainer.append(npoCard);
          });

          // Add click event for NPO selection
          $(".npo-card").click(function () {
            const $card = $(this);
            const npoId = $card.data("npo-id");
            const $img = $card.find("img");
            const originalSrc = $card.data("original-img-src") || $img.attr("src");
            
            // Store original image source if not already stored
            if (!$card.data("original-img-src")) {
              $card.data("original-img-src", originalSrc);
            }
            
            $card.toggleClass("selected");
            if ($card.hasClass("selected")) {
              // Replace image with purple box and check icon
              $img.replaceWith(`
                <div class="card-icon-container">
                  <i class="bi bi-check"></i>
                </div>
              `);
              selectedNPOs.push(npoId);
            } else {
              // Restore original image
              $card.find(".card-icon-container").replaceWith(`<img src="${originalSrc}" alt="${$card.find('.cause-title').text()}" style="width: 60px; height: 60px; object-fit: cover;">`);
              selectedNPOs = selectedNPOs.filter((id) => id !== npoId);
            }

            if (selectedNPOs.length > 0) {
              $(".selectedNPOs-btn").prop("disabled", false);
            } else {
              $(".selectedNPOs-btn").prop("disabled", true);
            }
          });

          $(".selectedNPOs-btn").prop("disabled", true);

          // Hide loading indicator and show results
          $("#npo-loading").addClass("d-none");
          $("#npo-container").removeClass("d-none");
        },
        error: function (error) {
          console.error("Error fetching NPOs:", error);
          // Hide loading indicator on error
          $("#npo-loading").addClass("d-none");
          $("#npo-container").removeClass("d-none");
        },
      });
    }

    $("#causeSearchInput").on(
      "input",
      debounce(function () {
        const searchTerm = $(this).val().trim();
        loadCauses(searchTerm);
      }, 300)
    );

    $("#npoSearchInput").on(
      "input",
      debounce(function () {
        const searchTerm = $(this).val().trim();
        loadNPOs(searchTerm);
      }, 300)
    );

    function showSummary() {
      const summaryContent = $("#summaryContent");
      summaryContent.empty();

      // Add role summary
      summaryContent.append(`<h3>Selected Role</h3><p>${selectedRole}</p>`);

      // Add causes summary
      summaryContent.append(`<h3>Selected Causes</h3>`);
      if (selectedCauses.length > 0) {
        const causesList = selectedCauses
          .map((causeId) => {
            const causeElement = $(`.cause-card[data-cause-id="${causeId}"]`);
            return causeElement.find(".fs-5").text();
          })
          .join(", ");
        summaryContent.append(`<p>${causesList}</p>`);
      } else {
        summaryContent.append(`<p>No causes selected</p>`);
      }

      // Add NPOs summary
      summaryContent.append(`<h3>Selected NPOs</h3>`);
      if (selectedNPOs.length > 0) {
        const nposList = selectedNPOs
          .map((npoId) => {
            const npoElement = $(`.npo-card[data-npo-id="${npoId}"]`);
            return npoElement.find(".fs-5").text();
          })
          .join(", ");
        summaryContent.append(`<p>${nposList}</p>`);
      } else {
        summaryContent.append(`<p>No NPOs selected</p>`);
      }
    }

    // Add a click handler for the complete button
    $(".completeBtn").click(function () {
      // Handle completion
    });

    // Initial UI update
    updateStepUI();

    const claimListingRedirectUrl = localStorage.getItem(
      "claimListingRedirectUrl"
    );

    if (claimListingRedirectUrl) {
      $("#createContentBtn")
        .attr("href", claimListingRedirectUrl + "?claim-listing-redirect=true")
        .text("Return to Claim Listing");
    }

    localStorage.removeItem("claimListingRedirectUrl");
  });
</script>
