<script type="module">
  // ==================== BASE URL ====================
  const BASE_URL = "https://api.causecircle.org";
  // const BASE_URL = "http://localhost:8080";

  // ==================== ZOHO ====================
  window.claimListing = async (data) => {
    try {
      const response = await fetch(`${BASE_URL}/zoho`, {
        method: "POST",
        body: JSON.stringify(data),
      });
      return response.json();
    } catch (error) {
      console.error("Error claiming listing:", error);
      throw error;
    }
  };

  // ==================== MEDIA UPLOAD ====================
  window.newUploadMedia = async (mediaFiles) => {
    const allowedTypes = ["image/jpeg", "image/png", "image/gif", "image/webp", "image/heic", "image/heif", "image/jpg", "video/mp4", "video/x-flv", "video/quicktime"];
    const allowedImageTypes = ["image/jpeg", "image/png", "image/gif", "image/webp", "image/heic", "image/heif", "image/jpg"];
    const allowedVideoTypes = ["video/mp4", "video/x-flv", "video/quicktime"];
    const MAX_VIDEO_SIZE_MB = 250; // Video file size limit (matches backend)
    const MAX_VIDEO_SIZE_BYTES = MAX_VIDEO_SIZE_MB * 1024 * 1024;

    const user = firebase.auth().currentUser;
    if (!user) {
      console.error("User not authenticated for media upload.");
      alert("You must be logged in to upload media.");
      throw new Error("User not authenticated.");
    }

    const userId = user.uid;
    const validMediaFiles = mediaFiles.filter(file => file instanceof File && file.type && allowedTypes.includes(file.type));

    if (validMediaFiles.length === 0) {
      return [];
    }

    // Check individual file sizes (only for videos, no limit for images)
    for (const file of validMediaFiles) {
      if (allowedVideoTypes.includes(file.type) && file.size > MAX_VIDEO_SIZE_BYTES) {
        const errorMessage = `Video file "${file.name}" (${(file.size / (1024*1024)).toFixed(2)}MB) exceeds the size limit of ${MAX_VIDEO_SIZE_MB}MB.`;
        console.error(errorMessage);
        alert(errorMessage);
        throw new Error(errorMessage);
      }
    }

         // Step 1: Get signed URLs for all files
     const getSignedUrl = async (filename) => {
       try {
         const response = await fetch(`${BASE_URL}/media/signed-url?filename=${encodeURIComponent(filename)}`, {
           method: "GET",
           headers: {
             Authorization: `Bearer ${userId}`,
           },
         });

        if (!response.ok) {
          let errorData;
          try {
            errorData = await response.json();
          } catch (e) {
            errorData = { message: `Failed to get signed URL with status: ${response.status}` };
          }
          console.error("Signed URL request error:", errorData);
          throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }

        const signedUrlData = await response.json();
        return signedUrlData;
      } catch (error) {
        console.error(`Failed to get signed URL for ${filename}:`, error.message);
        throw error;
      }
    };

    // Step 2: Upload file to signed URL
    const uploadToSignedUrl = async (file, signedUrlData) => {
      try {

        const response = await fetch(signedUrlData.url, {
          method: "PUT",
          headers: {
            "Content-Type": signedUrlData.contentType,
          },
          body: file,
        });

        if (!response.ok) {
          const errorText = await response.text().catch(() => 'No error details available');
          console.error(`Failed to upload ${file.name} to signed URL:`, {
            status: response.status,
            statusText: response.statusText,
            errorText: errorText,
            signedUrlData: signedUrlData
          });
          throw new Error(`Upload to signed URL failed with status: ${response.status} - ${response.statusText}`);
        }

        return signedUrlData.filename;
      } catch (error) {
        console.error(`Failed to upload ${file.name} to signed URL:`, error.message);
        throw error;
      }
    };

         // Step 3: Register uploaded files with the media service
     const registerUploadedFiles = async (filenames) => {
       try {
         const response = await fetch(`${BASE_URL}/media/uploads/gcs`, {
           method: "POST",
           headers: {
             "Content-Type": "application/json",
             Authorization: `Bearer ${userId}`,
           },
           body: JSON.stringify({
             files: filenames,
           }),
         });

        if (!response.ok) {
          let errorData;
          try {
            errorData = await response.json();
          } catch (e) {
            errorData = { message: `Failed to register files with status: ${response.status}` };
          }
          console.error("File registration error:", errorData);
          throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }

        const responseData = await response.json();
        if (responseData && typeof responseData.data !== 'undefined') {
          return Array.isArray(responseData.data) ? responseData.data : [responseData.data];
        } else {
          console.error("Unexpected response structure from file registration:", responseData);
          throw new Error("Failed to process registration response: 'data' field missing or invalid.");
        }
      } catch (error) {
        console.error("Failed to register uploaded files:", error.message);
        throw error;
      }
    };

    try {
      // Process all files
      const uploadPromises = validMediaFiles.map(async (file) => {
        try {
          // Step 1: Get signed URL (use sanitized filename from backend)
          const signedUrlData = await getSignedUrl(file.name);

          // Step 2: Upload to signed URL (use the exact filename from signed URL response)
          await uploadToSignedUrl(file, signedUrlData);

          // Return the sanitized filename that was actually used in GCS
          return signedUrlData.filename;
        } catch (error) {
          console.error(`Failed to process file ${file.name}:`, error.message);
          throw error;
        }
      });

      // Wait for all uploads to complete
      const uploadedFilenames = await Promise.all(uploadPromises);

      // Step 3: Register all uploaded files using the sanitized filenames
      const registrationResult = await registerUploadedFiles(uploadedFilenames);

      return registrationResult;
    } catch (error) {
      console.error("Media upload process failed:", error.message);
      alert(`Failed to upload media: ${error.message || "An error occurred during upload. Please try again."}`);
      throw error;
    }
  };

  // Keep the old function for backward compatibility
  window.newUploadImages = window.newUploadMedia;
</script>
