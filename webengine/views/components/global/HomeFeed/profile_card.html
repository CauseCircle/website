<style>
  .card-header {
    background-color: #8a2be2;
    height: 80px;
    border-top-left-radius: 0.5rem !important;
    border-top-right-radius: 0.5rem !important;
  }
  .profile-image {
    width: 100%;
    height: 100%;
    border-radius: 0.5rem;
    /* border: 4px solid white; */
    object-fit: cover;
  }

  .profile-image-container {
    position: absolute;
    top: 40px;
    left: 20px;
    width: 80px;
    height: 80px;
    border-radius: 0.5rem;
    border: 4px solid white;
  }
  .camera-icon {
    position: absolute;
    top: 15px;
    right: 15px;
    color: white;
    font-size: 1.5rem;
  }
  .background-img {
    width: 100%;
    height: 80px;
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
    object-fit: cover;
  }
</style>

<!--prettier-ignore-->
{{ include /components/global/HomeFeed/upload_bg_image_modal.html }}
<!--prettier-ignore-->
{{ include /components/global/HomeFeed/upload_profile_image_modal.html }}

<div class="card" id="profile-card">
  <div class="">
    <img src="https://4xxglxlj.media.zestyio.com/minimalistic-blur-gradient-banner-web-app-backdrop-design_1017-44315-1-.jpg" class="background-img" id="background-image" alt="Background Image"/>
    <button
      class="btn bg-transparent camera-icon"
      data-bs-toggle="modal"
      data-bs-target="#uploadBgImageModal"
      aria-label="Upload background image"
      title="Upload background image"
    >
      <i class="bi bi-camera"></i>
    </button>
  </div>
  <div class="profile-image-container">
    <img src="https://www.gravatar.com/avatar/?d=mp" class="profile-image" id="profile-image" alt="Profile Image"/>
    <button
      class="btn btn-sm btn-light rounded-circle position-absolute bottom-0 end-0 m-1"
      id="change-profile-image-btn"
      data-bs-toggle="modal"
      data-bs-target="#uploadProfileImageModal"
      aria-label="Upload profile image"
      title="Upload profile image"
    >
      <i class="bi bi-camera"></i>
    </button>
  </div>
  <div class="card-body pt-5 mt-3">
    <h5 class="card-title mb-0" id="user-name"></h5>
    <p class="card-text text-muted mb-3" id="user-type"></p>
    <p class="card-text text-muted small mb-3" id="user-email"></p>
    <p class="card-text d-flex align-items-center d-none" id="favorite-cause">
      <img
        src=""
        class="me-2"
        style="width: 20px; height: 20px; object-fit: fill; border-radius: 4px;"
        id="cause-logo"
        alt="Cause Logo"
      />
      <span id="cause-name"></span>
    </p>
  </div>
</div>

<script type="module">
  const updateProfileCard = async (userProfile) => {
    const data = userProfile.data[0];

    if (typeof data.profile_image === "string" && data.profile_image !== "" && data.profile_image !== null) {
          $("#profile-image").attr("src", `${data.profile_image}?width=80`);
    } else if (
      data.profile_image &&
      data.profile_image.data &&
      data.profile_image.data.length > 0 &&
      data.profile_image.data[0].url
      
    ) {
      $("#profile-image").attr("src", `${data.profile_image.data[0].url}?width=80`);
    } else {
      $("#profile-image").attr("src", "https://www.gravatar.com/avatar/?d=mp");
    }

    // Update background image
    if (typeof data.background_image === "string" && data.background_image !== "" && data.background_image !== null) {
      $("#background-image").attr("src", `${data.background_image}?width=300`);
    } else if (
      data.background_image &&
      data.background_image.data &&
      data.background_image.data.length > 0 &&
      data.background_image.data[0].url
    ) {
      $("#background-image").attr("src", `${data.background_image.data[0].url}?width=300`);
    } else {
      $("#background-image").attr(
        "src",
        "https://4xxglxlj.media.zestyio.com/minimalistic-blur-gradient-banner-web-app-backdrop-design_1017-44315-1-.jpg?width=300"
      );
    }

    // Update user name
    $("#user-name").text(data.first_name + " " + data.last_name);

    // Update user type (if available)
    if (data.user_type) {
      $("#user-type").text(
        data.user_type.charAt(0).toUpperCase() + data.user_type.slice(1)
      );
    } else {
      $("#user-type").hide();
    }

    // Update user email (if available)
    if (data.email) {
      $("#user-email").text(data.email);
    } else {
      $("#user-email").hide();
    }

    // Update favorite NPO (if available)
    if (data?.favorite_causes && data?.favorite_causes?.data?.length > 0) {
      const cause = data?.favorite_causes?.data[0];
      $("#cause-name").text(cause?.title || "Favorite Cause");
      if (cause?.image) {
        $("#cause-logo").attr("src", `${cause?.image?.data[0]?.url}?width=20&quality=60&format=webp`);
      } else {
        $("#cause-logo").hide();
      }
      $("#favorite-cause").removeClass("d-none");
    } else {
      $("#favorite-cause").hide();
      $("#cause-name").hide();
      $("#cause-logo").hide();
    }
  }
  $(document).ready(function () {
    const authUser = JSON.parse(localStorage.getItem("user"));
    
    if (!authUser || !authUser.zuid) {
      console.error("No authenticated user found");
      return;
    }

    // Create user profile query observer
    const userProfileQuery = window.createUserProfileQuery(authUser.zuid);
    
    // Subscribe to user profile query changes
    const unsubscribe = userProfileQuery.subscribe((result) => {
      if (result.status === 'success' && result.data) {
        const userProfile = result.data;
        updateProfileCard(userProfile);
        unsubscribe();
      } else if (result.status === 'error') {
        console.error("Error loading user profile:", result.error);
        unsubscribe();
      }
    });
  });
</script>
