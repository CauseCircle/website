<style>
  .cause-card {
    position: relative;
    height: 200px;
    border-radius: 10px;
    overflow: hidden;
  }
  .cause-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .cause-card .overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    padding: 10px;
  }
  .carousel-control-prev,
  .carousel-control-next {
    width: 5%;
  }
</style>

<style>
  .story-image {
    height: 100%;
    max-height: 100px;
    object-fit: cover;
    border-radius: 10px;
  }
  .story-title {
    font-size: 16px;
    font-weight: 500;
    color: #0e121b;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .story-subtitle {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    max-height: 2.8em; /* Adjust this value based on your line-height */
    line-height: 1.4em; /* Adjust this value as needed */
  }
  .story-subtitle,
  .npo-name {
    font-size: 14px;
    font-weight: 400;
    color: #0e121b;
  }
  .story-cause {
    padding: 0 10px;
    /* height: 28px; */
    border-radius: 14px;
    background-color: #eceff3;
    text-transform: uppercase;
    font-size: 12px;
    /* font-weight: bold; */
  }
  .story-date {
    font-size: 12px;
  }
  .story-npo-logo {
    width: 24px;
    height: 24px;
    border: 1px solid #aeaeae;
    border-radius: 3px;
    object-fit: cover;
    object-position: center;
  }
  .story-btn {
    font-size: 12px;
    font-weight: 500;
    color: #0e121b;
  }
  .story-card {
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
  }
  .story-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }
  .story-btn {
    transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
  }
  .story-card:hover .story-btn {
    background-color: #7b3fee;
    color: white;
  }
  .card-btn {
    height: 36px;
  }
  .npo-name {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
</style>

<div class="my-4">
  <h2 class="mb-4 fw-semibold fs-6">Stories You Might Like</h2>
  <div id="storiesCarousel" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner" id="stories-carousel-inner">
      <div class="carousel-item active">
        <div class="row">
          <div class="col-12 text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <button
      class="carousel-control-prev"
      type="button"
      data-bs-target="#storiesCarousel"
      data-bs-slide="prev"
    >
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button
      class="carousel-control-next"
      type="button"
      data-bs-target="#storiesCarousel"
      data-bs-slide="next"
    >
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>
</div>

<script type="module">
  $(document).ready(function() {
    // Helper functions copied/adapted from stories_landing_page
    function isVideoUrl(url) {
      if (!url) return false;
      const videoPatterns = [
        /vimeo\.com\/video\/\d+/i,
        /vimeo\.com\/\d+/i,
        /player\.vimeo\.com\/video\/\d+/i,
        /youtube\.com\/watch\?v=/i,
        /youtu\.be\//i,
        /\.mp4$/i,
        /\.webm$/i,
        /\.ogg$/i,
        /\.mov$/i,
        /\.avi$/i
      ];
      return videoPatterns.some(pattern => pattern.test(url));
    }

    function getVideoEmbedUrl(url) {
      if (!url) return null;
      if (url.includes('player.vimeo.com/video/')) {
        return url.includes('?') ? url : `${url}?autoplay=0&loop=0&muted=0`;
      }
      const vimeoMatch = url.match(/vimeo\.com\/(?:video\/)?(\d+)/i);
      if (vimeoMatch) {
        return `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=0&loop=0&muted=0`;
      }
      const youtubeMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/i);
      if (youtubeMatch) {
        return `https://www.youtube.com/embed/${youtubeMatch[1]}?autoplay=0&loop=0&muted=0`;
      }
      if (/\.(mp4|webm|ogg|mov|avi)$/i.test(url)) {
        return url;
      }
      return null;
    }

    function createCardMediaElement(mediaUrl, storyTitle) {
      if (!mediaUrl) {
        return `<img src="https://placehold.co/600x400?text=No+Image" class="story-image" alt="${storyTitle}">`;
      }
      const isVideo = isVideoUrl(mediaUrl);
      if (isVideo) {
        const embedUrl = getVideoEmbedUrl(mediaUrl);
        if (embedUrl && (embedUrl.includes('youtube.com') || embedUrl.includes('vimeo.com'))) {
          return `
            <iframe 
              src="${embedUrl}" 
              class="story-image" 
              style="border: none; border-radius: 10px; object-fit: cover;" 
              frameborder="0" 
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen
              title="${storyTitle}">
            </iframe>
          `;
        } else {
          return `
            <video 
              class="story-image" 
              style="object-fit: cover; border-radius: 10px;" 
              controls 
              preload="metadata"
              title="${storyTitle}">
              <source src="${mediaUrl}" type="video/mp4">
              <source src="${mediaUrl}" type="video/webm">
              <source src="${mediaUrl}" type="video/ogg">
              Your browser does not support the video tag.
            </video>
          `;
        }
      }
      return `<img src="${mediaUrl}?width=150" class="story-image" alt="${storyTitle}">`;
    }

    function createStoryCard(story) {
      let mediaUrl = '';
      if (typeof story?.story_image === 'string') {
        mediaUrl = story.story_image || '';
      } else if (story?.story_image?.data && story.story_image.data.length > 0) {
        mediaUrl = story.story_image.data[0]?.url || '';
      }
      const mediaElement = createCardMediaElement(mediaUrl, story?.title || '');

      return `
        <div class="col-md-4 mb-3">
          <div class="card d-flex flex-column h-100 p-3 gap-2 story-card">
            ${mediaElement}
            <div class="d-flex flex-column gap-2 h-100">
              <div class="d-flex justify-content-between">
                <p class="story-date d-none"></p>
                ${
                  story.related_causes && story.related_causes.length > 0
                    ? `<div class=\"story-cause d-flex align-items-center\">
                        <p class=\"text-center\">${story.related_causes[0]?.title || ""}</p>
                       </div>`
                    : ""
                }
              </div>
              <p class="story-title">${story.title}</p>
              <div class="story-subtitle d-none">${story.description || ''}</div>
              <div class="d-flex flex-grow-1 align-items-end gap-2">
                <div class="d-flex gap-2 align-items-center w-100">
                  <img src="${
                    story.related_npos && story.related_npos.data.length > 0
                      ? (story.related_npos.data[0]?.logo?.data
                          ? story.related_npos.data[0]?.logo?.data[0]?.url
                          : story.related_npos.data[0]?.logo) || ''
                      : ''
                  }?width=24" class="story-npo-logo" alt="NPO logo" />
                  <p class="npo-name my-auto text-truncate">${
                    story.related_npos && story.related_npos.data.length > 0
                      ? story.related_npos.data[0]?.name || ''
                      : ''
                  }</p>
                </div>
              </div>
              <a href="${story.meta.web.uri}" class="btn btn-secondary story-btn card-btn">Read More</a>
            </div>
          </div>
        </div>
      `;
    }

    function chunkArray(array, size) {
      const result = [];
      for (let i = 0; i < array.length; i += size) {
        result.push(array.slice(i, i + size));
      }
      return result;
    }

    async function loadLatestStoriesForSlider() {
      const $carouselInner = $("#stories-carousel-inner");
      
      try {
        // Use TanStack Query for latest stories
        const latestStoriesQuery = window.createStoriesQuery({
          limit: "6",
          approved: "1",
          status: "approved",
          sort: "created_at",
          order: "desc"
        });

        // Subscribe to query state changes
        const unsubscribe = latestStoriesQuery.subscribe((result) => {
          if (result.status === 'success' && result.data) {
            const stories = result.data.data || [];
            $carouselInner.empty();

            if (stories.length === 0) {
              $carouselInner.append(`
                <div class="carousel-item active">
                  <div class="row">
                    <div class="col-12"><p class="text-muted text-center">No stories available.</p></div>
                  </div>
                </div>
              `);
              return;
            }

            const groups = chunkArray(stories.slice(0, 6), 3);
            groups.forEach((group, index) => {
              const cardsHtml = group.map(createStoryCard).join('');
              const itemHtml = `
                <div class="carousel-item ${index === 0 ? 'active' : ''}">
                  <div class="row">
                    ${cardsHtml}
                  </div>
                </div>
              `;
              $carouselInner.append(itemHtml);
            });

            $("#storiesCarousel").carousel();
            unsubscribe();
          } else if (result.status === 'error') {
            console.error("Error fetching latest stories for slider:", result.error);
            $carouselInner.html(`
              <div class="carousel-item active">
                <div class="row">
                  <div class="col-12"><p class="text-danger text-center">Error loading stories.</p></div>
                </div>
              </div>
            `);
            unsubscribe();
          }
        });
      } catch (error) {
        console.error("Error fetching latest stories for slider:", error);
        $carouselInner.html(`
          <div class="carousel-item active">
            <div class="row">
              <div class="col-12"><p class="text-danger text-center">Error loading stories.</p></div>
            </div>
          </div>
        `);
      }
    }

    loadLatestStoriesForSlider();
  });
</script>
