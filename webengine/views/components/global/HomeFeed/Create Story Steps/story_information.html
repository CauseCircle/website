<style>
  #npoDropdown,
  #categoryDropdown {
    position: absolute;
    width: 100%;
    z-index: 1000;
  }
  #npoDropdown .dropdown-item,
  #categoryDropdown .dropdown-item {
    white-space: normal;
  }
  #useCurrentLocation {
    min-width: 140px;
  }
  .image-upload-container {
    width: 100%;
  }
  .image-preview {
    width: 100%;
    height: 270px;
    border: 2px dashed #ccc;
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    background-color: #f8f9fa;
  }
  .preview-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 5px;
  }
  .preview-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 5px;
  }
  .preview-item.video-preview::before {
    content: "â–¶";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    color: white;
    text-shadow: 0 0 3px rgba(0, 0, 0, 0.8);
    pointer-events: none;
    z-index: 5;
    background-color: rgba(0, 0, 0, 0.3);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding-left: 3px;
  }
  .custom-file-input {
    display: none;
  }
  #removeImageBtn {
    width: 30px;
    height: 30px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    z-index: 10;
  }
  #removeImageBtn i {
    font-size: 14px;
  }
  .upload-message {
    text-align: center;
    padding: 20px;
  }
  .upload-area {
    border: var(--bs-border-width) solid var(--bs-border-color);
    border-radius: 8px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: all 0.2s;
    background-color: #ffffff;
  }
  .upload-area:hover {
    background-color: #f8f9fa;
    border-color: #adb5bd;
  }
  .upload-area.disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  .upload-area.disabled:hover {
    background-color: #ffffff;
    border-color: var(--bs-border-color);
  }
  .upload-info-text {
    font-size: 14px;
    color: #6c757d;
    margin-top: 4px;
    margin-bottom: 12px;
  }
  .preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
  }
  .preview-item {
    width: 100px;
    height: 100px;
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    background: repeating-conic-gradient(#f8f9fa 0% 25%, #e9ecef 0% 50%) 50% / 20px 20px;
    cursor: pointer;
  }
  .preview-item img,
  .preview-item video {
    position: relative;
    z-index: 1;
  }
  .remove-btn {
    position: absolute;
    top: 5px;
    left: 5px;
    background-color: #F2F5F8;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    color: #6c757d;
    opacity: 0;
    visibility: hidden;
    transition: background-color 0.2s, opacity 0.2s;
  }
  .preview-item:hover .remove-btn,
  .preview-item:focus-within .remove-btn {
    opacity: 1;
    visibility: visible;
  }
  .upload-success-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: #E0FAEC;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }
  .upload-success-badge i {
    color: #178C4E;
    font-size: 12px;
  }
  .upload-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5;
  }
  .add-more {
    width: 100px;
    height: 100px;
    border: 1px dashed #adb5bd;
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    background-color: #ffffff;
    transition: all 0.2s;
  }
  .add-more:hover {
    background-color: #f8f9fa;
    border-color: #6c757d;
  }
  .add-more svg {
    color: #6c757d;
  }
  .extra-images-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
  }
  .preview-item.dragging {
    opacity: 0.5;
    border: 2px dashed #007bff; /* Using a Bootstrap primary color for consistency */
  }
  .url-preview-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    background: #fff;
    transition: box-shadow 0.2s;
  }
  .url-preview-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  .url-preview-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    background-color: #f8f9fa;
  }
  .url-preview-content {
    padding: 12px;
    background-color: #F2F5F8;
  }
  .url-preview-description {
    font-size: 13px;
    color: #6c757d;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  .url-preview-url {
    font-size: 12px;
    color: #0d6efd;
    text-decoration: none;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
  }
  .url-preview-loading {
    text-align: center;
    padding: 20px;
    color: #6c757d;
  }
</style>

<section id="storyInformationSelection" class="section-container d-none">
  <div class="py-4">
    <div
      class="d-flex flex-column gap-2 justify-content-center align-items-center"
    >
      <img class="section-icon d-none" src="" style="max-width: 160px" alt="Step icon" />
      <div class="d-flex flex-column gap-2 align-items-center">
        <p class="section-title fs-1 fw-normal mb-0"></p>
        <p class="section-description fs-5 text-muted mb-0 text-center"></p>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-center align-items-center flex-column">
    <div class="mb-4" style="max-width: 480px; width: 100%">
      <form id="storyDetailsForm" novalidate>
        <div class="mb-4">
          <label for="selectNPO" class="form-label">
            What Nonprofit are you sharing about? <span class="text-danger">*</span>
          </label>
          <div class="dropdown">
            <input
              type="text"
              class="form-control"
              id="npoSearchInput"
              placeholder="Search NPOs..."
              autocomplete="off"
            />
            <ul
              class="dropdown-menu w-100"
              id="npoDropdown"
              style="max-height: 300px; overflow-y: auto"
            >
              <!-- NPO options will be dynamically added here -->
            </ul>
          </div>
          <input type="hidden" id="selectedNPO" name="selectedNPO" required />
          <div class="invalid-feedback">Please select an NPO.</div>
        </div>

        <div class="" id="storyMediaField">
          <label for="storyImages" class="form-label">
            Story Media <span class="text-danger">*</span>
          </label>
          <p class="upload-info-text">Upload up to 20 files, up to 30MB each.</p>
          <div id="uploadArea" class="upload-area">
            <button
              id="browseButton"
              class="btn btn-secondary"
              type="button"
            >
              Browse Files
            </button>
            <span class="text-muted" style="font-size: 14px;">or drag and drop your file here</span>
          </div>
          <input
            type="file"
            id="fileInput"
            style="display: none"
            multiple
            accept="image/jpeg,image/png,image/jpg,image/webp,image/heic,image/heif,video/mp4,video/x-flv,video/quicktime"
          />
          <div id="previewContainer" class="preview-container mb-4"></div>
        </div>

        <div class="mb-4 d-none" id="storyUrlGroup">
          <label for="storyUrl" class="form-label">
            Website URL <span class="text-danger">*</span>
          </label>
          <div class="input-group">
            <span class="input-group-text bg-white">https://</span>
            <input
              type="text"
              class="form-control"
              id="storyUrl"
              placeholder="www.example.com"
              aria-describedby="storyUrlHelp"
            />
          </div>
          <div class="invalid-feedback">Please enter a valid URL.</div>
          
          <!-- URL Preview Card -->
          <div id="urlPreviewContainer" class="mt-3 d-none">
            <!-- Loading State -->
            <div id="urlPreviewLoading" class="url-preview-loading d-none">
              <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
              <span>Loading preview...</span>
            </div>
            
            <!-- Preview Card -->
            <div id="urlPreviewCard" class="url-preview-card d-none">
              <img id="urlPreviewImage" class="url-preview-image" src="" alt="Preview" />
              <div class="url-preview-content">
                <a id="urlPreviewUrl" class="url-preview-url text-primary" href="#" target="_blank"></a>
                <div id="urlPreviewDescription" class="url-preview-description"></div>
              </div>
            </div>
            
            <!-- No Preview Available -->
            <div id="urlPreviewNoPreview" class="url-preview-card d-none">
              <div class="url-preview-content">
                <a id="urlPreviewUrlFallback" class="url-preview-url text-primary" href="#" target="_blank"></a>
                <div id="urlPreviewDescriptionFallback" class="url-preview-description"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <label for="storyDescription" class="form-label">
            Post Caption <span class="text-danger">*</span>
          </label>
          <textarea
            class="form-control"
            id="storyDescription"
            rows="3"
            required
          ></textarea>
          <div class="invalid-feedback">Please enter a story description.</div>
        </div>

        

        <div class="mb-4">
          <label for="selectCategory" class="form-label">
            Select a Cause Category your post is related to
          </label>
          <div class="dropdown">
            <input
              type="text"
              class="form-control"
              id="categorySearchInput"
              placeholder="Search Categories..."
              autocomplete="off"
              disabled
            />
            <ul
              class="dropdown-menu w-100"
              id="categoryDropdown"
              style="max-height: 300px; overflow-y: auto"
            >
              <!-- Category options will be dynamically added here -->
            </ul>
          </div>
          <input
            type="hidden"
            id="selectedCategory"
            name="selectedCategory"
          />
          <div class="invalid-feedback">Please select a category (optional).</div>
        </div>

        <div class="mb-4">
          <label for="postAsInput" class="form-label">
            Select which profile to post with
          </label>
          <div class="dropdown">
            <input
              type="text"
              class="form-control"
              id="postAsInput"
              placeholder="Select profile..."
              autocomplete="off"
              readonly
            />
            <ul
              class="dropdown-menu w-100"
              id="postAsDropdown"
              style="max-height: 300px; overflow-y: auto"
            >
              <!-- Post-as options will be dynamically added here -->
            </ul>
          </div>
          <input type="hidden" id="selectedPostAsZuid" name="selectedPostAsZuid" />
        </div>
      </form>
      <button id="nextBtn" class="btn btn-primary w-100 mt-4" disabled>
        <span
          class="spinner-border spinner-border-sm me-2 d-none"
          role="status"
          aria-hidden="true"
        ></span>
        Next
      </button>
    </div>
  </div>
</section>

<script type="module">
  
  // Make npoPageZuid available globally for NPO following checks
  window.npoPageZuid = "{{ $npoZuid }}";

  // TanStack Query observers
  let userProfileQuery;
  let userManagedNposQuery;
  let npoSearchQuery;
  let currentNpoQuery;

  // Initialize queries when user is available
  function initializeQueries() {
    const localUser = localStorage.getItem("user");
    if (!localUser) {
      // console.error("No user found in localStorage for query initialization");
      return;
    }
    
    const userData = JSON.parse(localUser);
    if (!userData.zuid) {
      console.error("No ZUID found in user data for query initialization");
      return;
    }
    // Check if query client is available
    if (!window.queryClient) {
      console.error("TanStack Query client is not available");
      return;
    }
    
    // Check if query functions are available
    if (!window.createUserProfileQuery) {
      console.error("createUserProfileQuery function is not available");
      return;
    }
    
    if (!window.createUserManagedNposQuery) {
      console.error("createUserManagedNposQuery function is not available");
      return;
    }
    
    try {
      userProfileQuery = window.createUserProfileQuery(userData.zuid);
      userManagedNposQuery = window.createUserManagedNposQuery(userData.zuid);
      // Trigger initial fetch to ensure queries start
      setTimeout(() => {
        if (userProfileQuery) {
          userProfileQuery.refetch();
        }
        if (userManagedNposQuery) {
          userManagedNposQuery.refetch();
        }
      }, 100);
    } catch (error) {
      console.error("Error creating TanStack Query observers:", error);
    }
  }

  // Load and pre-select first NPO reactively
  function loadAndPreselectFirstNPO(userProfile) {
    let userNpoIds = [];
    
    if (userProfile?.favorite_npos?.data && Array.isArray(userProfile.favorite_npos.data)) {
      userNpoIds = userProfile.favorite_npos.data.map(npo => npo.meta.zuid);
    } else if (userProfile?.favorite_npos && typeof userProfile.favorite_npos === 'string' && userProfile.favorite_npos !== "") {
      userNpoIds = userProfile.favorite_npos.split(",");
    }

    if (userNpoIds.length === 0) {
      return;
    }

    // Fetch all user's favorite NPOs using TanStack Query with reactive subscriptions
    const loadedNpos = [];
    let hasPreSelected = false; // Flag to prevent multiple pre-selections
    
    userNpoIds.forEach(npoId => {
      const query = window.createNPOProfileQuery(npoId);
      
      // Subscribe to each NPO query reactively
      query.subscribe((result) => {
        if (result.isSuccess && result.data?.data?.[0]) {
          const npo = result.data.data[0];
          
          // Store the NPO data for category loading
          if (!window.npo_data) {
            window.npo_data = [];
          }
          
          // Add the NPO to the global data if not already present
          const existingNpo = window.npo_data.find(n => n.meta.zuid === npo.meta.zuid);
          if (!existingNpo) {
            window.npo_data.push(npo);
          }
          
          // Add to loaded list
          loadedNpos.push(npo);
          
          // Check if all NPOs are loaded and we haven't pre-selected yet
          if (loadedNpos.length === userNpoIds.length && !hasPreSelected) {
            hasPreSelected = true;
            
            // Sort alphabetically and pre-select the first one
            const sortedNpos = loadedNpos.sort((a, b) => a.name.localeCompare(b.name));
            const firstNpo = sortedNpos[0];
            
            preSelectFirstNPO(firstNpo);
          }
        } else if (result.isError) {
          console.error("Failed to load NPO:", npoId, result.error);
        }
      });
      
      // Trigger initial fetch
      query.refetch();
    });
  }

  // Pre-select the first NPO
  function preSelectFirstNPO(npo) {
    
    // Set the NPO in the form
    $("#selectedNPO").val(npo.meta.zuid);
    $("#npoSearchInput").val(npo.name).removeClass("is-invalid").addClass("is-valid");
    
    // Update validation state
    if (window.validationState) {
      window.validationState.selectedNPO = true;
    }
    
    // Enable category input and load categories for this NPO
    $("#categorySearchInput").prop("disabled", false);
    
    // Load categories for the selected NPO and pre-select first cause
    loadCategoriesForNPO(npo, true); // Enable cause pre-selection
    
    // Trigger validation check after pre-selection
    if (typeof checkAllValid === 'function') {
      checkAllValid();
    }
  }

  // Update post-as options reactively
  function updatePostAsOptions(managedNpos) {
    const postAsDropdown = $("#postAsDropdown");
    postAsDropdown.empty();
    
    // Default option: My Profile
    postAsDropdown.append(
      '<li><a class="dropdown-item" href="#" data-zuid="" data-type="user">My Profile</a></li>'
    );

    if (managedNpos.length > 0) {
      // Sort alphabetically
      managedNpos.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      
      postAsDropdown.append('<li><h5 class="dropdown-header text-primary fst-italic">Managed Nonprofits</h5></li>');
      managedNpos.forEach((npo) => {
        const zuid = npo.meta?.zuid || npo.zuid || '';
        const displayName = npo.name || 'Untitled';
        postAsDropdown.append(
          `<li><a class="dropdown-item" href="#" data-zuid="${zuid}" data-type="npo">${displayName}</a></li>`
        );
      });
    }

    // Set default selection to My Profile if nothing chosen yet
    if (!$("#selectedPostAsZuid").val()) {
      $("#selectedPostAsZuid").val("");
      $("#postAsInput").val("My Profile");
      window.story_post_as_npo_zuid = null;
    }
  }

  // Load categories for selected NPO reactively
  function loadCategoriesForNPO(npo, shouldPreselectFirst = false) {
    if (!npo || !npo.category || !npo.category.data) {
      updateCategoryDropdown([]);
      return;
    }

    let categories = npo.category.data;
    
    // Sort categories alphabetically by title
    categories.sort((a, b) => a.title.localeCompare(b.title));
    
    // Pre-select the first cause if requested
    if (shouldPreselectFirst && categories.length > 0) {
      const firstCategory = categories[0];
      
      // Set the category in the form
      $("#selectedCategory").val(firstCategory.meta.zuid);
      $("#categorySearchInput").val(firstCategory.title).removeClass("is-invalid").addClass("is-valid");
    }
    
    updateCategoryDropdown(categories);
  }

  // Update category dropdown with results
  function updateCategoryDropdown(categories, shouldShowDropdown = true) {
    const categoryDropdown = $("#categoryDropdown");
    categoryDropdown.empty();
    
    if (categories.length > 0) {
      // Sort categories alphabetically by title
      categories.sort((a, b) => a.title.localeCompare(b.title));
      window.category_data = categories;
      
      categories.forEach((category) => {
        categoryDropdown.append(
          `<li><a class="dropdown-item" href="#" data-category-id="${category.meta.zuid}">${category.title}</a></li>`
        );
      });
    } else {
      categoryDropdown.append(
        '<li><span class="dropdown-item">No categories available</span></li>'
      );
    }
    
    if (shouldShowDropdown) {
      categoryDropdown.show();
    }
  }

  // Reactive user profile subscription
  function subscribeToUserProfile() {
    if (!userProfileQuery) {
      // console.error("userProfileQuery is not available for subscription");s
      return;
    }
    
    userProfileQuery.subscribe((result) => {
      if (result.isLoading) {
        // Show loading state
      } else if (result.isSuccess) {
        const userProfile = result.data?.data?.[0];
        if (userProfile) {
          // Load and pre-select first NPO
          loadAndPreselectFirstNPO(userProfile);
        } else {
          console.error("No user profile data in successful result");
        }
      } else if (result.isError) {
        console.error("Failed to load user profile:", result.error);
      }
    });
  }

  // Reactive user managed NPOs subscription
  function subscribeToUserManagedNpos() {
    if (!userManagedNposQuery) {
      // console.error("userManagedNposQuery is not available for subscription");
      return;
    }
    
    
    userManagedNposQuery.subscribe((result) => {
      
      if (result.isLoading) {
      } else if (result.isSuccess) {
        const managedNpos = result.data?.data || [];
        updatePostAsOptions(managedNpos);
      } else if (result.isError) {
        console.error("Failed to load user managed NPOs:", result.error);
      }
    });
  }

  function updateNextButtonState(enable) {
    $("#createStoryModal #nextBtn").prop("disabled", enable);
  }

  $(document).ready(async function () {
    
    // Initialize TanStack Query observers
    initializeQueries();
    subscribeToUserProfile();
    subscribeToUserManagedNpos();
    
    let userData = null;
    
    try {
      const localUser = localStorage.getItem("user");
      
      if (!localUser) {
        // console.error("No user found in localStorage");
        return;
      }
      
      const parsedUser = JSON.parse(localUser);
      
      if (!parsedUser.zuid) {
        console.error("No ZUID found in user data");
        return;
      }
      
      // Get user data from TanStack Query
      if (userProfileQuery) {
        const result = userProfileQuery.getCurrentResult();
        if (result.isSuccess && result.data?.data?.[0]) {
          userData = result.data.data[0];
        } else if (result.isLoading) {
          // Query is still loading, wait for it to complete
          // Don't return here, let the subscription handle the data when it arrives
        } else if (result.isError) {
          console.error("User profile query failed:", result.error);
          return;
        } else {
          // Query hasn't been triggered yet, trigger it
          userProfileQuery.refetch();
        }
      }
      
      // Only return if we have an error, not if we're waiting for data
      if (!userData && userProfileQuery) {
        const result = userProfileQuery.getCurrentResult();
        if (result.isError) {
          console.error("No user data available from TanStack Query");
          return;
        }
        // If loading or not started, continue and let subscription handle it
      }
    } catch (error) {
      console.error("Error in document ready function:", error);
      return;
    }

    // Initialize default post-as selection (My Profile)
    window.story_post_as_npo_zuid = null;

    // Move all variable declarations and function definitions inside the try block
    const heroImageInput = $("#heroImageInput");
    const imagePreview = $("#imagePreview");
    const previewImage = $("#previewImage");
    const removeImageBtn = $("#removeImageBtn");
    const uploadMessage = $("#uploadMessage");
    const npoSearchInput = $("#npoSearchInput");
    const npoDropdown = $("#npoDropdown");
    const selectedNPO = $("#selectedNPO");
    const postAsInput = $("#postAsInput");
    const postAsDropdown = $("#postAsDropdown");
    const selectedPostAsZuid = $("#selectedPostAsZuid");
    const categorySearchInput = $("#categorySearchInput");
    const categoryDropdown = $("#categoryDropdown");
    const selectedCategory = $("#selectedCategory");
    const nextBtn = $("#nextBtn");
    const storyDescription = $("#storyDescription");
    const storyUrlInput = $("#storyUrl");
    const storyUrlGroup = $("#storyUrlGroup");
    const storyMediaField = $("#storyMediaField");

    // Add media to validation state
    window.validationState = {
      storyMedia: false,
      storyDescription: false,
      selectedNPO: false,
      storyUrl: true
    };

    window.story_post_type = window.story_post_type || "with-media";

    heroImageInput.on("change", function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImage.attr("src", e.target.result).removeClass("d-none");
          uploadMessage.addClass("d-none");
          removeImageBtn.removeClass("d-none");
          // uploadHeroImage();
          validationState.storyMedia = true;
          checkAllValid();
        };
        reader.readAsDataURL(file);
      } else {
        resetImagePreview();
      }
    });

    function getPostType() {
      return window.story_post_type || "with-media";
    }

    function resetImagePreview() {
      previewImage.attr("src", "").addClass("d-none");
      uploadMessage.removeClass("d-none");
      removeImageBtn.addClass("d-none");
      validationState.storyMedia = false;
      checkAllValid();
    }

    function validateStoryDescription() {
      const value = storyDescription.val().trim();
      if (value === "") {
        storyDescription.addClass("is-invalid");
        validationState.storyDescription = false;
      } else {
        storyDescription.removeClass("is-invalid").addClass("is-valid");
        validationState.storyDescription = true;
      }
      checkAllValid();
    }

    function validateStoryUrl() {
      const postType = getPostType();
      const value = storyUrlInput.val().trim();
      const normalizedValue = value && !/^https?:\/\//i.test(value) ? `https://${value}` : value;
      let isValid = false;

      if (!normalizedValue) {
        storyUrlInput.removeClass("is-valid is-invalid");
        validationState.storyUrl = false;
        checkAllValid();
        return;
      }

      try {
        const parsed = new URL(normalizedValue);
        isValid = Boolean(parsed.hostname);
      } catch (e) {
        isValid = false;
      }

      if (isValid) {
        storyUrlInput.removeClass("is-invalid").addClass("is-valid");
        validationState.storyUrl = true;
        window.story_url = normalizedValue;
      } else {
        storyUrlInput.addClass("is-invalid");
        validationState.storyUrl = false;
      }

      checkAllValid();
    }

    function validateSelectedNPO() {
      const value = selectedNPO.val().trim();
      if (value === "") {
        npoSearchInput.addClass("is-invalid");
        validationState.selectedNPO = false;
      } else {
        npoSearchInput.removeClass("is-invalid").addClass("is-valid");
        validationState.selectedNPO = true;
      }
      checkAllValid();
    }

    function validateSelectedCategory() {
      const value = selectedCategory.val().trim();
      if (value === "") {
        categorySearchInput.removeClass("is-valid is-invalid");
      } else {
        categorySearchInput.removeClass("is-invalid").addClass("is-valid");
      }
      // Category is optional, so no need to call checkAllValid()
    }

    function checkAllValid() {
      const postType = getPostType();
      const requiredFields = [
        validationState.selectedNPO,
        validationState.storyDescription,
      ];

      if (postType === "with-media") {
        requiredFields.push(validationState.storyMedia);
      }

      if (postType === "shared-link") {
        requiredFields.push(validationState.storyUrl);
      }

      const allValid = requiredFields.every(Boolean);
      updateNextButtonState(!allValid);
    }

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }


    // Reactive NPO search function
    function searchNPOs(searchTerm) {
      if (!searchTerm || searchTerm.length === 0) {
        // Show user's favorite NPOs
        showUserFavoriteNPOs();
        return;
      }
      
      // Use existing search query
      npoSearchQuery = window.createSearchNposQuery(searchTerm);
      
      npoSearchQuery.subscribe((result) => {
        if (result.isLoading) {
          showNpoSearchLoading();
        } else if (result.isSuccess) {
          const searchResults = result.data?.data || [];
          updateNpoDropdown(searchResults, searchTerm);
        } else if (result.isError) {
          showNpoSearchError();
        }
      });
    }

    // Show user's favorite NPOs reactively
    function showUserFavoriteNPOs() {
      if (!userProfileQuery) return;
      
      const result = userProfileQuery.getCurrentResult();
      if (!result.isSuccess) return;
      
      const user = result.data?.data?.[0];
      if (!user) return;
      
      let userNpoIds = [];
      
      // Get user's favorite NPO IDs
      if (user.favorite_npos?.data && Array.isArray(user.favorite_npos.data)) {
        userNpoIds = user.favorite_npos.data.map(npo => npo.meta.zuid);
      } else if (user.favorite_npos && typeof user.favorite_npos === 'string' && user.favorite_npos !== "") {
        userNpoIds = user.favorite_npos.split(",");
      }
      
      if (userNpoIds.length > 0) {
        // Fetch user's favorite NPOs using TanStack Query with reactive subscriptions
        const loadedNpos = [];
        
        userNpoIds.forEach(npoId => {
          const query = window.createNPOProfileQuery(npoId);
          
          query.subscribe((result) => {
            if (result.isSuccess && result.data?.data?.[0]) {
              const npo = result.data.data[0];
              loadedNpos.push(npo);
              
              // Check if all NPOs are loaded
              if (loadedNpos.length === userNpoIds.length) {
                // Sort and update dropdown
                const sortedNpos = loadedNpos.sort((a, b) => a.name.localeCompare(b.name));
                updateNpoDropdown(sortedNpos, "", true); // true = show as favorites
              }
            } else if (result.isError) {
              console.error("Failed to load favorite NPO:", npoId, result.error);
            }
          });
          
          // Trigger initial fetch
          query.refetch();
        });
      } else {
        // No favorites, show general NPOs
        showGeneralNPOs();
      }
    }

    // Show general NPOs (fallback when user has no favorites)
    function showGeneralNPOs() {
      npoDropdown.empty();
      npoDropdown.append(
        '<li><span class="dropdown-item">No NPOs found</span></li>'
      );
      npoDropdown.show();
    }

    // Show loading state for NPO search
    function showNpoSearchLoading() {
      npoDropdown.empty().append('<li><span class="dropdown-item text-center"><div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>Loading...</span></li>');
      npoDropdown.show();
    }

    // Show error state for NPO search
    function showNpoSearchError() {
      npoDropdown.empty().append('<li><span class="dropdown-item">Error fetching NPOs</span></li>');
      npoDropdown.show();
    }

    // Update NPO dropdown with results
    function updateNpoDropdown(npos, searchTerm, isFavorites = false) {
      npoDropdown.empty();

      // Store NPOs in global data for category lookups
      if (!window.npo_data) {
        window.npo_data = [];
      }
      
      // Add NPOs to global data, avoiding duplicates
      npos.forEach(npo => {
        const existingNpo = window.npo_data.find(n => n.meta.zuid === npo.meta.zuid);
        if (!existingNpo) {
          window.npo_data.push(npo);
        }
      });

      if (isFavorites) {
        // Display user's favorite NPOs
        npoDropdown.append(
          '<li><h5 class="dropdown-header text-primary fst-italic">Your Nonprofits</h5></li>'
        );
        npos.forEach((npo) => {
          npoDropdown.append(
            `<li><a class="dropdown-item" href="#" data-npo-id="${npo.meta.zuid}">${npo.name}</a></li>`
          );
        });
      } else if (searchTerm) {
        // Display search results
        if (npos.length > 0) {
          npos.forEach((npo) => {
            npoDropdown.append(
              `<li><a class="dropdown-item" href="#" data-npo-id="${npo.meta.zuid}">${npo.name}</a></li>`
            );
          });
        } else {
          npoDropdown.append(
            `<li><span class="dropdown-item">No NPOs found for "${searchTerm}"</span></li>`
          );
        }
      } else {
        // General NPOs
        if (npos.length > 0) {
          npoDropdown.append(
            '<li><h5 class="dropdown-header text-primary fst-italic">Available Nonprofits</h5></li>'
          );
          npos.forEach((npo) => {
            npoDropdown.append(
              `<li><a class="dropdown-item" href="#" data-npo-id="${npo.meta.zuid}">${npo.name}</a></li>`
            );
          });
        } else {
          npoDropdown.append(
            '<li><span class="dropdown-item">No NPOs found</span></li>'
          );
        }
      }
      
      npoDropdown.show();
    }


    function searchCategories(searchTerm = "", npo, shouldShowDropdown = true, shouldPreselectFirst = false) {
      if (!npo || !npo.category || !npo.category.data) {
        updateCategoryDropdown([]);
        return;
      }

      let categories = npo.category.data;

      if (searchTerm) {
        const searchTermLower = searchTerm.toLowerCase();
        categories = categories.filter((category) =>
          category.title.toLowerCase().includes(searchTermLower)
        );
      }

      // Pre-select the first cause if requested and no search term is applied
      if (shouldPreselectFirst && !searchTerm && categories.length > 0) {
        const firstCategory = categories[0];
        
        // Set the category in the form
        $("#selectedCategory").val(firstCategory.meta.zuid);
        $("#categorySearchInput").val(firstCategory.title).removeClass("is-invalid").addClass("is-valid");
      }
      
      updateCategoryDropdown(categories, shouldShowDropdown);
    }

    // Function to prefill NPO based on provided ZUID using TanStack Query
    function prefillNPOFromZuid(zuid) {
      try {
        // Show loading state in NPO input
        $("#npoSearchInput").val("Loading...").prop("disabled", true);
        
        // Use TanStack Query to fetch the specific NPO by ZUID
        currentNpoQuery = window.createNPOProfileQuery(zuid);
        
        currentNpoQuery.subscribe((result) => {
          if (result.isLoading) {
            // Keep loading state
          } else if (result.isSuccess) {
            const npo = result.data?.data?.[0];
            
            if (npo) {
              
              // Set the NPO in the form
              $("#selectedNPO").val(npo.meta.zuid);
              $("#npoSearchInput").val(npo.name).prop("disabled", false).removeClass("is-invalid").addClass("is-valid");
              
              // Store the NPO data for category loading
              if (!window.npo_data) {
                window.npo_data = [];
              }
              
              // Add the NPO to the global data if not already present
              const existingNpo = window.npo_data.find(n => n.meta.zuid === npo.meta.zuid);
              if (!existingNpo) {
                window.npo_data.push(npo);
              }
              
              // Update validation state
              if (window.validationState) {
                window.validationState.selectedNPO = true;
              }
              
              // Enable category input and load categories for this NPO
              $("#categorySearchInput").prop("disabled", false);
              
              // Load categories for the selected NPO and pre-select first cause
              loadCategoriesForNPO(npo, true); // Enable cause pre-selection
              
              // Trigger validation check after prefill
              if (typeof checkAllValid === 'function') {
                checkAllValid();
              }
            } else {
              console.warn("No NPO found with ZUID:", zuid);
              $("#npoSearchInput").val("").prop("disabled", false);
            }
          } else if (result.isError) {
            console.error("Error prefilling NPO:", result.error);
            $("#npoSearchInput").val("").prop("disabled", false);
          }
        });
        
        // Trigger initial fetch
        currentNpoQuery.refetch();
        
      } catch (error) {
        console.error("Error prefilling NPO:", error);
        $("#npoSearchInput").val("").prop("disabled", false);
      }
    }


    const debouncedSearchNPO = debounce(function () {
      const searchTerm = npoSearchInput.val().trim();
      searchNPOs(searchTerm);
    }, 300);

    const debouncedSearchCategory = debounce(function () {
      const searchTerm = categorySearchInput.val().trim();
      const selectedNPOId = selectedNPO.val();
      const selectedNPOData = window.npo_data?.find(npo => npo.meta.zuid === selectedNPOId);
      searchCategories(searchTerm, selectedNPOData);
    }, 300);

    removeImageBtn.on("click", function () {
      heroImageInput.val("");
      resetImagePreview();
    });

    npoSearchInput.on("input", debouncedSearchNPO);
    categorySearchInput.on("input", debouncedSearchCategory);

    // Post-as interactions
    postAsInput.on("focus", function () {
      if (postAsDropdown.children().length === 0) {
        postAsDropdown.empty().append('<li><span class="dropdown-item text-center"><div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>Loading...</span></li>');
        postAsDropdown.show();
        loadPostAsOptions();
      } else {
        postAsDropdown.show();
      }
    });

    postAsDropdown.on("click", "a.dropdown-item", function (e) {
      e.preventDefault();
      const zuid = $(this).data("zuid") || "";
      const type = $(this).data("type");
      const name = $(this).text();
      selectedPostAsZuid.val(zuid);
      postAsInput.val(name);
      postAsDropdown.hide();
      // Set global for story creation: null for My Profile, ZUID when NPO selected
      window.story_post_as_npo_zuid = zuid ? String(zuid) : null;
    });

    // URL Preview functionality
    let urlPreviewTimeout;
    
    function showUrlPreviewLoading() {
      $("#urlPreviewContainer").removeClass("d-none");
      $("#urlPreviewLoading").removeClass("d-none");
      $("#urlPreviewCard").addClass("d-none");
      $("#urlPreviewNoPreview").addClass("d-none");
    }
    
    function hideUrlPreview() {
      $("#urlPreviewContainer").addClass("d-none");
      $("#urlPreviewLoading").addClass("d-none");
      $("#urlPreviewCard").addClass("d-none");
      $("#urlPreviewNoPreview").addClass("d-none");
    }
    
    function showUrlPreviewCard(data) {
      $("#urlPreviewContainer").removeClass("d-none");
      $("#urlPreviewLoading").addClass("d-none");
      $("#urlPreviewCard").removeClass("d-none");
      $("#urlPreviewNoPreview").addClass("d-none");
      
      // Set image
      if (data.image) {
        $("#urlPreviewImage").attr("src", data.image).show();
      } else {
        $("#urlPreviewImage").hide();
      }
      
      // Set URL
      $("#urlPreviewUrl").attr("href", data.url).text(data.url);

      // Set description (meta description shown beneath the link)
      if (data.description) {
        $("#urlPreviewDescription").text(data.description).show();
      } else {
        $("#urlPreviewDescription").hide();
      }
    }
    
    function showUrlPreviewNoPreview(url) {
      $("#urlPreviewContainer").removeClass("d-none");
      $("#urlPreviewLoading").addClass("d-none");
      $("#urlPreviewCard").addClass("d-none");
      $("#urlPreviewNoPreview").removeClass("d-none");
      
      $("#urlPreviewUrlFallback").attr("href", url).text(url);
      $("#urlPreviewDescriptionFallback").text("No preview available");
    }
    
    async function fetchUrlPreview(url) {
      // List of CORS proxy services to try in order
      const corsProxies = [
        `https://corsproxy.io/?${encodeURIComponent(url)}`,
        `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
        `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
      ];
      
      // Try each proxy with a timeout
      for (const proxyUrl of corsProxies) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
          
          const response = await fetch(proxyUrl, { 
            signal: controller.signal,
            headers: {
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
            }
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            console.warn(`Proxy failed with status ${response.status}, trying next...`);
            continue;
          }
          
          const html = await response.text();
          
          // Create a temporary DOM to parse the HTML
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          
          // Extract Open Graph tags
          const ogTitle = doc.querySelector('meta[property="og:title"]')?.content;
          const ogDescription = doc.querySelector('meta[property="og:description"]')?.content;
          const ogImage = doc.querySelector('meta[property="og:image"]')?.content;
          
          // Fallback to standard meta tags
          const title = ogTitle || doc.querySelector('title')?.textContent || '';
          const description = ogDescription || doc.querySelector('meta[name="description"]')?.content || '';
          const image = ogImage || '';
          
          if (title || description || image) {
            showUrlPreviewCard({
              url: url,
              title: title,
              description: description,
              image: image
            });
            return; // Success, exit function
          } else {
            showUrlPreviewNoPreview(url);
            return;
          }
        } catch (error) {
          if (error.name === 'AbortError') {
            console.warn(`Proxy timed out, trying next...`);
          } else {
            console.warn(`Proxy error: ${error.message}, trying next...`);
          }
          // Continue to next proxy
        }
      }
      
      // All proxies failed
      console.error("All CORS proxies failed to fetch URL preview");
      showUrlPreviewNoPreview(url);
    }
    
    function handleUrlPreview() {
      clearTimeout(urlPreviewTimeout);
      
      const rawUrl = storyUrlInput.val().trim();
      if (!rawUrl) {
        hideUrlPreview();
        return;
      }
      
      const normalizedUrl = rawUrl && !/^https?:\/\//i.test(rawUrl) ? `https://${rawUrl}` : rawUrl;
      
      // Validate URL format
      try {
        new URL(normalizedUrl);
      } catch (e) {
        hideUrlPreview();
        return;
      }
      
      // Debounce the preview fetch
      urlPreviewTimeout = setTimeout(() => {
        showUrlPreviewLoading();
        fetchUrlPreview(normalizedUrl);
      }, 800);
    }

    // Validation Events
    storyDescription.on("input focus", validateStoryDescription);
    npoSearchInput.on("input focus", validateSelectedNPO);
    categorySearchInput.on("input focus", validateSelectedCategory);
    storyUrlInput.on("input blur", validateStoryUrl);
    storyUrlInput.on("input", handleUrlPreview);

    // Modify the focus event handlers to show loading state
    npoSearchInput.on("focus", function () {
      if (npoDropdown.children().length === 0) {
        // Show loading indicator before starting the search
        npoDropdown.empty().append('<li><span class="dropdown-item text-center"><div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>Loading...</span></li>');
        npoDropdown.show();
        searchNPOs("");
      } else {
        npoDropdown.show();
      }
    });

    categorySearchInput.on("focus", function () {
      if (categoryDropdown.children().length === 0) {
        const selectedNPOId = selectedNPO.val();
        if (!selectedNPOId) {
          categoryDropdown.empty();
          categoryDropdown.append(
            '<li><span class="dropdown-item">Please select an NPO first</span></li>'
          );
          categoryDropdown.show();
          return;
        }
        
        const selectedNPOData = window.npo_data?.find(npo => npo.meta.zuid === selectedNPOId);
        searchCategories("", selectedNPOData, true);
      } else {
        categoryDropdown.show();
      }
    });

    npoDropdown.on("click", "a.dropdown-item", function (e) {
      e.preventDefault();
      const npoId = $(this).data("npo-id");
      const npoName = $(this).text();
      selectedNPO.val(npoId);
      npoSearchInput.val(npoName);
      npoDropdown.hide();
      validateSelectedNPO();

      // Deselect any selected category and clear validation
      selectedCategory.val("");
      categorySearchInput.val("").removeClass("is-valid is-invalid");
      
      // Enable category input and refresh categories
      categorySearchInput.prop("disabled", false);
      const selectedNPOData = window.npo_data?.find(npo => npo.meta.zuid === npoId);
      loadCategoriesForNPO(selectedNPOData, true); // Enable cause pre-selection
    });

    categoryDropdown.on("click", "a.dropdown-item", function (e) {
      e.preventDefault();
      const categoryId = $(this).data("category-id");
      const categoryName = $(this).text();
      selectedCategory.val(categoryId);
      categorySearchInput.val(categoryName);
      categoryDropdown.hide();
      validateSelectedCategory();
    });

    // Fix dropdown behavior to prevent random showing
    // Add explicit blur handlers to hide dropdowns when input loses focus, unless clicking on the dropdown itself
    npoSearchInput.on("blur", function(e) {
      // Use setTimeout to allow click events on dropdown items to register first
      setTimeout(function() {
        // Only hide if the related target is not part of the dropdown
        if (!$(document.activeElement).closest('#npoDropdown').length) {
          npoDropdown.hide();
        }
      }, 150);
    });

    categorySearchInput.on("blur", function(e) {
      // Use setTimeout to allow click events on dropdown items to register first
      setTimeout(function() {
        // Only hide if the related target is not part of the dropdown
        if (!$(document.activeElement).closest('#categoryDropdown').length) {
          categoryDropdown.hide();
        }
      }, 150);
    });

    // Improve the document click handler to be more specific
    $(document).on("click", function (e) {
      // For NPO dropdown
      if (!$(e.target).closest(".dropdown").length && 
          !$(e.target).is("#npoSearchInput") && 
          npoDropdown.is(":visible")) {
        npoDropdown.hide();
      }
      
      // For Category dropdown
      if (!$(e.target).closest(".dropdown").length && 
          !$(e.target).is("#categorySearchInput") && 
          categoryDropdown.is(":visible")) {
        categoryDropdown.hide();
      }
      // For Post-as dropdown
      if (!$(e.target).closest('.dropdown').length &&
          !$(e.target).is('#postAsInput') &&
          postAsDropdown.is(':visible')) {
        postAsDropdown.hide();
      }
    });

    // Fix potential race conditions in dropdown visibility
    // When window is clicked elsewhere, ensure dropdowns are hidden
    $(window).on("click", function(e) {
      if (!$(e.target).closest('#npoSearchInput, #npoDropdown').length) {
        npoDropdown.hide();
      }
      
      if (!$(e.target).closest('#categorySearchInput, #categoryDropdown').length) {
        categoryDropdown.hide();
      }
      if (!$(e.target).closest('#postAsInput, #postAsDropdown').length) {
        postAsDropdown.hide();
      }
    });

    // Ensure dropdowns are hidden when modal is closed or when switching steps
    $("#createStoryModal").on("hidden.bs.modal", function() {
      npoDropdown.hide();
      categoryDropdown.hide();
      postAsDropdown.hide();
    });

    $("#nextBtn, #backBtn").on("click", function() {
      npoDropdown.hide();
      categoryDropdown.hide();
    });

    // Check if npoPageZuid is provided and prefill NPO
    if (window.npoPageZuid && window.npoPageZuid.trim() !== "") {
      if (typeof prefillNPOFromZuid !== 'function') {
        console.error("prefillNPOFromZuid function is not available");
        return;
      }
      
      try {
        prefillNPOFromZuid(window.npoPageZuid.trim());
        // Trigger validation check after prefill
        if (typeof checkAllValid === 'function') {
          checkAllValid();
        }
      } catch (error) {
        console.error("Error in NPO prefill:", error);
      }
    } else {
      // No npoPageZuid provided, load user's NPOs and pre-select the first one alphabetically
      loadAndPreselectFirstNPO();
    }

    // Post-as options are loaded reactively via subscribeToUserManagedNpos
    // NPO and Category loading is handled reactively via TanStack Query subscriptions

    // Initial validation check
    if (typeof updateNextButtonState === 'function') {
      updateNextButtonState(true);
    } else {
      console.warn("updateNextButtonState function is not available");
    }

    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");
    const browseButton = document.getElementById("browseButton");
    const previewContainer = document.getElementById("previewContainer");
    let uploadedFiles = [];
    let draggedItemIndex = null;

    function applyStoryTypeUI() {
      const postType = getPostType();
      const isTextOnly = postType === "text-only";
      const isSharedLink = postType === "shared-link";

      const hideMedia = isTextOnly || isSharedLink;
      storyMediaField.toggleClass("d-none", hideMedia);

      if (hideMedia) {
        uploadedFiles = [];
        window.hero_image = [];
        if (previewContainer) {
          previewContainer.innerHTML = "";
        }
        validationState.storyMedia = true; // not required in these modes
      } else {
        // In with-media mode, always keep upload area visible
        if (uploadArea) {
          uploadArea.style.display = "flex";
        }
        validationState.storyMedia = uploadedFiles.length > 0;
        updateUploadAreaText();
      }

      storyUrlGroup.toggleClass("d-none", !isSharedLink);
      if (!isSharedLink) {
        storyUrlInput.val("").removeClass("is-valid is-invalid");
        validationState.storyUrl = true;
        window.story_url = "";
        hideUrlPreview();
      } else {
        storyUrlInput.removeClass("is-valid is-invalid");
        validationState.storyUrl = false;
        window.story_url = "";
        // Trigger preview if URL already exists
        if (storyUrlInput.val().trim()) {
          handleUrlPreview();
        }
      }

      checkAllValid();
    }

    window.setStoryPostType = function(type) {
      window.story_post_type = type || "with-media";
      applyStoryTypeUI();
    };

    applyStoryTypeUI();

    function handleDragStart(event, index) {
      draggedItemIndex = index;
      event.dataTransfer.effectAllowed = 'move';
      setTimeout(() => {
        event.target.classList.add('dragging');
      }, 0);
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
    }

    function handleDrop(event, targetIndex) {
      event.preventDefault();
      if (draggedItemIndex === null || draggedItemIndex === targetIndex) {
        if (draggedItemIndex !== null) {
            const draggedElement = previewContainer.children[draggedItemIndex + (uploadedFiles.length > 0 && uploadedFiles.length < 5 ? 1 : 0)]; // Adjust index if "add more" is present
            if (draggedElement) draggedElement.classList.remove('dragging');
        }
        draggedItemIndex = null;
        return;
      }

      const itemToMove = uploadedFiles.splice(draggedItemIndex, 1)[0];
      uploadedFiles.splice(targetIndex, 0, itemToMove);

      window.hero_image = [...uploadedFiles];
      
      draggedItemIndex = null;
      updatePreviews();
    }

    function handleDragEnd(event) {
      event.target.classList.remove('dragging');
      if (draggedItemIndex !== null) {
          draggedItemIndex = null;
      }
    }

    uploadArea.addEventListener("click", () => {
      if (uploadedFiles.length < 20) {
        fileInput.click();
      }
    });

    browseButton.addEventListener("click", (e) => {
      e.stopPropagation();
      if (uploadedFiles.length < 20) {
        fileInput.click();
      }
    });

    uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      if (uploadedFiles.length < 20) {
        uploadArea.style.backgroundColor = "#f8f9fa";
        uploadArea.style.borderColor = "#adb5bd";
      }
    });

    uploadArea.addEventListener("dragleave", () => {
      uploadArea.style.backgroundColor = "#ffffff";
      uploadArea.style.borderColor = "#dee2e6";
    });

    uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.style.backgroundColor = "#ffffff";
      uploadArea.style.borderColor = "#dee2e6";
      if (uploadedFiles.length < 20) {
        handleFiles(e.dataTransfer.files);
      }
    });

    fileInput.addEventListener("change", () => {
      handleFiles(fileInput.files);
    });

    function handleFiles(files) {
      if (getPostType() !== "with-media") {
        return;
      }
      // Convert FileList to Array and filter for images and videos
      const newFiles = Array.from(files).filter(file => 
        file.type.startsWith("image/") || 
        file.type === "video/mp4" || 
        file.type === "video/x-flv" || 
        file.type === "video/quicktime"
      );
      
      // Check if adding these files would exceed the 20-media limit
      if (uploadedFiles.length + newFiles.length > 20) {
        // If we exceed the limit, only take what we can fit
        const availableSlots = 20 - uploadedFiles.length;
        if (availableSlots > 0) {
          // Add only the number of files that fit within the limit
          const filesToAdd = newFiles.slice(0, availableSlots);
          uploadedFiles = [...uploadedFiles, ...filesToAdd];
          window.hero_image = uploadedFiles;
          alert(`You can only upload up to 20 media files. Added ${filesToAdd.length} of ${newFiles.length} selected files.`);
        } else {
          alert("Maximum of 20 media files allowed. Please remove some files before adding more.");
        }
      } else if (newFiles.length > 0) {
        // If we're within the limit, add all the new files
        uploadedFiles = [...uploadedFiles, ...newFiles];
        window.hero_image = uploadedFiles;
      }
      
      updatePreviews();
      fileInput.value = null;
    }

    function updatePreviews() {
      previewContainer.innerHTML = "";

      // Create preview elements for each uploaded file
      uploadedFiles.forEach((file, index) => {
        const previewItem = document.createElement("div");
        previewItem.classList.add("preview-item");
        previewItem.draggable = true; // Make the item draggable

        // Attach drag and drop event listeners
        previewItem.addEventListener('dragstart', (event) => handleDragStart(event, index));
        previewItem.addEventListener('dragover', handleDragOver);
        previewItem.addEventListener('drop', (event) => handleDrop(event, index));
        previewItem.addEventListener('dragend', handleDragEnd);

        let mediaElement;
        
        if (file.type === "video/mp4" || file.type === "video/x-flv" || file.type === "video/quicktime") {
          // Create video element for MP4 files
          mediaElement = document.createElement("video");
          mediaElement.classList.add("preview-image"); // Reuse the same CSS class for consistency
          mediaElement.controls = false; // Disable controls in preview
          mediaElement.muted = true;
          mediaElement.preload = "metadata";
          
          // Add video-preview class to the preview item for the play icon overlay
          previewItem.classList.add("video-preview");
          
          const reader = new FileReader();
          reader.onload = (e) => {
            mediaElement.src = e.target.result;
          };
          reader.readAsDataURL(file);
        } else {
          // Create image element for image files
          mediaElement = document.createElement("img");
          mediaElement.classList.add("preview-image");
          
          const reader = new FileReader();
          reader.onload = (e) => {
            mediaElement.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }

        const removeBtn = document.createElement("button");
        removeBtn.classList.add("remove-btn");
        removeBtn.innerHTML = "&times;";
        removeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          removeFile(index);
        });

        // Add success badge (green checkmark)
        const successBadge = document.createElement("div");
        successBadge.classList.add("upload-success-badge");
        successBadge.innerHTML = '<i class="bi bi-check"></i>';

        previewItem.appendChild(mediaElement);
        previewItem.appendChild(removeBtn);
        previewItem.appendChild(successBadge);

        previewContainer.appendChild(previewItem);
      });

      // Update button text based on whether files are uploaded
      updateUploadAreaText();
      validationState.storyMedia = uploadedFiles.length > 0;
      checkAllValid();
    }

    function removeFile(index) {
      // Remove the file at the specified index
      uploadedFiles.splice(index, 1);
      window.hero_image = uploadedFiles;
      updatePreviews();
    }

    function updateUploadAreaText() {
      // Update upload area text to show remaining slots
      const remainingSlots = 20 - uploadedFiles.length;
      if (uploadedFiles.length === 0) {
        browseButton.textContent = "Browse Files";
        browseButton.disabled = false;
        uploadArea.classList.remove("disabled");
      } else if (uploadedFiles.length >= 20) {
        browseButton.textContent = "Maximum Reached";
        browseButton.disabled = true;
        uploadArea.classList.add("disabled");
      } else {
        browseButton.textContent = "Add More Files";
        browseButton.disabled = false;
        uploadArea.classList.remove("disabled");
      }
    }

    window.resetAllStates = function () {
      // Reset validation state
      validationState = {
        storyMedia: false,
        storyDescription: false,
        selectedNPO: false,
        storyUrl: getPostType() === "shared-link" ? false : true
      };

      // Reset uploaded files
      uploadedFiles = [];
      window.hero_image = [];
      updatePreviews();

      // Reset form fields
      $("#storyDetailsForm")[0].reset();
      storyUrlInput.val("").removeClass("is-valid is-invalid");
      window.story_url = "";
      hideUrlPreview();

      // Remove validation classes
      $("#storyDetailsForm .form-control").removeClass("is-valid is-invalid");
      $("#npoSearchInput").removeClass("is-valid is-invalid");
      $("#categorySearchInput").removeClass("is-valid is-invalid");

      // Reset dropdown selections
      $("#selectedNPO").val("");
      $("#selectedCategory").val("");
      $("#npoSearchInput").val("").removeClass("is-valid is-invalid");
      $("#categorySearchInput").val("").removeClass("is-valid is-invalid").prop("disabled", true);
      // Reset Post-as
      $("#selectedPostAsZuid").val("");
      $("#postAsInput").val("My Profile");
      window.story_post_as_npo_zuid = null;

      // Hide dropdown menus
      $("#npoDropdown").hide();
      $("#categoryDropdown").hide();

      // Show upload area and clear preview container
      uploadArea.style.display = "flex";
      previewContainer.innerHTML = "";
      
      // Reset upload area button text
      updateUploadAreaText();

      // Optionally, reset any global variables or additional states
      window.npo_data = [];
      window.category_data = [];

      applyStoryTypeUI();

      // Reset Next button state
      if (typeof updateNextButtonState === 'function') {
        updateNextButtonState(true);
      } else {
        console.warn("updateNextButtonState function is not available");
      }

      // Re-prefill NPO if npoPageZuid is provided, otherwise pre-select first NPO alphabetically
      if (window.npoPageZuid && window.npoPageZuid.trim() !== "") {
        prefillNPOFromZuid(window.npoPageZuid.trim());
      } else {
        // No npoPageZuid provided, get user data from TanStack Query and pre-select first NPO
        if (userProfileQuery) {
          const result = userProfileQuery.getCurrentResult();
          if (result.isSuccess && result.data?.data?.[0]) {
            loadAndPreselectFirstNPO(result.data.data[0]);
          }
        }
      }
    };
  });
</script>
