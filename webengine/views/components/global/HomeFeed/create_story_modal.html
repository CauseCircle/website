<style>
  .section-title p,
  .section-title {
    font-size: 2rem;
    font-weight: 500;
    text-align: center;
  }
  .hero-description p,
  .hero-description {
    font-size: 1.125rem;
    font-weight: 400;
    text-align: center;
    color: var(--bs-gray-500);
    max-width: 53.125rem;
  }
  .role-card,
  .cause-card,
  .npo-card {
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    cursor: pointer;
  }
  .role-card:hover,
  .cause-card:hover,
  .npo-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }
  .role-card.selected,
  .cause-card.selected,
  .npo-card.selected {
    border: 2px solid #7b3fee;
    background-color: #f8f4ff;
  }
  .search-input {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>');
    background-repeat: no-repeat;
    background-position: 10px center;
    padding-left: 35px;
  }
  #stepsIndicator {
    font-size: 0.875rem;
  }
  .step-item {
    display: flex;
    align-items: center;
    color: var(--bs-gray-600);
  }
  .step-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: var(--bs-gray-300);
    color: var(--bs-white);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
  }
  .step-separator {
    width: 16px;
    height: 2px;
    background-color: var(--bs-gray-300);
    margin: 0 8px;
  }
  .step-item.active {
    color: var(--bs-primary);
  }
  .step-item.active .step-icon {
    background-color: var(--bs-primary);
  }
  .step-item.completed .step-icon {
    background-color: var(--bs-success);
  }
  .modal-fullscreen .modal-header {
    padding: 1rem 2rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
  }
  .modal-fullscreen .modal-body {
    padding: 2rem;
  }
  .close-button {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1;
    color: #000;
    opacity: 0.5;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
  }
  .close-button:hover {
    opacity: 0.75;
  }
</style>

<!-- Follow Any NPO First Modal (when user has no followed NPOs) -->
<div class="modal fade" id="followAnyNpoModal" tabindex="-1" aria-labelledby="followAnyNpoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-4">
          <i class="bi bi-heart text-primary" style="font-size: 3rem;"></i>
        </div>
        <h5 class="modal-title mb-3" id="followAnyNpoModalLabel">Follow a Nonprofit First</h5>
        <p class="text-muted mb-4">
          To create posts, you need to follow at least one nonprofit. Find nonprofits that align with your values and start following them!
        </p>
        <div class="pb-4">
          <button type="button" class="btn btn-primary" id="exploreNposBtn">
            Explore Nonprofits
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Follow This NPO Modal (when user is on NPO page but not following this NPO) -->
<div class="modal fade" id="followThisNpoModal" tabindex="-1" aria-labelledby="followThisNpoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-4">
          <i class="bi bi-person-heart text-primary" style="font-size: 3rem;"></i>
        </div>
        <h5 class="modal-title mb-3" id="followThisNpoModalLabel">Follow This Nonprofit First</h5>
        <p class="text-muted mb-4">
          To post about this nonprofit, you need to follow them first! Click the follow button on this page to get started.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div
  class="modal fade"
  id="createStoryModal"
  tabindex="-1"
  aria-labelledby="createStoryModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content" style="padding: 0px;">
      <div class="modal-header w-100">
        <div class="row w-100 mx-0">
          <div
            class="col-2 d-flex justify-content-start align-items-center d-none d-md-flex"
          >
            <img
              src="{{ globals.logo.getImage() }}"
              style="max-width: 160px"
              alt="cause circle brand logo"
            />
          </div>
          <div
            class="col-10 col-md-8 d-flex justify-content-center align-items-center"
          >
            <!-- Steps indicator -->
            <div
              id="stepsIndicator"
              class="d-flex align-items-center justify-content-center"
            >
              <!-- <div class="step-item" data-step="1">
                <span class="step-icon">1</span>
                <span class="step-text">Hero Image</span>
              </div> -->
              <!-- <div class="step-separator"></div> -->
              <div class="step-item" data-step="1">
                <span class="step-icon">1</span>
                <span class="step-text">Story Information</span>
              </div>
              <!-- <div class="step-separator"></div> -->
              <!-- <div class="step-item" data-step="2">
                <span class="step-icon">2</span>
                <span class="step-text">Add Content</span>
              </div> -->
              <div class="step-separator"></div>
              <div class="step-item" data-step="2">
                <span class="step-icon">2</span>
                <span class="step-text">Share</span>
              </div>
            </div>
          </div>
          <div class="col-2 d-flex justify-content-end align-items-center">
            <button
              type="button"
              class="close-button"
              data-bs-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        </div>
      </div>
      <div class="modal-body p-3 p-md-4">
        <div class="container-fluid">
          <div>
            <button id="backBtn" class="btn btn-secondary">
              <i class="bi bi-arrow-left"></i>
              Back
            </button>
          </div>
          <!-- Content sections -->
          <div class="row">
            <div class="col-12">
              <!-- prettier-ignore -->
              (** {{ include /components/global/HomeFeed/Create Story Steps/upload_hero.html }} **)
              <!-- prettier-ignore -->
              {{ include /components/global/HomeFeed/Create Story Steps/story_information.html }}
              <!-- prettier-ignore -->
              (** {{ include /components/global/HomeFeed/Create Story Steps/add_content.html }} **)
              <!-- prettier-ignore -->
              {{ include /components/global/HomeFeed/Create Story Steps/share_story.html }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  const selectionHeaderTextsForCreateStoryModal = [
    {
      title: "Create Post",
      description: "Share a photo or video and write a caption",
      icon: "https://4xxglxlj.media.zestyio.com/upload_icon.png",
    },
    {
      title: "Your Story is Published!",
      description: "Almost done! Choose how you want to share your story.",
      icon: "https://4xxglxlj.media.zestyio.com/finish_icon.png",
    },
  ];

  //states
  window.npo_data;
  window.category_data;
  window.hero_image = [];
  window.story_title;
  window.story_description;
  window.story_content;
  window.story_location;
  window.story_npo;
  window.story_category;
  window.story_data;

  // TanStack Query observers
  let userProfileQuery;

  // Initialize queries when user is available
  function initializeQueries() {
    const localUser = localStorage.getItem("user");
    if (!localUser) return;
    
    const userData = JSON.parse(localUser);
    userProfileQuery = window.createUserProfileQuery(userData.zuid);
  }

  // Reactive user profile subscription
  function subscribeToUserProfile() {
    if (!userProfileQuery) return;
    
    userProfileQuery.subscribe((result) => {
      if (result.isLoading) {
        // Show loading state if needed
      } else if (result.isSuccess) {
        const userProfile = result.data?.data?.[0];
        if (userProfile) {
          // Update UI with user data when available
          window.currentUserProfile = userProfile;
        }
      } else if (result.isError) {
        console.error("Failed to load user profile:", result.error);
      }
    });
  }

  // Reactive NPO following check using query data
  async function checkUserFollowingNpos() {
    if (!userProfileQuery) return { following: false, userNpos: [] };
    
    const result = userProfileQuery.getCurrentResult();
    if (!result.isSuccess) return { following: false, userNpos: [] };
    
    const user = result.data?.data?.[0];
    if (!user) return { following: false, userNpos: [] };
    
    let userNpos = [];
    
    // Check if favorite_npos is a relationship object
    if (user.favorite_npos?.data && Array.isArray(user.favorite_npos.data)) {
      userNpos = user.favorite_npos.data;
    } 
    // Fallback for legacy string format
    else if (typeof user.favorite_npos === 'string' && user.favorite_npos.trim() !== '') {
      const npoIds = user.favorite_npos.split(",");
      // Fetch NPO details for legacy format using TanStack Query
      const npoQueries = npoIds.map(npoId => window.createNPOProfileQuery(npoId.trim()));
      const npoResults = npoQueries.map(q => q.getCurrentResult());
      userNpos = npoResults
        .filter(result => result.isSuccess && result.data?.data?.[0])
        .map(result => result.data.data[0]);
    }

    return { 
      following: userNpos.length > 0, 
      userNpos: userNpos,
      userProfile: user
    };
  }

  // Function to check if user is following a specific NPO (for NPO page check)
  async function checkUserFollowingSpecificNpo(npoZuid) {
    try {
      const followingStatus = await checkUserFollowingNpos();
      if (!followingStatus.following) {
        return false;
      }

      return followingStatus.userNpos.some(npo => npo.meta.zuid === npoZuid);
    } catch (error) {
      console.error("Error checking specific NPO following status:", error);
      return false;
    }
  }

  // Global function to handle create story modal with reactive NPO following checks
  window.showCreateStoryModal = async function() {
    try {
      // Check if user is logged in
      const localUser = localStorage.getItem("user");
      if (!localUser) {
        // User not logged in, let the login modal handle this
        $("#loginModal").modal("show");
        return;
      }

      // Get NPO page ZUID if we're on an NPO page
      const npoPageZuid = window.npoPageZuid || "{{ $npoZuid }}";
      
      if (npoPageZuid && npoPageZuid.trim() !== "") {
        // Check if user follows this specific NPO reactively
        const isFollowingThisNpo = await checkUserFollowingSpecificNpo(npoPageZuid.trim());
        
        if (!isFollowingThisNpo) {
          $("#followThisNpoModal").modal("show");
          return;
        }
      } else {
        // Check if user follows any NPOs reactively
        const followingStatus = await checkUserFollowingNpos();
        
        if (!followingStatus.following) {
          $("#followAnyNpoModal").modal("show");
          return;
        }
      }

      // All checks passed, show the create story modal
      $("#createStoryModal").modal("show");
      
    } catch (error) {
      console.error("Error in showCreateStoryModal:", error);
      $("#createStoryModal").modal("show");
    }
  };

  $(document).ready(function () {
    // Initialize TanStack Query observers
    initializeQueries();
    subscribeToUserProfile();
    
    let currentStep = 1;
    const totalSteps = 4;

    const resetStates = () => {
      window.hero_image = [];
      window.story_title = "";
      window.story_description = "";
      window.story_content = "";
      window.story_location = "";
      window.story_npo = "";
      window.story_category = "";

      $("#uploadArea").val("");
      $("#fileInput").val(""); // Reset file input
      $("#storyTitle").val("");
      $("#storyDescription").val("");
      $("#npoSearchInput").val("");
      $("#categorySearchInput").val("");
      $("#location").val("");
      $("#storyContent").val("");
    };

    $("#createStoryModal .close-button").on("click", function () {
      //remove params from url
      if (window.location.search.includes("create-story")) {
        $("#downloadModal").modal("show");
      }
      window.history.replaceState({}, document.title, window.location.pathname);
      $("#createStoryModal").modal("hide");
    });

    // Centralized next button click handler
    $("#createStoryModal #nextBtn").on("click", async function () {
      const $nextBtn = $(this);
      const $spinner = $nextBtn.find(".spinner-border");

      // Show spinner and disable button
      $spinner.removeClass("d-none");
      $nextBtn.prop("disabled", true);

      try {
        // Call the appropriate function based on the current step
        switch (currentStep) {
          case 1:
            // Handle story information submission
            window.story_description = $("#storyDescription").val();

            // Find the NPO object and get its zuid
            const npoId = $("#selectedNPO").val();
            window.story_npo = npoId ? npoId : null;

            if (window.story_npo == "") {
              alert("Please select an NPO");
              return;
            }

            // Remove category validation check
            // Find the Category object and get its zuid
            const categoryId = $("#selectedCategory").val();
            window.story_category = categoryId ? categoryId : null;

            if (window.story_category == "") {
              alert("Please select a category");
              return;
            }

            window.story_location = $("#location").val();
            // Handle content addition
            window.story_content = $("#storyContent").val();

            try {
              const userData = JSON.parse(localStorage.getItem("user"));

              // Step 1: Upload media using TanStack Query mutation
              const uploadMediaMutation = window.createUploadMediaMutation();
              
              const uploadedImages = await new Promise((resolve, reject) => {
                const unsubscribe = uploadMediaMutation.subscribe((result) => {
                  if (result.status === 'success') {
                    resolve(result.data);
                    unsubscribe();
                  } else if (result.status === 'error') {
                    reject(result.error);
                    unsubscribe();
                  }
                });
                uploadMediaMutation.mutate(window.hero_image);
              });

              const imageIds = uploadedImages.map((img) => img.data[0].id || img.data[0].url);

              const storyData = {
                title: window.story_title,
                story: window.story_content || window.story_description,
                images: imageIds.join(","),
                cause_category: window.story_category,
                npo: window.story_npo,
                author: userData.zuid,
                date_published: new Date().toISOString(),
                description: window.story_description,
                ...(window.story_post_as_npo_zuid ? { npo_author: window.story_post_as_npo_zuid } : {}),
              };

              // Step 2: Create story using TanStack Query mutation
              const createStoryMutation = window.createCreateStoryMutation();
              
              const story = await new Promise((resolve, reject) => {
                const unsubscribe = createStoryMutation.subscribe((result) => {
                  if (result.status === 'success') {
                    resolve(result.data);
                    unsubscribe();
                  } else if (result.status === 'error') {
                    reject(result.error);
                    unsubscribe();
                  }
                });
                createStoryMutation.mutate(storyData);
              });

              if (story.data.length === 0) {
                alert(
                  `${story?.meta?.message || "Failed to upload story. Please try again."}`
                );
                return; // Prevent moving to the next step if uploads failed
              }

              // Step 3: Get created story data reactively
              const storyZuid = story?.meta?.story_zuid;
              if (storyZuid) {
                const storyQuery = window.createStoryQuery(storyZuid);
                
                // Subscribe to story data changes
                storyQuery.subscribe((result) => {
                  if (result.isSuccess) {
                    window.story_data = result.data;
                    $("#shareLink").val(`{{ $base_url }}${result.data?.data[0]?.meta?.web?.uri}`);
                  }
                });
                
                // Trigger initial fetch
                storyQuery.refetch();
              }
            } catch (error) {
              console.error("Error uploading story:", error);
              alert("Failed to upload story. Please try again.");
              return; // Prevent moving to the next step if uploads failed
            }

            $("#backBtn").addClass("d-none");
            break;
          case 2:
            // Handle completion (e.g., close modal or submit form)
            $("#createStoryModal").modal("hide");

            break;
        }

        if (currentStep < totalSteps) {
          currentStep++;
          showSection(currentStep);
        }
      } catch (error) {
        console.error("Error in next button handler:", error);
        alert("An error occurred. Please try again.");
      } finally {
        // Hide spinner and restore button state
        $spinner.addClass("d-none");
        $nextBtn.prop("disabled", false);
      }
    });

    window.updateNextButtonState = function(enable) {
      const $nextBtn = $("#createStoryModal #nextBtn");
      $nextBtn.prop("disabled", enable);
      if (!enable) {
        $nextBtn.find(".spinner-border").addClass("d-none");
      }
    }

    function updateStepIndicator() {
      $(".step-item").removeClass("active completed");
      for (let i = 1; i <= totalSteps; i++) {
        if (i < currentStep) {
          $(`.step-item[data-step="${i}"]`).addClass("completed");
        } else if (i === currentStep) {
          $(`.step-item[data-step="${i}"]`).addClass("active");
        }
      }
    }

    function showSection(step) {
      $(".section-container").addClass("d-none");
      $(`#${getSectionId(step)}`).removeClass("d-none");

      // Update section content
      const content = selectionHeaderTextsForCreateStoryModal[step - 1];
      $(`#${getSectionId(step)} .section-title`).text(content.title);
      $(`#${getSectionId(step)} .section-description`).text(
        content.description
      );
      $(`#${getSectionId(step)} .section-icon`).attr("src", content.icon);

      // Show/hide back button
      $("#backBtn").toggle(step > 1);

      // Enable Next button for all steps except the first one
      $("#nextBtn").prop("disabled", step === 1);

      updateStepIndicator();
    }

    function getSectionId(step) {
      const sections = [
        // "uploadHeroImageSelection",
        "storyInformationSelection",
        // "addContentSelection",
        "shareSelection",
      ];
      return sections[step - 1];
    }

    // Initialize first step
    showSection(currentStep);

    // Handle back button clicks
    $(document).on("click", "#backBtn", function () {
      $("#createStoryModal #nextBtn").prop("disabled", false);
      if (currentStep > 1) {
        currentStep--;
        showSection(currentStep);
      }
    });

    // Reset modal state when it's hidden
    $("#createStoryModal").on("hidden.bs.modal", function () {
      currentStep = 1;
      showSection(currentStep);
    });

    // Log when the modal is shown
    $("#createStoryModal").on("shown.bs.modal", function () {
      if (window.resetAllStates) {
        window.resetAllStates();
      }
      // Initialize first step
      showSection(currentStep);
    });

    // Handle "Explore Nonprofits" button click in the general follow modal
    $("#exploreNposBtn").on("click", function() {
      $("#followAnyNpoModal").modal("hide");
      
      // Redirect to nonprofits directory page
      const nonprofitsUrl = "{{non_profits_search_page.first().getUrl()}}"; 
      if (nonprofitsUrl && nonprofitsUrl !== "") {
        window.location.href = nonprofitsUrl;
      } else {
        // Fallback URL
        window.location.href = "/nonprofits";
      }
    });

    // Handle "Got It, I'll Follow Them" button click in the NPO-specific follow modal
    $("#stayOnNpoPageBtn").on("click", function() {
      $("#followThisNpoModal").modal("hide");
      // User stays on the current NPO page to follow the nonprofit
      // The modal just closes, no redirect needed
    });
  });
</script>
