<style>
  .navbar-nav .nav-item {
    display: flex;
    justify-content: end;
  }

  .navbar {
    /* min-height: 80px; */
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: white;
  }

  @media (max-width: 767.98px) {
    .nav-item .dropdown-menu-end {
      right: auto;
      left: 0;
    }
  }

  #search-results-dropdown {
    display: none;
    position: absolute;
    top: calc(100% + 5px); /* Add a little distance */
    right: 0; /* Align to the right */
    z-index: 1000;
    min-width: 100%; /* Set min width to 100% of the parent */
    min-height: 50px; /* Set min height */
    max-width: 400px; /* Set max width */
    max-height: 250px; /* Set max height */
    overflow-y: auto; /* Enable vertical scrolling */
    overflow-x: hidden; /* Hide horizontal overflow */
    padding: 0.5rem 0;
    font-size: 1rem;
    color: #212529;
    text-align: left;
    list-style: none;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid rgba(0, 0, 0, 0.15);
    border-radius: 0.25rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }

  #search-results-dropdown .dropdown-header {
    display: block;
    padding: 0.5rem 1.5rem;
    margin-bottom: 0;
    font-size: 0.875rem;
    color: #6c757d;
    white-space: nowrap;
    font-weight: bold;
    font-style: italic;
  }

  #search-results-dropdown .dropdown-item {
    display: block;
    width: 100%;
    padding: 0.25rem 1.5rem;
    clear: both;
    font-weight: 400;
    color: #212529;
    text-align: inherit;
    white-space: nowrap;
    background-color: transparent;
    border: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    position: relative;
  }

  #search-results-dropdown .dropdown-item.scroll-text:hover {
    animation: scrollText 7s linear infinite;
    white-space: nowrap; /* Ensure text does not wrap */
    background-color: #f8f9fa; /* Update background color */
  }

  @keyframes scrollText {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(
        calc(-100% + 100px)
      ); /* Adjust 100px to the width of the container */
    }
  }

  #search-results-dropdown .dropdown-item:hover {
    color: #16181b;
    text-decoration: none;
    background-color: #f8f9fa;
    overflow: visible;
    white-space: nowrap; /* Ensure text does not wrap */
  }

  #search-results-dropdown .dropdown-divider {
    height: 1px;
    margin: 0.5rem 0;
    overflow: hidden;
    background-color: #e9ecef;
  }

  .scrolling-text {
    display: inline-block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  .scrolling-text:hover {
    overflow: visible;
    max-width: unset;
    text-overflow: unset;
  }

  .dropdown-item.no-results {
    text-align: center;
    color: #6c757d;
  }
  #global-search {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>');
    background-repeat: no-repeat;
    background-position: 10px center;
    padding-left: 35px;
    max-width: 548px;
  }

  .profile-dropdown {
    width: 300px;
  }
  .profile-header {
    display: flex;
    align-items: center;
    padding: 10px;
  }
  .dropdown-profile-image {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    margin-right: 10px;
    object-fit: cover;
  }
  .profile-dropdown .dropdown-profile-image {
    width: 40px;
    height: 40px;
  }
  .menu-section {
    padding: 10px 0;
  }
  .menu-header {
    font-size: 0.8em;
    color: #6c757d;
    padding: 5px 20px;
  }
  .profile-dropdown .menu-item {
    display: flex;
    align-items: center;
    padding: 8px 20px;
    color: #212529;
    text-decoration: none;
  }
  .profile-dropdown .menu-item:hover {
    background-color: #f8f9fa;
  }
  .profile-dropdown .menu-item i {
    margin-right: 10px;
    width: 20px;
  }
  .donation-section {
    padding: 10px 20px;
  }
  .donation-progress {
    height: 6px;
  }
  #profileDropdown {
    background-color: white;
    border: var(--bs-border-width) solid var(--bs-border-color);
  }
  #profileDropdown:hover {
    background-color: #f8f9fa;
  }
  .offcanvas-profile-button-image {
    width: 40px;
    height: 40px;
  }
</style>

<nav
  id="header-container"
  class="navbar navbar-expand-lg border-bottom border-light-subtle"
>
  <div class="container-lg my-2">
    <!-- Profile dropdown button for mobile -->
    <button
      class="btn  d-lg-none"
      type="button"
      data-bs-toggle="offcanvas"
      data-bs-target="#offcanvasProfile"
      aria-controls="offcanvasProfile"
    >
      <img
        id="offcanvas-profile-image"
        src="https://i.pravatar.cc/100?img=5"
        alt="Profile"
        class="dropdown-profile-image m-0 offcanvas-profile-button-image"
      />
    </button>
    <a class="navbar-brand" href="/">
      <img
        src="{{globals.logo.getImage()}}"
        style="max-width: 160px"
        alt="cause circle brand logo"
      />
    </a>
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="offcanvas"
      data-bs-target="#offcanvasNavbar"
      aria-controls="offcanvasNavbar"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>
    <!-- offcanvas for profile -->
    <div class="offcanvas offcanvas-start d-block d-md-none" tabindex="-1" id="offcanvasProfile" aria-labelledby="offcanvasProfileLabel">
      <div class="offcanvas-header">
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body pt-0">
        <div
          class="dropdown-menu profile-dropdown show d-block position-static border-0 w-100"
          aria-labelledby="profileDropdown"
        >
          <a id="profile-header-link-offcanvas" href="#" class="text-decoration-none btn-outline-secondary">
            <div class="profile-header">
              <img
                src="https://i.pravatar.cc/100?img=5"
                alt="Profile"
                class="dropdown-profile-image"
              />
              <div>
                <strong class="profile-name">User Name</strong>
                <div class="text-muted profile-role">Role</div>
              </div>
            </div>
          </a>
          <div class="menu-section d-none">
            <div class="menu-header">CONTENT</div>
            <a href="#" class="menu-item"
              ><i class="bi bi-file-text"></i> Content</a
            >
            <a href="#" class="menu-item"
              ><i class="bi bi-calendar-event"></i> Events</a
            >
          </div>
          <div class="menu-section">
            <div class="menu-header">SETTINGS</div>
            <a
              id="edit-profile-btn"
              href="{{user_settings.first().getUrl()}}"
              class="menu-item"
              ><i class="bi bi-person"></i> Edit Profile</a
            >
            <a href="#" class="menu-item d-none"
              ><i class="bi bi-shield-lock"></i> Privacy & Security</a
            >
            <a href="#" class="menu-item d-none"
              ><i class="bi bi-bell"></i> Notification Settings</a
            >
            <a href="#" class="menu-item d-none"
              ><i class="bi bi-link-45deg"></i> Connected Accounts</a
            >
          </div>
          <div class="menu-section">
            <div class="menu-header">MANAGE</div>
            <div id="manage-menu-items-offcanvas"></div>
          </div>
          <div class="menu-section d-none">
            <div class="menu-header">SUPPORT</div>
            <a href="#" class="menu-item"><i class="bi bi-book"></i> Guide</a>
            <a href="#" class="menu-item"
              ><i class="bi bi-question-circle"></i> Help Center</a
            >
          </div>
          <div class="donation-section d-none">
            <div
              class="d-flex justify-content-between align-items-center mb-1"
            >
              <small>Donation collected</small>
              <small>11 Donations</small>
            </div>
            <div class="progress donation-progress mb-1">
              <div
                class="progress-bar bg-primary"
                role="progressbar"
                style="width: 75%"
                aria-valuenow="75"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
            </div>
            <small class="text-primary">US$5,366,460 Collected</small>
          </div>
          <div class="dropdown-divider"></div>
          <a href="#" class="menu-item logout-btn signout-btn cursor-pointer"
            ><i class="bi bi-box-arrow-right"></i> Logout</a
          >
        </div>
      </div>
    </div>
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
      <div class="offcanvas-header">
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="navbar-nav justify-content-start flex-grow-1 pe-3">
          <li class="nav-item">
            <a
              id="home-btn"
              href="{{home_feed.first().getUrl()}}"
              aria-current="page"
              class="nav-link"
              >Home</a
            >
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              aria-current="page"
              href="{{stories_landing_page.first().getUrl()}}"
              >Stories
            </a>
          </li>
          <li class="nav-item d-none">
            <a
              class="nav-link"
              aria-current="page"
              href="{{non_profits_landing_page.first().getUrl()}}"
              >Nonprofits
            </a>
          </li>
          <li class="nav-item dropdown d-none d-md-flex">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              About
            </a>
            <ul class="dropdown-menu">
              <li>
                <a
                  class="dropdown-item text-end"
                  href="{{about.first().getUrl()}}"
                >
                  About CauseCircle
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item text-end"
                  href="{{blogs_page.first().getUrl()}}"
                >
                  Blog
                </a>
              </li>
            </ul>
          </li>
          <li class="nav-item d-flex d-md-none">
            <a
              class="nav-link"
              href="{{about.first().getUrl()}}"
            >
              About CauseCircle
            </a>
          </li>
          <li class="nav-item d-flex d-md-none">
            <a
              class="nav-link"
              href="{{blogs_page.first().getUrl()}}"
            >
              Blog
            </a>
          </li>
          <li class="nav-item d-flex d-md-none">
            <a
              class="nav-link"
              aria-current="page"
              href="{{how_it_works_page.first().getUrl()}}"
              >How It Works
            </a>
          </li>
          <li class="nav-item d-flex d-md-none ">
            <a
              class="nav-link"
              aria-current="page"
              href="{{non_profits_search_page.first().getUrl()}}"
              >Nonprofit Directory
            </a>
          </li>
          <li class="nav-item d-flex d-md-none">
            <a
              class="nav-link"
              aria-current="page"
              href="{{claim_listing_page.first().getUrl()}}"
              >Claim Listing
            </a>
          </li>
          <li class="nav-item d-none">
            <a class="nav-link" href="{{partner_page.first().getUrl()}}"
              >Partners</a
            >
          </li>
          <li class="nav-item d-none">
            <a
              class="nav-link"
              aria-current="page"
              href="{{blogs_page.first().getUrl()}}"
            >
              Blog
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="d-none d-lg-flex gap-2 align-items-center">
      <div id="non-profits-dropdown" class="dropdown">
        <a
          href="{{non_profits_landing_page.first().getUrl()}}"
          class="btn btn-secondary border-0 dropdown-toggle"
          id="navbarDropdown"
          role="button"
        >
          For Nonprofits
        </a>
        <ul
          class="dropdown-menu dropdown-menu-end"
          aria-labelledby="navbarDropdown"
        >
          <li>
            <a
              class="dropdown-item text-end"
              aria-current="page"
              href="{{how_it_works_page.first().getUrl()}}"
              >How It Works
            </a>
          </li>
          <li>
            <a
              class="dropdown-item text-end"
              aria-current="page"
              href="{{non_profits_search_page.first().getUrl()}}"
              >Nonprofit Directory
            </a>
          </li>

          <li>
            <a
              class="dropdown-item text-end"
              aria-current="page"
              href="{{claim_listing_page.first().getUrl()}}"
              >Claim Listing
            </a>
          </li>
        </ul>
      </div>
      <div class="dropdown">
        <input
          type="text"
          id="global-search"
          class="form-control dropdown-toggle"
          placeholder="Search..."
          aria-label="Search"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        />
        <ul
          id="search-results-dropdown"
          class="dropdown-menu dropdown-menu-end"
        ></ul>
      </div>
      <button
        class="btn btn-secondary border-0"
        id="feedback-btn"
        title="Feedback"
      >
        <i class="bi bi-chat-right-text fs-5"></i>
      </button>
      <a
        id="contact-us-btn"
        href="{{demo_page.first().getUrl()}}"
        class="btn btn-secondary text-nowrap d-none"
      >
        Contact Us
      </a>
      <!-- Profile dropdown -->
      <div class="dropdown">
        <button
          class="btn dropdown-toggle d-none"
          type="button"
          id="profileDropdown"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          <img
            src="https://i.pravatar.cc/100?img=5"
            alt="Profile"
            class="dropdown-profile-image"
          />
          <span class="profile-name">User Name</span>
        </button>
        <div
          class="dropdown-menu profile-dropdown dropdown-menu-end"
          aria-labelledby="profileDropdown"
        >
          <a id="profile-header-link" href="#" class="text-decoration-none btn-outline-secondary">
            <div class="profile-header">
              <img
                src="https://i.pravatar.cc/100?img=5"
                alt="Profile"
                class="dropdown-profile-image"
              />
              <div>
                <strong class="profile-name">User Name</strong>
                <div class="text-muted profile-role">Role</div>
              </div>
            </div>
          </a>
          <div class="menu-section d-none">
            <div class="menu-header">CONTENT</div>
            <a href="#" class="menu-item"
              ><i class="bi bi-file-text"></i> Content</a
            >
            <a href="#" class="menu-item"
              ><i class="bi bi-calendar-event"></i> Events</a
            >
          </div>
          <div class="menu-section">
            <div class="menu-header">SETTINGS</div>
            <a
              id="edit-profile-btn"
              href="{{user_settings.first().getUrl()}}"
              class="menu-item"
              ><i class="bi bi-person"></i> Edit Profile</a
            >
            <a href="#" class="menu-item d-none"
              ><i class="bi bi-shield-lock"></i> Privacy & Security</a
            >
            <a href="#" class="menu-item d-none"
              ><i class="bi bi-bell"></i> Notification Settings</a
            >
            <a href="#" class="menu-item d-none"
              ><i class="bi bi-link-45deg"></i> Connected Accounts</a
            >
          </div>
          <div class="menu-section">
            <div class="menu-header">MANAGE</div>
            <div id="manage-menu-items"></div>
          </div>
          <div class="menu-section d-none">
            <div class="menu-header">SUPPORT</div>
            <a href="#" class="menu-item"><i class="bi bi-book"></i> Guide</a>
            <a href="#" class="menu-item"
              ><i class="bi bi-question-circle"></i> Help Center</a
            >
          </div>
          <div class="donation-section d-none">
            <div
              class="d-flex justify-content-between align-items-center mb-1"
            >
              <small>Donation collected</small>
              <small>11 Donations</small>
            </div>
            <div class="progress donation-progress mb-1">
              <div
                class="progress-bar bg-primary"
                role="progressbar"
                style="width: 75%"
                aria-valuenow="75"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
            </div>
            <small class="text-primary">US$5,366,460 Collected</small>
          </div>
          <div class="dropdown-divider"></div>
          <a href="#" class="menu-item logout-btn signout-btn cursor-pointer"
            ><i class="bi bi-box-arrow-right"></i> Logout</a
          >
        </div>
      </div>
      <a
        href="{{login_page.first().getUrl()}}"
        class="btn btn-primary text-nowrap signin-btn d-none"
      >
        Sign In
      </a>
    </div>
  </div>
</nav>

<!-- prettier-ignore -->
{{include /components/global/feedback_modal.html}}

<script>
  const localUser = JSON.parse(localStorage.getItem("user"));

  const getUserManagedNpos = async (zuid) => {
    $.getJSON(
      `https://causecircle.org/mobileapp/npos.json?admin_zuid=${zuid}`,
      (data) => {
        // console.log("data", data);
        $("#manage-menu-items").empty();
        $("#manage-menu-items-offcanvas").empty(); // Ensure offcanvas is targeted too
        data.data.forEach((npo) => {
          const logoUrl = typeof npo.logo === 'string' ? npo.logo : (npo.logo?.data[0]?.url || 'https://placehold.co/24x24');
          $("#manage-menu-items").append(
            `<a href="{{npo_admin_page.first().getUrl()}}?zuid=${npo?.meta?.zuid}" class="menu-item">
              <img src="${logoUrl}" alt="${npo.name} logo" class="dropdown-profile-image me-2">
              ${npo.name}
            </a>`
          );
          $("#manage-menu-items-offcanvas").append(
            `<a href="{{npo_admin_page.first().getUrl()}}?zuid=${npo?.meta?.zuid}" class="menu-item">
              <img src="${logoUrl}" alt="${npo.name} logo" class="dropdown-profile-image me-2">
              ${npo.name}
            </a>`
          );
        });
      }
    );
  };

  $(document).ready(async function () {
    if (localUser) {
      const data = await getZestyUser(localUser.zuid);
      const zestyUser = data.user.data;
      await getUserManagedNpos(localUser.zuid);

      if (zestyUser) {
        $("#profileDropdown img").attr("src", zestyUser.profile_image);
        $("#profileDropdown .profile-name").text(zestyUser.first_name);
        $("#profileDropdown .profile-role").text(zestyUser.user_type);
        $(".profile-header img").attr("src", zestyUser.profile_image);
        $(".profile-header .profile-name").text(
          zestyUser.first_name + " " + zestyUser.last_name
        );
        $(".profile-header .profile-role").text(zestyUser.user_type);
        $("#profile-header-link-offcanvas").attr("href", data.user.web.path);
        $("#profile-header-link").attr("href", data.user.web.path);
        $(".offcanvasProfile .profile-header img").attr("src", zestyUser.profile_image);
        $(".offcanvasProfile .profile-header .profile-name").text(
          zestyUser.first_name + " " + zestyUser.last_name
        );
        $(".offcanvasProfile .profile-header .profile-role").text(zestyUser.user_type);
        $("#offcanvas-profile-image").attr("src", zestyUser.profile_image);
        getUserManagedNpos(localUser.zuid);

        $("#edit-profile-btn").attr(
          "href",
          `{{user_settings.first().getUrl()}}?zuid=${localUser.zuid}`
        );
      }
    }

    const $globalSearch = $("#global-search");
    const $searchResultsDropdown = $("#search-results-dropdown");

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    $globalSearch.on(
      "input",
      debounce(() => {
        const searchInput = $globalSearch.val();
        if (searchInput) {
          searchAll(searchInput);
        } else {
          $searchResultsDropdown.empty().hide();
        }
      }, 300)
    );

    $globalSearch.on("focus", function () {
      const searchInput = $globalSearch.val();
      if (searchInput) {
        searchAll(searchInput);
      }
    });

    $globalSearch.on("blur", function () {
      setTimeout(() => {
        $searchResultsDropdown.hide();
      }, 200); // Delay to allow click events to register
    });

    $("#non-profits-dropdown")
      .on("mouseenter", function () {
        $("#non-profits-dropdown").dropdown("show");
      })
      .on("mouseleave", function () {
        $("#non-profits-dropdown").dropdown("hide");
      });

    function searchAll(query) {
      const npoUrl = `https://causecircle.org/mobileapp/npos.json?search=${encodeURIComponent(
        query
      )}`;
      const causesUrl = `https://causecircle.org/mobileapp/causes.json?search=${encodeURIComponent(
        query
      )}`;
      const storiesUrl = `https://causecircle.org/mobileapp/stories.json?search=${encodeURIComponent(
        query
      )}`;

      Promise.all([
        $.getJSON(npoUrl),
        $.getJSON(causesUrl),
        $.getJSON(storiesUrl),
      ])
        .then(([nposData, causesData, storiesData]) => {
          displayResults(nposData.data, causesData.data, storiesData.data);
        })
        .catch((error) => {
          console.error("Error fetching search results:", error);
          $searchResultsDropdown.empty().hide();
        });
    }

    function displayResults(npos, causes, stories) {
      $searchResultsDropdown.empty().show();
      $searchResultsDropdown.css("min-width", $globalSearch.outerWidth());

      function appendResults(sectionTitle, data, isLastSection, searchType) {
        if (data.length > 0) {
          $searchResultsDropdown.append(
            `<h6 class="dropdown-header">${sectionTitle}</h6>`
          );
          data.slice(0, 5).forEach((item) => {
            const $item = $(
              `<a class="dropdown-item" href="${item.meta?.web?.uri || "#"}">
                ${item.name || item.title}
              </a>`
            );
            $searchResultsDropdown.append($item);
            if ($item[0].scrollWidth > $item[0].clientWidth) {
              $item.addClass("scroll-text");
            }
          });
          if (data.length > 5) {
            let moreResultsUrl;
            switch (searchType) {
              case "npos":
                moreResultsUrl = `{{ non_profits_search_page.first().path_full }}?search=${encodeURIComponent(
                  $globalSearch.val()
                )}`;
                break;
              case "causes":
                moreResultsUrl = `{{ causes_landing_page.first().path_full }}?search=${encodeURIComponent(
                  $globalSearch.val()
                )}`;
                break;
              case "stories":
                moreResultsUrl = `{{ stories_landing_page.first().path_full }}?search=${encodeURIComponent(
                  $globalSearch.val()
                )}`;
                break;
            }
            $searchResultsDropdown.append(
              `<a class="dropdown-item text-muted" href="${moreResultsUrl}">+${
                data.length - 5
              } more results</a>`
            );
          }
          if (!isLastSection) {
            $searchResultsDropdown.append(
              '<div class="dropdown-divider"></div>'
            );
          }
        }
      }

      const sections = [
        { title: "Nonprofits", data: npos, type: "npos" },
        { title: "Causes", data: causes, type: "causes" },
        { title: "Stories", data: stories, type: "stories" },
      ];

      let hasResults = false;
      sections.forEach((section, index) => {
        if (section.data.length > 0) {
          hasResults = true;
        }
        appendResults(
          section.title,
          section.data,
          index === sections.length - 1,
          section.type
        );
      });

      if (!hasResults) {
        $searchResultsDropdown.append(
          '<div class="dropdown-item no-results"><p class="text-center">No results found</p></div>'
        );
      }
    }
  });
      console.log("🚀 ~ zestyUser:", zestyUser)
      console.log("🚀 ~ zestyUser:", zestyUser)
      console.log("🚀 ~ zestyUser:", zestyUser)
      console.log("🚀 ~ zestyUser:", zestyUser)
      console.log("🚀 ~ zestyUser:", zestyUser)
      console.log("🚀 ~ zestyUser:", zestyUser)
      console.log("🚀 ~ zestyUser:", zestyUser)
</script>
