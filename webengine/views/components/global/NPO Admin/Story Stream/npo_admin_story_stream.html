<style>
  .story-stream-tabs .nav {
    gap: 1rem;
  }

  .stream-nav-link {
    color: #666;
    padding: 0.5rem 0;
    position: relative;
    transition: color 0.2s ease;
    text-decoration: none;
  }

  .stream-nav-link:hover {
    color: #000;
  }

  .stream-nav-link.active {
    color: #000;
    font-weight: 500;
  }

  .stream-nav-link.active::after {
    content: "";
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: #6366f1;
    border-radius: 2px;
  }

  .count {
    display: inline-block;
    margin-left: 0.5rem;
    color: #666;
  }

  .stories-list {
    max-height: calc(100vh - 300px);
    overflow-y: auto;
  }

  /* Add these styles for tab pane visibility */
  .stream-tab-pane {
    display: none;
  }

  .stream-tab-pane.active {
    display: block;
  }

  .post-card .btn-link {
    color: #666;
    padding: 0.25rem 0.5rem;
  }

  .post-card .btn-link:hover {
    color: #000;
  }

  .post-card .dropdown-item {
    color: #666;
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
  }

  .post-card .dropdown-item:hover {
    background-color: #f8f9fa;
    color: #000;
  }

  /* Hashtag styles */
  .hashtag-item {
    color: #7b3fee;
    text-decoration: none;
    font-size: 0.85rem;
    margin-right: 8px;
    cursor: pointer;
  }

  .hashtag-item:hover {
    text-decoration: underline;
    color: #5a2bb8;
  }

  .hashtags-container {
    margin-top: 8px;
    line-height: 1.4;
  }

  /* Story media styling */
  .story-media {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
  }

  /* Author section hover effect */
  .author-section:hover .author-name {
    color: var(--bs-primary) !important;
    transition: color 0.2s ease;
  }

  /* Skeleton Loading Animation */
  .skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
  }

  @keyframes loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  .skeleton-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .skeleton-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .skeleton-text {
    height: 1rem;
    border-radius: 4px;
    margin-bottom: 0.5rem;
  }

  .skeleton-text-sm {
    width: 60%;
    height: 0.875rem;
  }

  .skeleton-text-md {
    width: 80%;
  }

  .skeleton-text-lg {
    width: 100%;
    height: 1.125rem;
  }

  .skeleton-media {
    width: 100%;
    height: 200px;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  /* Skeleton to story transition */
  .skeleton-placeholder {
    transition: all 0.3s ease-in-out;
  }

  .story-card-rendered {
    opacity: 0;
    animation: slideInStory 0.4s ease-out forwards;
  }

  @keyframes slideInStory {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Story Card Styles - Mobile Only Version */
  .post-card {
    border-radius: 24px;
    overflow: hidden;
    background-color: #fff;
    box-shadow: 0px 8px 16px 4px #0E121B14;
    padding: 0;
    border: none;
    display: flex;
    flex-direction: column;
  }

  .post-header {
    display: flex;
    align-items: flex-start;
    padding: 12px 16px;
    gap: 12px;
    border-bottom: 1px solid #f1f1f1;
  }

  .profile-img {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
  }

  .post-meta {
    flex: 1;
    min-width: 0;
    overflow: visible;
  }

  .npo-name {
    font-size: 1rem;
    font-weight: 500;
    margin: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    white-space: normal;
    overflow: visible;
    text-overflow: clip;
  }

  .post-content {
    padding: 0 16px;
  }

  .story-carousel {
    border-radius: 12px !important;
    overflow: hidden;
  }

  /* Action Buttons Styling - Mobile Only */
  .post-actions {
    background-color: #ffffff;
    border-radius: 0 0 10px 10px;
    margin-top: auto;
  }

  .action-btn {
    padding: 12px 4px;
    color: #636363;
    font-weight: 400;
    transition: background-color 0.2s;
    border: none;
    background-color: transparent;
    font-size: 1.1rem;
  }

  .action-btn:hover {
    background-color: #f8f9fa;
  }

  .action-btn svg {
    margin-right: 0;
    vertical-align: middle;
  }

  .action-btn.liked {
    color: #7b3fee;
    font-weight: 500;
  }

  .action-btn.liked svg path {
    fill: #7b3fee;
  }

  /* Hide action button text on mobile, but show counters */
  .action-btn .action-label {
    display: none;
  }
  
  .action-btn .action-counter {
    display: inline;
    font-size: 0.9rem;
    margin-left: 4px;
  }
</style>

<div class="tab-pane fade" id="story-stream">
  <div>
    <h3 class="mb-4">Story Hub</h3>
    <div
      id="stream-review-stories-card"
      class="card d-flex flex-row justify-content-between align-items-center mb-4 d-none"
      role="button"
      data-bs-toggle="modal"
      data-bs-target="#reviewStoriesModal"
      style="cursor: pointer"
    >
      <div class="d-flex gap-4 align-items-center">
        <div>
          <i class="bi bi-list-check fs-4"></i>
        </div>
        <div id="stream-review-stories-count">
          <h6 class="mb-0">Review 0 New User Stories</h6>
          <small class="text-muted"
            >Approve or reject stories created by users for your non
            profit</small
          >
        </div>
      </div>
      <div>
        <i class="bi bi-arrow-right fs-4"></i>
      </div>
    </div>

    <!-- Story Stream Tabs -->
    <div class="story-stream-tabs">
      <div class="nav flex-row mb-4">
        <a class="stream-nav-link active" href="#approved" data-bs-toggle="tab">
          Approved <span class="count" id="approved-count">0</span>
        </a>
        <a class="stream-nav-link" href="#rejected" data-bs-toggle="tab">
          Rejected <span class="count" id="rejected-count">0</span>
        </a>
        <a class="stream-nav-link" href="#to-review" data-bs-toggle="tab">
          To Review <span class="count" id="to-review-count">0</span>
        </a>
      </div>

      <div class="tab-content">
        <!-- Approved Stories -->
        <div class="tab-pane fade show active" id="approved">
          <div class="stories-list row g-3">
            <!-- Stories will be loaded here -->
          </div>
        </div>

        <!-- Rejected Stories -->
        <div class="tab-pane fade" id="rejected">
          <div class="stories-list row g-3">
            <!-- Stories will be loaded here -->
          </div>
        </div>

        <!-- To Review Stories -->
        <div class="tab-pane fade" id="to-review">
          <div class="stories-list row g-3">
            <!-- Stories will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // Function to decode HTML entities
  function decodeHtmlEntities(text) {
    if (!text) return "";

    // Create a temporary div element to decode HTML entities
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = text;
    return tempDiv.textContent || tempDiv.innerText || "";
  }

  // Function to extract hashtags from story text
  function extractHashtagsFromText(text) {
    if (!text) return [];

    // First decode HTML entities (like &#39; &#32; etc.)
    const decodedText = decodeHtmlEntities(text);

    // Regular expression to find hashtags (#word)
    const hashtagRegex = /#[a-zA-Z0-9_]+/g;
    const hashtags = decodedText.match(hashtagRegex);

    if (!hashtags || hashtags.length === 0) return [];

    // Remove duplicates and clean up
    const uniqueHashtags = [
      ...new Set(hashtags.map((tag) => tag.toLowerCase())),
    ];

    return uniqueHashtags;
  }

  // Function to generate hashtag HTML for story cards
  function generateHashtagsHtml(storyText) {
    const hashtags = extractHashtagsFromText(storyText);

    if (hashtags.length === 0) return "";

    // Create hashtag HTML with proper links
    const hashtagsHtml = hashtags
      .map((hashtag) => {
        const encodedHashtag = encodeURIComponent(hashtag);
        return `<a href="/stories/?search=${encodedHashtag}" class="hashtag-item" target="_blank" rel="noopener noreferrer">${hashtag}</a>`;
      })
      .join("");

    return `<div class="hashtags-container">${hashtagsHtml}</div>`;
  }

  // Helper function to format dates as time ago
  function formatTimeAgo(dateString) {
    if (!dateString) return "";

    try {
      let date;

      // Check if dateString is already in ISO format (includes 'T' and ends with 'Z' or timezone)
      if (
        dateString.includes("T") &&
        (dateString.includes("Z") ||
          dateString.includes("+") ||
          dateString.includes("-"))
      ) {
        // ISO format with timezone info - parse directly
        date = new Date(dateString);
      } else {
        // Legacy format without timezone - treat as UTC
        date = new Date(dateString + " UTC");
      }

      // Validate the date
      if (isNaN(date.getTime())) {
        throw new Error("Invalid date");
      }

      const now = new Date();
      const diffInMilliseconds = now - date;
      const diffInSeconds = Math.floor(diffInMilliseconds / 1000);
      const diffInMinutes = Math.floor(diffInSeconds / 60);
      const diffInHours = Math.floor(diffInMinutes / 60);
      const diffInDays = Math.floor(diffInHours / 24);
      const diffInMonths = Math.floor(diffInDays / 30);
      const diffInYears = Math.floor(diffInDays / 365);

      if (diffInSeconds < 60) {
        return diffInSeconds <= 1 ? "just now" : `${diffInSeconds}s ago`;
      } else if (diffInMinutes < 60) {
        return `${diffInMinutes}m ago`;
      } else if (diffInHours < 24) {
        return `${diffInHours}h ago`;
      } else if (diffInDays < 30) {
        return `${diffInDays}d ago`;
      } else if (diffInMonths < 12) {
        return `${diffInMonths}mo ago`;
      } else {
        return `${diffInYears}y ago`;
      }
    } catch (error) {
      console.error("Error formatting time:", error, "Input:", dateString);
      return "";
    }
  }

  // Function to detect if a URL is a video
  function isVideoUrl(url) {
    if (!url) return false;
    const videoPatterns = [
      /vimeo\.com\/video\/\d+/i,
      /vimeo\.com\/\d+/i,
      /player\.vimeo\.com\/video\/\d+/i,
      /youtube\.com\/watch\?v=/i,
      /youtu\.be\//i,
      /\.mp4$/i,
      /\.webm$/i,
      /\.ogg$/i,
      /\.mov$/i,
      /\.avi$/i,
    ];
    return videoPatterns.some((pattern) => pattern.test(url));
  }

  // Function to get video embed URL
  function getVideoEmbedUrl(url) {
    if (!url) return null;

    // Check if it's already a Vimeo player URL
    if (url.includes("player.vimeo.com/video/")) {
      return url.includes("?") ? url : `${url}?autoplay=0&loop=0&muted=0`;
    }

    // Vimeo regular URLs - handles both /video/ID and direct /ID formats
    const vimeoMatch = url.match(/vimeo\.com\/(?:video\/)?(\d+)/i);
    if (vimeoMatch) {
      return `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=0&loop=0&muted=0`;
    }

    // YouTube
    const youtubeMatch = url.match(
      /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/i
    );
    if (youtubeMatch) {
      return `https://www.youtube.com/embed/${youtubeMatch[1]}?autoplay=0&loop=0&muted=0`;
    }

    // Direct video files
    if (/\.(mp4|webm|ogg|mov|avi)$/i.test(url)) {
      return url;
    }
    return null;
  }

  // Function to create media element (image or video)
  function createMediaElement(mediaUrl, storyTitle) {
    if (!mediaUrl) {
      return `<img src="https://placehold.co/600x400?text=No+Image" class="story-media mb-3" alt="${storyTitle}">`;
    }

    const isVideo = isVideoUrl(mediaUrl);

    if (isVideo) {
      const embedUrl = getVideoEmbedUrl(mediaUrl);

      if (embedUrl) {
        if (
          embedUrl.includes("youtube.com") ||
          embedUrl.includes("vimeo.com")
        ) {
          // Embedded video (YouTube/Vimeo) - match image dimensions
          return `
            <div class="video-container mb-3" style="width: 100%; height: 200px; background-color: #000; border-radius: 8px; overflow: hidden;">
              <iframe style="width: 100%; height: 100%; object-fit: cover;" 
                      src="${embedUrl}" 
                      frameborder="0" 
                      allow="autoplay; fullscreen; picture-in-picture" 
                      allowfullscreen
                      title="${storyTitle}"></iframe>
            </div>
          `;
        } else {
          // Direct video file - match image dimensions
          return `
            <div class="video-container mb-3" style="width: 100%; height: 200px; background-color: #000; border-radius: 8px; overflow: hidden;">
              <video style="width: 100%; height: 100%; object-fit: cover;" 
                     controls 
                     preload="metadata" 
                     controlsList="nodownload">
                <source src="${embedUrl}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
          `;
        }
      }
    }

    // Default to image
    return `<img src="${mediaUrl}?width=200&auto=webp&quality=80&optimize=high" alt="${storyTitle}" class="story-media mb-3">`;
  }

  // Function to create skeleton placeholder
  function createSkeletonPlaceholder(index) {
    return `
      <div class="col-md-6 mb-3 skeleton-placeholder" data-skeleton-index="${index}">
        <div class="post-card">
          <div class="skeleton-header">
            <div class="skeleton skeleton-avatar"></div>
            <div style="flex: 1;">
              <div class="skeleton skeleton-text skeleton-text-md" style="width: 40%;"></div>
              <div class="skeleton skeleton-text skeleton-text-sm" style="width: 30%;"></div>
            </div>
          </div>
          <div class="skeleton skeleton-text skeleton-text-lg mb-2"></div>
          <div class="skeleton skeleton-text skeleton-text-md mb-2"></div>
          <div class="skeleton skeleton-text skeleton-text-md mb-3"></div>
          <div class="skeleton skeleton-media"></div>
        </div>
      </div>
    `;
  }

  // Function to update like button from stats data
  function updateLikeButtonFromStats(statsData, likeButton) {
    const currentUser = JSON.parse(localStorage.getItem('user'));
    const isLiked = currentUser && statsData.likedBy?.some(user => 
      (user.user_zuid && user.user_zuid === currentUser.zuid) || 
      (user.id && user.id === currentUser.zuid)
    );
    const fillColor = isLiked ? '#7b3fee' : '#99A0AE';
    const likeCount = statsData.likedBy ? statsData.likedBy.length : 0;
    
    let buttonHTML = `
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M11.95 7H16.75C17.1478 7 17.5294 7.15804 17.8107 7.43934C18.092 7.72065 18.25 8.10218 18.25 8.5V10.078C18.2502 10.274 18.212 10.4682 18.1375 10.6495L15.8162 16.2858C15.7596 16.4232 15.6634 16.5407 15.5399 16.6233C15.4164 16.706 15.2711 16.7501 15.1225 16.75H2.5C2.30109 16.75 2.11032 16.671 1.96967 16.5303C1.82902 16.3897 1.75 16.1989 1.75 16V8.5C1.75 8.30109 1.82902 8.11033 1.96967 7.96967C2.11032 7.82902 2.30109 7.75 2.5 7.75H5.1115C5.23157 7.75003 5.3499 7.72124 5.45653 7.66603C5.56315 7.61082 5.65497 7.53082 5.72425 7.43275L9.814 1.6375C9.8657 1.56424 9.94194 1.51192 10.0289 1.49005C10.1159 1.46817 10.2078 1.47818 10.288 1.51825L11.6485 2.1985C12.0314 2.38988 12.3372 2.70649 12.5153 3.09574C12.6933 3.48499 12.7329 3.92345 12.6273 4.33825L11.95 7ZM6.25 8.941V15.25H14.62L16.75 10.078V8.5H11.95C11.7215 8.49997 11.4961 8.44776 11.2909 8.34735C11.0857 8.24694 10.9062 8.10098 10.766 7.92062C10.6257 7.74026 10.5286 7.53025 10.4819 7.30662C10.4352 7.08299 10.4402 6.85166 10.4965 6.63025L11.1737 3.96925C11.1949 3.88625 11.1871 3.79849 11.1515 3.72058C11.1159 3.64266 11.0546 3.57929 10.978 3.541L10.4822 3.2935L6.94975 8.2975C6.76225 8.563 6.52225 8.7805 6.25 8.941V8.941ZM4.75 9.25H3.25V15.25H4.75V9.25Z" fill="${fillColor}"/>
      </svg>
    `;
    
    if (likeCount > 0) {
      buttonHTML += `<span class="action-counter">${likeCount}</span>`;
    }
    // No label needed as this is mobile-only view
    
    likeButton.html(buttonHTML);
    
    if (isLiked) {
      likeButton.addClass('liked');
    } else {
      likeButton.removeClass('liked');
    }
  }

  // Function to set up like button subscription for a story
  function setupLikeButtonSubscription(storyZuid) {
    const storyStatsQuery = window.createStoryStatsQuery(storyZuid);
    
    // Subscribe to changes
    const unsubscribe = storyStatsQuery.subscribe((result) => {
      if (result.isSuccess && result.data?.data) {
        const likeButton = $(`#stream-like-button-${storyZuid}`);
        if (likeButton.length > 0) {
          updateLikeButtonFromStats(result.data.data, likeButton);
        }
      }
    });
    
    // Trigger initial fetch to get current state
    storyStatsQuery.refetch();
    
    return unsubscribe;
  }

  // Function to render individual story with animation
  async function renderStoryCard(story, index, containerSelector) {
    return new Promise((resolve) => {
      // Small delay for smoother animation
      setTimeout(() => {
        try {
          const storyCardHtml = createStoryCard(story);

          // Find and replace the corresponding skeleton
          const skeletonSelector = `${containerSelector} .skeleton-placeholder[data-skeleton-index="${index}"]`;
          const skeletonToReplace = $(skeletonSelector);

          if (skeletonToReplace.length) {
            skeletonToReplace.fadeOut(200, function () {
              $(this).replaceWith(storyCardHtml);
              // Set up reactive like button subscription after card is rendered
              setupLikeButtonSubscription(story.meta.zuid);
              resolve();
            });
          } else {
            // Fallback: append to container
            $(containerSelector).append(storyCardHtml);
            // Set up reactive like button subscription after card is rendered
            setupLikeButtonSubscription(story.meta.zuid);
            resolve();
          }
        } catch (error) {
          console.error(`Error rendering story ${story?.meta?.zuid}:`, error);
          resolve(); // Continue with next story
        }
      }, index * 100); // Stagger by 100ms per story
    });
  }

  function createStoryCard(story) {
    // Determine media URL - handle both string and object formats
    let mediaUrl = "";
    if (typeof story?.story_image === "string") {
      mediaUrl = story.story_image || "";
    } else if (story?.story_image?.data && story.story_image.data.length > 0) {
      mediaUrl = story.story_image.data[0]?.url || "";
    }

    // Create media element (image or video)
    const mediaElement = createMediaElement(mediaUrl, story?.title || "");
    
    // Get NPO details for donate button
    const npoZuid = story.related_npos?.data?.[0]?.meta?.zuid || '';
    const donateLink = story.related_npos?.data?.[0]?.donate_link || '';

    return `
    <div class="col-md-6 mb-3 story-card-rendered">
      <div class="post-card" onclick="window.location.href='{{ $base_url }}${story?.meta?.web?.uri}'" style="cursor: pointer;">
        <!-- Post Header -->
        <div class="post-header" onclick="event.stopPropagation();">
          <img
            src="${
              typeof story.author.data[0]?.profile_image == "string"
                ? story.author.data[0]?.profile_image
                : story.author.data[0]?.profile_image?.data[0]?.url ||
                  "https://placehold.co/100x100?text=Profile"
            }?width=48"
            alt="Profile"
            class="profile-img"
          />
          <div class="post-meta">
            <h5 class="mb-0 npo-name">
              <a href="{{ $base_url }}${story.author.data[0]?.meta?.web?.uri || ''}" 
                 class="text-decoration-none text-dark fw-medium" 
                 target="_blank" 
                 onclick="event.stopPropagation()">
                ${story.author.data[0]?.first_name ?? "Anonymous"} ${story.author.data[0]?.last_name ?? ""}
              </a>
            </h5>
            <small class="text-muted">${formatTimeAgo(story.createdAt || story.meta?.createdAt || story.date_published)}</small>
          </div>
          ${
            story.npo_approved
              ? `
          <div class="ms-auto">
            <div class="dropdown">
              <button class="btn btn-link" type="button" 
                data-bs-toggle="dropdown" 
                aria-expanded="false">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <button class="dropdown-item" type="button" 
                    onclick="event.stopPropagation(); window.open('https://api.causecircle.org/stories/${story?.meta?.zuid}/download', '_blank')">
                    <i class="bi bi-download me-2"></i>Download Story
                  </button>
                </li>
              </ul>
            </div>
          </div>`
              : ""
          }
        </div>

        <!-- Story Image/Video -->
        <div class="px-3" style="position: relative;">
          ${mediaElement}
          ${
            story.npo_approved === "1"
              ? `<span class="badge" style="position: absolute; bottom: 32px; right: 32px; padding: 6px 12px; font-size: 0.85rem; font-weight: 500; background: #E0FAEC; border: 1px solid #FFFFFF; color: #178C4E;">Approved</span>`
              : ""
          }
        </div>

        <!-- Post Content -->
        <div class="post-content">
          <div class="text-muted mb-3 story-subtitle">
            ${story.story_body}
          </div>
          ${generateHashtagsHtml(story.story_body || "")}
        </div>

        <!-- Action Buttons -->
        <div class="post-actions d-flex" onclick="event.stopPropagation()">
          <button class="btn flex-grow-1 action-btn" id="stream-like-button-${story.meta.zuid}" data-story-zuid="${story.meta.zuid}" onclick="window.handleLikeClick('${story.meta.zuid}', event)">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M11.95 7H16.75C17.1478 7 17.5294 7.15804 17.8107 7.43934C18.092 7.72065 18.25 8.10218 18.25 8.5V10.078C18.2502 10.274 18.212 10.4682 18.1375 10.6495L15.8162 16.2858C15.7596 16.4232 15.6634 16.5407 15.5399 16.6233C15.4164 16.706 15.2711 16.7501 15.1225 16.75H2.5C2.30109 16.75 2.11032 16.671 1.96967 16.5303C1.82902 16.3897 1.75 16.1989 1.75 16V8.5C1.75 8.30109 1.82902 8.11033 1.96967 7.96967C2.11032 7.82902 2.30109 7.75 2.5 7.75H5.1115C5.23157 7.75003 5.3499 7.72124 5.45653 7.66603C5.56315 7.61082 5.65497 7.53082 5.72425 7.43275L9.814 1.6375C9.8657 1.56424 9.94194 1.51192 10.0289 1.49005C10.1159 1.46817 10.2078 1.47818 10.288 1.51825L11.6485 2.1985C12.0314 2.38988 12.3372 2.70649 12.5153 3.09574C12.6933 3.48499 12.7329 3.92345 12.6273 4.33825L11.95 7ZM6.25 8.941V15.25H14.62L16.75 10.078V8.5H11.95C11.7215 8.49997 11.4961 8.44776 11.2909 8.34735C11.0857 8.24694 10.9062 8.10098 10.766 7.92062C10.6257 7.74026 10.5286 7.53025 10.4819 7.30662C10.4352 7.08299 10.4402 6.85166 10.4965 6.63025L11.1737 3.96925C11.1949 3.88625 11.1871 3.79849 11.1515 3.72058C11.1159 3.64266 11.0546 3.57929 10.978 3.541L10.4822 3.2935L6.94975 8.2975C6.76225 8.563 6.52225 8.7805 6.25 8.941V8.941ZM4.75 9.25H3.25V15.25H4.75V9.25Z" fill="#99A0AE"/>
            </svg>
          </button>
          <button id="stream-donate-button-${story.meta.zuid}" class="btn flex-grow-1 action-btn" style="border-radius: 0;" onclick="window.handleStoryDonateClick('${npoZuid}', '${donateLink}', event)">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15.25 11.5V13.75H17.5V15.25H15.2493L15.25 17.5H13.75L13.7493 15.25H11.5V13.75H13.75V11.5H15.25ZM16.1823 4.56775C17.8788 6.26875 17.9373 8.97775 16.3593 10.744L15.2943 9.6805C16.2925 8.5375 16.24 6.745 15.1203 5.6275C13.993 4.50325 12.1803 4.45525 11.0028 5.51275L10.0015 6.41125L8.99952 5.5135C7.81827 4.4545 6.00627 4.501 4.87902 5.629C3.76152 6.7465 3.70527 8.53525 4.73502 9.71725L11.059 16.0518L10 17.1138L3.64002 10.7448C2.06202 8.97775 2.12127 6.26425 3.81702 4.56775C5.51577 2.86975 8.23302 2.81275 10 4.39675C11.7618 2.815 14.4843 2.8675 16.1815 4.56775H16.1823Z" fill="#99A0AE"/>
            </svg>
          </button>
          <button id="stream-comment-button-${story.meta.zuid}" class="btn flex-grow-1 action-btn" style="border-radius: 0;" onclick="event.stopPropagation(); window.location.href='{{ $base_url }}${story?.meta?.web?.uri}'">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6.46826 16.618L2.50001 17.5L3.38201 13.5317C2.80116 12.4453 2.49815 11.232 2.50001 10C2.50001 5.85775 5.85776 2.5 10 2.5C14.1423 2.5 17.5 5.85775 17.5 10C17.5 14.1422 14.1423 17.5 10 17.5C8.76802 17.5019 7.55472 17.1988 6.46826 16.618V16.618ZM6.68576 15.0332L7.17551 15.2957C8.04442 15.7601 9.0148 16.0021 10 16C11.1867 16 12.3467 15.6481 13.3334 14.9888C14.3201 14.3295 15.0892 13.3925 15.5433 12.2961C15.9974 11.1997 16.1162 9.99334 15.8847 8.82946C15.6532 7.66557 15.0818 6.59647 14.2426 5.75736C13.4035 4.91824 12.3344 4.3468 11.1705 4.11529C10.0067 3.88378 8.80026 4.0026 7.70391 4.45672C6.60755 4.91085 5.67048 5.67988 5.01119 6.66658C4.3519 7.65327 4.00001 8.81331 4.00001 10C4.00001 11.0005 4.24376 11.9635 4.70501 12.8245L4.96676 13.3142L4.47551 15.5245L6.68576 15.0332V15.0332Z" fill="#99A0AE"/>
            </svg>
          </button>
          <button class="btn flex-grow-1 action-btn" onclick="window.handleStoryShareClick('${story.meta.zuid}', event)" data-bs-toggle="modal" data-bs-target="#shareModal">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7.75 3.25V4.75H4V15.25H16V8.5H17.5V16C17.5 16.1989 17.421 16.3897 17.2803 16.5303C17.1397 16.671 16.9489 16.75 16.75 16.75H3.25C3.05109 16.75 2.86032 16.671 2.71967 16.5303C2.57902 16.3897 2.5 16.1989 2.5 16V4C2.5 3.80109 2.57902 3.61032 2.71967 3.46967C2.86032 3.32902 3.05109 3.25 3.25 3.25H7.75ZM13 4.75V1.75L18.25 6.25H11.5C11.1022 6.25 10.7206 6.40804 10.4393 6.68934C10.158 6.97064 10 7.35218 10 7.75V12.25H8.5V7.75C8.5 6.95435 8.81607 6.19129 9.37868 5.62868C9.94129 5.06607 10.7044 4.75 11.5 4.75H13Z" fill="#99A0AE"/>
            </svg>
          </button>
        </div>
      </div>
    </div>`;
  }

  // ==================== TANSTACK QUERY OBSERVERS ====================

  // Create TanStack Query observers for different story statuses
  const approvedStoriesQuery = window.createStoriesQuery({
    npo: "{{$zuid}}",
    approved: "1",
    status: "approved",
  });

  const rejectedStoriesQuery = window.createStoriesQuery({
    npo: "{{$zuid}}",
    approved: "0",
    status: "rejected",
  });

  const pendingStoriesQuery = window.createStoriesQuery({
    npo: "{{$zuid}}",
    approved: "0",
    status: "pending",
  });

  // ==================== REACTIVE SUBSCRIPTIONS ====================

  // Subscribe to approved stories for reactive UI updates
  approvedStoriesQuery.subscribe((result) => {
    if (result.isLoading) {
      // Show skeleton while loading
      $("#approved .stories-list").html(createSkeletonPlaceholder(0));
    } else if (result.isSuccess) {
      const stories = result.data?.data || [];
      renderStoriesByStatus("approved", stories);
    } else if (result.isError) {
      $("#approved .stories-list").html(
        '<div class="col-12"><p class="text-danger">Error loading approved stories.</p></div>'
      );
    }
  });

  // Subscribe to rejected stories for reactive UI updates
  rejectedStoriesQuery.subscribe((result) => {
    if (result.isLoading) {
      // Show skeleton while loading
      $("#rejected .stories-list").html(createSkeletonPlaceholder(0));
    } else if (result.isSuccess) {
      const stories = result.data?.data || [];
      renderStoriesByStatus("rejected", stories);
    } else if (result.isError) {
      $("#rejected .stories-list").html(
        '<div class="col-12"><p class="text-danger">Error loading rejected stories.</p></div>'
      );
    }
  });

  // Subscribe to pending stories for reactive UI updates
  pendingStoriesQuery.subscribe((result) => {
    if (result.isLoading) {
      // Show skeleton while loading
      $("#to-review .stories-list").html(createSkeletonPlaceholder(0));
    } else if (result.isSuccess) {
      const stories = result.data?.data || [];
      renderStoriesByStatus("to-review", stories);
    } else if (result.isError) {
      $("#to-review .stories-list").html(
        '<div class="col-12"><p class="text-danger">Error loading pending stories.</p></div>'
      );
    }
  });

  // Subscribe to all queries for count updates
  const updateCountsFromQueries = () => {
    const approvedResult = approvedStoriesQuery.getCurrentResult();
    const rejectedResult = rejectedStoriesQuery.getCurrentResult();
    const pendingResult = pendingStoriesQuery.getCurrentResult();

    const approvedCount = approvedResult.isSuccess
      ? approvedResult.data?.data?.length || 0
      : 0;
    const rejectedCount = rejectedResult.isSuccess
      ? rejectedResult.data?.data?.length || 0
      : 0;
    const pendingCount = pendingResult.isSuccess
      ? pendingResult.data?.data?.length || 0
      : 0;

    // Update the counts in the tabs
    $("#approved-count").text(approvedCount);
    $("#rejected-count").text(rejectedCount);
    $("#to-review-count").text(pendingCount);

    // Update the review stories count card
    const streamReviewStoriesCard = $("#stream-review-stories-card");
    const reviewStoriesCount = $("#stream-review-stories-count");

    reviewStoriesCount.empty();
    reviewStoriesCount.append(
      `<h6 class="mb-0">Review ${pendingCount} New User Stories</h6>`
    );
    reviewStoriesCount.append(
      `<small class="text-muted">Approve or reject stories created by users for your non profit</small>`
    );

    if (pendingCount > 0) {
      streamReviewStoriesCard.removeClass("d-none");
    } else {
      streamReviewStoriesCard.addClass("d-none");
    }
  };

  // Subscribe to each query to update counts reactively
  approvedStoriesQuery.subscribe(() => updateCountsFromQueries());
  rejectedStoriesQuery.subscribe(() => updateCountsFromQueries());
  pendingStoriesQuery.subscribe(() => updateCountsFromQueries());

  // ==================== RENDER FUNCTIONS ====================

  async function renderStoriesByStatus(status, stories) {
    const storiesContainer = $(`#${status} .stories-list`);
    const containerSelector = `#${status} .stories-list`;

    if (!stories || stories.length === 0) {
      storiesContainer.html(
        '<div class="col-12"><p class="text-muted">No stories found.</p></div>'
      );
      return;
    }

    // Step 1: Create skeletons matching the number of stories
    storiesContainer.empty();
    stories.forEach((_, index) => {
      storiesContainer.append(createSkeletonPlaceholder(index));
    });

    // Step 2: Process and render stories progressively
    const renderPromises = stories.map((story, index) =>
      renderStoryCard(story, index, containerSelector)
    );

    // Wait for all stories to be rendered
    await Promise.all(renderPromises);

    // Step 3: Clean up rendered cards after animation
    setTimeout(() => {
      $(`${containerSelector} .story-card-rendered`).each(function () {
        $(this).removeClass("story-card-rendered");
      });
    }, 500);
  }

  // ==================== INITIALIZATION ====================

  $(document).ready(function () {
    // Handle tab changes - no need to manually load data, subscriptions handle it
    $('a[data-bs-toggle="tab"]').on("shown.bs.tab", function (e) {
      const tabId = $(e.target).attr("href").substring(1); // Gets the tab ID without #
      // Tab switching handled by subscriptions - no manual loading needed
    });

    // Load correct tab on initial page load based on hash
    const initialTab = window.location.hash.substring(1);
    if (
      initialTab &&
      ["approved", "rejected", "to-review"].includes(initialTab)
    ) {
      $(`a[href="#${initialTab}"]`).tab("show");
    }

    // No need for manual modal refresh - subscriptions handle reactive updates
    // When mutations invalidate queries, subscriptions automatically update UI
  });

  // ========== ACTION BUTTON HANDLERS ==========
  
  // Handle like button click
  async function handleLikeClick(storyZuid, event) {
    try {
      if (event) event.stopPropagation();
      
      const user = await new Promise((resolve) => {
        const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
          unsubscribe();
          resolve(user);
        });
      });
      
      if (!user) {
        alert("Please log in to like this story.");
        return;
      }
      
      const mutation = window.createUpdateStoryLikesMutation();
      mutation.mutate(storyZuid, {
        onSuccess: () => {
          console.log('Story like updated successfully');
        },
        onError: (error) => {
          console.error("Error updating story likes:", error);
          alert('Failed to update like. Please try again.');
        }
      });
    } catch (error) {
      console.error("Error updating story likes:", error);
    }
  }

  // Handle donate button click
  async function handleStoryDonateClick(npoZuid, donateLink, event) {
    if (event) event.stopPropagation();
    
    if (npoZuid) {
      const clickNpoDonateMutation = window.createClickNpoDonateMutation();
      clickNpoDonateMutation.mutate(npoZuid, {
        onError: (error) => {
          console.error("Error updating NPO donate clicks:", error);
        }
      });
    }
    
    if (donateLink) {
      window.open(donateLink, '_blank');
    }
  }

  // Handle share button click
  async function handleStoryShareClick(storyZuid, event) {
    if (event) event.stopPropagation();
    
    const updateStorySharesMutation = window.createUpdateStorySharesMutation();
    updateStorySharesMutation.mutate(storyZuid, {
      onError: (error) => {
        console.error("Error updating story shares:", error);
      }
    });
  }

  // Export functions to window for global access
  window.handleLikeClick = handleLikeClick;
  window.handleStoryDonateClick = handleStoryDonateClick;
  window.handleStoryShareClick = handleStoryShareClick;
  window.setupLikeButtonSubscription = setupLikeButtonSubscription;
</script>
