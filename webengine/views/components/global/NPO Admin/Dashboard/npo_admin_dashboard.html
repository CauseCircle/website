<style>
  .posts-container {
    max-height: 800px;
    overflow-y: auto;
    padding-right: 10px;
  }

  /* Custom scrollbar for posts container */
  .posts-container::-webkit-scrollbar {
    width: 6px;
  }

  .posts-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }

  .posts-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
  }

  .posts-container::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  .post-card {
    background: #fff;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    padding: 1.5rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .post-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .story-subtitle {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.5;
  }

  .post-card .story-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
  }

  .post-card .profile-image {
    width: 48px;
    height: 48px;
    object-fit: cover;
  }

  .post-interaction {
    display: flex;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .interaction-btn {
    color: #6c757d;
    text-decoration: none;
    font-size: 0.9rem;
    transition: color 0.2s ease;
  }

  .interaction-btn:hover {
    color: #0d6efd;
  }

  /* Hashtag styles */
  .hashtag-item {
    color: #7b3fee;
    text-decoration: none;
    font-size: 0.85rem;
    margin-right: 8px;
    cursor: pointer;
  }
  
  .hashtag-item:hover {
    text-decoration: underline;
    color: #5a2bb8;
  }

  .hashtags-container {
    margin-top: 8px;
    margin-bottom: 8px;
    line-height: 1.4;
  }

  .clickable {
    cursor: pointer;
  }

  .checklist-item {
    background: #fff;
    border: 1px solid #e6e6e6;
  }

  .checklist-item.hidden {
    display: none !important;
  }

  /* Smooth transitions for checklist items */
  .checklist-item {
    transition: opacity 0.3s ease, transform 0.3s ease, height 0.3s ease, margin 0.3s ease, padding 0.3s ease;
  }

  .checklist-item.hidden {
    opacity: 0;
    transform: translateY(-10px);
    height: 0;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }

  /* Ensure proper spacing when items are hidden */
  .checklist-item:not(.hidden) + .checklist-item:not(.hidden) {
    margin-top: 0.75rem;
  }

  /* Progress badge styles */
  #completionProgress {
    font-size: 0.75rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  /* Quick tips link styling */
  .bg-light a {
    color: var(--bs-primary);
    font-size: 0.875rem;
    font-weight: 600;
  }

  .checklist-icon-container {
    width: 32px;
    height: 32px;
  }

  /* Skeleton loader styles */
  .skeleton {
    animation: skeleton-loading 1.5s infinite ease-in-out;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    border-radius: 4px;
  }

  @keyframes skeleton-loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  .skeleton.skeleton-avatar { width: 48px; height: 48px; border-radius: 50%; }
  .skeleton.skeleton-title { height: 20px; width: 70%; }
  .skeleton.skeleton-text { height: 14px; width: 100%; }
  .skeleton.skeleton-text-short { height: 12px; width: 40%; }
  .skeleton.skeleton-image { width: 100%; height: 200px; border-radius: 8px; }
  .skeleton.skeleton-button { width: 90px; height: 32px; }

  /* Author section hover effect */
  .author-section:hover .author-name {
    color: var(--bs-primary) !important;
    transition: color 0.2s ease;
  }

  /* Story Card Styles - Mobile Only Version */
  .post-card {
    border-radius: 24px;
    overflow: hidden;
    background-color: #fff;
    box-shadow: 0px 8px 16px 4px #0E121B14;
    padding: 0;
    border: none;
    display: flex;
    flex-direction: column;
  }

  .post-header {
    display: flex;
    align-items: flex-start;
    padding: 12px 16px;
    gap: 12px;
    border-bottom: 1px solid #f1f1f1;
  }

  .profile-img {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
  }

  .post-meta {
    flex: 1;
    min-width: 0;
    overflow: visible;
  }

  .npo-name {
    font-size: 1rem;
    font-weight: 500;
    margin: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    white-space: normal;
    overflow: visible;
    text-overflow: clip;
  }

  .post-content {
    padding: 0 16px;
  }

  .story-carousel {
    border-radius: 12px !important;
    overflow: hidden;
  }

  /* Action Buttons Styling - Mobile Only */
  .post-actions {
    background-color: #ffffff;
    border-radius: 0 0 10px 10px;
    margin-top: auto;
  }

  .action-btn {
    padding: 12px 4px;
    color: #636363;
    font-weight: 400;
    transition: background-color 0.2s;
    border: none;
    background-color: transparent;
    font-size: 1.1rem;
  }

  .action-btn:hover {
    background-color: #f8f9fa;
  }

  .action-btn svg {
    margin-right: 0;
    vertical-align: middle;
  }

  .action-btn.liked {
    color: #7b3fee;
    font-weight: 500;
  }

  .action-btn.liked svg path {
    fill: #7b3fee;
  }

  /* Hide action button text on mobile, but show counters */
  .action-btn .action-label {
    display: none;
  }
  
  .action-btn .action-counter {
    display: inline;
    font-size: 0.9rem;
    margin-left: 4px;
  }
</style>

<div class="tab-pane fade show active" id="dashboard">
  <!-- Completion Checklist Skeleton -->
  <div id="completionChecklistSkeleton" class="card mb-3 p-3">
    <div class="skeleton skeleton-title mb-4" style="width: 200px; height: 24px;"></div>
    
    <div class="checklist-item d-flex align-items-center justify-content-between mb-3 p-3 rounded">
      <div class="d-flex align-items-center gap-3 w-100">
        <div class="skeleton" style="width: 32px; height: 32px; border-radius: 50%;"></div>
        <div style="flex-grow: 1;">
          <div class="skeleton skeleton-title mb-2" style="width: 40%;"></div>
          <div class="skeleton skeleton-text" style="width: 70%;"></div>
        </div>
      </div>
      <div class="skeleton skeleton-button" style="flex-shrink: 0;"></div>
    </div>
    <div class="checklist-item d-flex align-items-center justify-content-between mb-3 p-3 rounded">
      <div class="d-flex align-items-center gap-3 w-100">
        <div class="skeleton" style="width: 32px; height: 32px; border-radius: 50%;"></div>
        <div style="flex-grow: 1;">
          <div class="skeleton skeleton-title mb-2" style="width: 50%;"></div>
          <div class="skeleton skeleton-text" style="width: 80%;"></div>
        </div>
      </div>
      <div class="skeleton skeleton-button" style="flex-shrink: 0;"></div>
    </div>
    <div class="checklist-item d-flex align-items-center justify-content-between mb-3 p-3 rounded">
      <div class="d-flex align-items-center gap-3 w-100">
        <div class="skeleton" style="width: 32px; height: 32px; border-radius: 50%;"></div>
        <div style="flex-grow: 1;">
          <div class="skeleton skeleton-title mb-2" style="width: 45%;"></div>
          <div class="skeleton skeleton-text" style="width: 75%;"></div>
        </div>
      </div>
      <div class="skeleton skeleton-button" style="flex-shrink: 0;"></div>
    </div>
  </div>

  <!-- Completion Checklist -->
  <div id="completionChecklistCard" class="card mb-3 p-3 d-none">
    <div class="d-flex justify-content-between align-items-center w-100">
      <div class="d-flex align-items-center gap-2">
        <h5 class="mb-0">Completion Checklist</h5>
        <span id="completionProgress" class="badge bg-primary rounded-pill">0 items remaining</span>
      </div>
      <button class="btn btn-link p-0 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#completionChecklistCollapse" aria-expanded="true" aria-controls="completionChecklistCollapse" title="Toggle checklist">
        <i class="bi bi-chevron-down" id="completionChecklistChevron"></i>
      </button>
    </div>
    <div id="completionChecklistCollapse" class="collapse show w-100 mt-3">
      <!-- Simplified 4-item Checklist -->

      <!-- Verify Profile Details -->
      <div id="checklist-profile" class="checklist-item d-flex align-items-center justify-content-between mb-3 p-3 rounded">
        <div class="d-flex align-items-center gap-3">
          <span class="checklist-icon-container d-flex align-items-center justify-content-center rounded-circle">
            <i class="checklist-icon bi bi-person-badge fs-5"></i>
          </span>
          <div>
            <div class="fw-semibold">Verify your Organization's details</div>
            <div class="text-muted small">Review your organization's branding, logo, banner, EIN, mission, and etc.</div>
          </div>
        </div>
        <button class="btn btn-sm">Complete Profile</button>
      </div>

      <!-- Add your first story -->
      <div id="checklist-story" class="checklist-item d-flex align-items-center justify-content-between mb-3 p-3 rounded">
        <div class="d-flex align-items-center gap-3">
          <span class="checklist-icon-container d-flex align-items-center justify-content-center rounded-circle">
            <i class="checklist-icon bi bi-clock-history fs-5"></i>
          </span>
          <div>
            <div class="fw-semibold">Get started with your Org's first story</div>
            <div class="text-muted small">Share your first story to your organization's page.</div>
          </div>
        </div>
        <button class="btn btn-sm">Post a Story</button>
      </div>

      <!-- Set your story goal -->
      <div id="checklist-goal" class="checklist-item d-flex align-items-center justify-content-between mb-3 p-3 rounded">
        <div class="d-flex align-items-center gap-3">
          <span class="checklist-icon-container d-flex align-items-center justify-content-center rounded-circle">
            <i class="checklist-icon bi bi-flag fs-5"></i>
          </span>
          <div>
            <div class="fw-semibold">Add a Story goal</div>
            <div class="text-muted small">Set a goal for how many stories your org wants to publish per week.</div>
          </div>
        </div>
        <button class="btn btn-sm">Set Goal</button>
      </div>

      <!-- Invite your supporters -->
      <div id="checklist-invite" class="checklist-item d-flex align-items-center justify-content-between mb-3 p-3 rounded">
        <div class="d-flex align-items-center gap-3">
          <span class="checklist-icon-container d-flex align-items-center justify-content-center rounded-circle">
            <i class="checklist-icon bi bi-people fs-5"></i>
          </span>
          <div>
            <div class="fw-semibold">Invite your supporters</div>
            <div class="text-muted small">Share your CauseCircle profile with your supporters, so they can add their stories to your cause.</div>
          </div>
        </div>
        <button class="btn btn-sm">Invite</button>
      </div>

      <!-- Quick Tips -->
      <div class="mt-4 p-3 rounded bg-light d-flex align-items-start gap-3 bg-opacity-50">
        <span class="mt-1"><i class="bi bi-info-circle text-primary"></i></span>
        <div>
          <div class="fw-semibold mb-1">Quick Tips</div>
          <div class="text-muted small mb-1">
            Complete required items first to maximize your profile's visibility. High-quality images and compelling stories help attract more supporters. Optional items like events can further enhance your organization's presence
          </div>
          <a href="#" class="text-decoration-underline">Learn More</a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Today's Actions -->
  <div id="today-actions" class="card d-flex gap-3 mb-3 d-none">
    <div>
      <h5 class="mb-0">Today's actions</h5>
      <p class="text-muted">
        Complete these actions to grow your page 4x faster
      </p>
    </div>
    <div
      class="card d-flex flex-row justify-content-between align-items-center clickable"
      data-bs-toggle="modal"
      data-bs-target="#reviewStoriesModal"
    >
      <div class="d-flex gap-4 align-items-center">
        <div>
          <i class="bi bi-list-check fs-4"></i>
        </div>
        <div id="review-stories-count">
          <div class="skeleton skeleton-title mb-2" style="width: 250px;"></div>
          <div class="skeleton skeleton-text" style="width: 350px;"></div>
        </div>
      </div>
      <div class="btn btn-link">
        <i class="bi bi-arrow-right fs-4"></i>
      </div>
    </div>
  </div>

  <!-- Track Performance -->
  <div class="card d-flex gap-3 mb-3 d-none">
    <div>
      <h5 class="mb-0">Track Performance</h5>
      <p class="text-muted">Leverage these insights to grow your page</p>
    </div>
    <div class="row g-3">
      <div class="col-md-3">
        <div class="card">
          {{$followersCount = 0}}
          <!--prettier-ignore-->
          {{ each users as user where user.favorite_npos = '{$zuid}'}}
          {{$followersCount = {user._num} }}
          {{/each}}
          <div class="metric-value">0</div>
          <div class="metric-label">Followers</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          {{$storiesCount = 0}}
          <!--prettier-ignore-->
          {{ each stories as story where story.related_npos = '{$zuid}' }}
          {{$storiesCount = {story._num} }}
          {{/each}}
          <div class="metric-value">{{$storiesCount}}</div>
          <div class="metric-label">Stories</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="metric-value">0</div>
          <div class="metric-label">Story Impressions</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="metric-value">0</div>
          <div class="metric-label">Page Visitors</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Join the Conversation -->
  <div class="card d-flex gap-3 mb-3">
    <div class="d-flex justify-content-between align-items-center w-100">
      <div>
        <h5 class="mb-0">Join the Conversation</h5>
        <p class="text-muted mb-0 d-none d-md-block">
          Write comments and create awareness about your non profit
        </p>
      </div>
      <button class="btn btn-link p-0 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#joinConversationCollapse" aria-expanded="true" aria-controls="joinConversationCollapse" title="Toggle conversation">
        <i class="bi bi-chevron-down" id="joinConversationChevron"></i>
      </button>
    </div>
    <div id="joinConversationCollapse" class="collapse show w-100">
      <p class="text-muted d-md-none mt-2">
        Write comments and create awareness about your non profit
      </p>
      <!-- Posts Container -->
      <div class="posts-container">
        <div id="stories-scroll" class="row g-4 stories-grid">
          <!-- Story Skeleton -->
          <div class="col-12 col-md-6">
            <div class="post-card h-100 p-3">
              <div class="d-flex align-items-center mb-3">
                <div class="skeleton skeleton-avatar"></div>
                <div class="ms-3 w-100">
                  <div class="skeleton skeleton-title mb-2" style="width: 60%;"></div>
                  <div class="skeleton skeleton-text-short"></div>
                </div>
              </div>
              <div class="skeleton skeleton-title mb-2" style="width: 90%;"></div>
              <div class="skeleton skeleton-text mb-1"></div>
              <div class="skeleton skeleton-text mb-3" style="width: 95%;"></div>
              <div class="skeleton skeleton-image"></div>
            </div>
          </div>
          <!-- Story Skeleton -->
          <div class="col-12 col-md-6">
            <div class="post-card h-100 p-3">
              <div class="d-flex align-items-center mb-3">
                <div class="skeleton skeleton-avatar"></div>
                <div class="ms-3 w-100">
                  <div class="skeleton skeleton-title mb-2" style="width: 50%;"></div>
                  <div class="skeleton skeleton-text-short"></div>
                </div>
              </div>
              <div class="skeleton skeleton-title mb-2" style="width: 80%;"></div>
              <div class="skeleton skeleton-text mb-1"></div>
              <div class="skeleton skeleton-text mb-3" style="width: 90%;"></div>
              <div class="skeleton skeleton-image"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // ==================== TANSTACK QUERY SETUP ====================
  const npoZuid = "{{$zuid}}";

  // Create query observers for different story lists
  const pendingStoriesQuery = window.createStoriesQuery({
    npo: npoZuid,
    approved: '0',
    status: 'pending',
    limit: 9999
  });

  const approvedStoriesQuery = window.createStoriesQuery({
    npo: npoZuid,
    approved: '1',
    status: 'approved',
    limit: 9999
  });

  const allStoriesQuery = window.createStoriesQuery({
    npo: npoZuid,
    status: 'all',
    limit: 9999
  });

  const npoProfileQuery = window.createNPOProfileQuery(npoZuid);

  // Subscribe to pending stories query for "Review Stories" section
  pendingStoriesQuery.subscribe((result) => {
    const reviewStoriesCount = $("#review-stories-count");
    const modalReviewStoriesCount = $("#modal-review-stories-count");
    const todayActions = $("#today-actions");

    if (result.isLoading) {
      todayActions.removeClass("d-none");
      reviewStoriesCount.html(`
        <div class="skeleton skeleton-title mb-2" style="width: 250px;"></div>
        <div class="skeleton skeleton-text" style="width: 350px;"></div>
      `);
    } else if (result.isError) {
      console.error("Error loading pending stories:", result.error);
      reviewStoriesCount.html("<p>Error updating review stories display</p>");
      todayActions.addClass("d-none");
    } else if (result.isSuccess) {
      const stories = result.data?.data || [];

      // Update the review stories count on the dashboard
      reviewStoriesCount.empty();
      reviewStoriesCount.append(
        `<h6 class="mb-0">Review ${stories.length} New User Stories</h6>`
      );
      reviewStoriesCount.append(`<small class="text-muted"
        >Approve or reject stories created by users for your non
        profit</small>`);

      // Update the review stories count on the modal
      modalReviewStoriesCount.text(
        `You have ${stories.length} stories left to review`
      );

      if (stories.length > 0) {
        todayActions.removeClass("d-none");
      } else {
        todayActions.addClass("d-none");
      }
    }
  });

  window.getNewStoriesCount = function (zuid) {
    // Trigger refetch if needed
    return pendingStoriesQuery.refetch();
  };

  window.loadStories = function (zuid) {
    // Return cached pending stories or trigger refetch
    const currentState = pendingStoriesQuery.getCurrentResult();
    if (currentState.data) {
      return Promise.resolve(currentState.data?.data || []);
    }
    return pendingStoriesQuery.refetch().then(result => result.data?.data || []);
  };

  // Function to extract hashtags from story text
  function extractHashtagsFromText(text) {
    if (!text) return [];
    
    // Regular expression to find hashtags (#word)
    const hashtagRegex = /#[a-zA-Z0-9_]+/g;
    const hashtags = text.match(hashtagRegex);
    
    if (!hashtags || hashtags.length === 0) return [];
    
    // Remove duplicates and clean up
    const uniqueHashtags = [...new Set(hashtags.map(tag => tag.toLowerCase()))];
    
    return uniqueHashtags;
  }

  // Function to generate hashtag HTML for story cards
  function generateHashtagsHtml(storyText) {
    const hashtags = extractHashtagsFromText(storyText);
    
    if (hashtags.length === 0) return '';
    
    // Create hashtag HTML with proper links
    const hashtagsHtml = hashtags.map(hashtag => {
      const encodedHashtag = encodeURIComponent(hashtag);
      return `<a href="/stories/?search=${encodedHashtag}" class="hashtag-item" target="_blank" rel="noopener noreferrer">${hashtag}</a>`;
    }).join('');
    
    return `<div class="hashtags-container">${hashtagsHtml}</div>`;
  }

  // Function to detect if a URL is a video
  function isVideoUrl(url) {
    if (!url) return false;
    const videoPatterns = [
      /vimeo\.com\/video\/\d+/i,
      /vimeo\.com\/\d+/i,
      /player\.vimeo\.com\/video\/\d+/i,
      /youtube\.com\/watch\?v=/i,
      /youtu\.be\//i,
      /\.mp4$/i,
      /\.webm$/i,
      /\.ogg$/i,
      /\.mov$/i,
      /\.avi$/i
    ];
    return videoPatterns.some(pattern => pattern.test(url));
  }

  // Function to get video embed URL
  function getVideoEmbedUrl(url) {
    if (!url) return null;
    
    // Check if it's already a Vimeo player URL
    if (url.includes('player.vimeo.com/video/')) {
      return url.includes('?') ? url : `${url}?autoplay=0&loop=0&muted=0`;
    }
    
    // Vimeo regular URLs - handles both /video/ID and direct /ID formats
    const vimeoMatch = url.match(/vimeo\.com\/(?:video\/)?(\d+)/i);
    if (vimeoMatch) {
      return `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=0&loop=0&muted=0`;
    }
    
    // YouTube
    const youtubeMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/i);
    if (youtubeMatch) {
      return `https://www.youtube.com/embed/${youtubeMatch[1]}?autoplay=0&loop=0&muted=0`;
    }
    
    // Direct video files
    if (/\.(mp4|webm|ogg|mov|avi)$/i.test(url)) {
      return url;
    }

    return null;
  }

  // Function to create media element (image or video)
  function createMediaElement(mediaUrl, storyTitle) {
    if (!mediaUrl) {
      return `<img src="https://placehold.co/600x400?text=No+Image" class="story-image mb-3" alt="${storyTitle}">`;
    }

    const isVideo = isVideoUrl(mediaUrl);
    
    if (isVideo) {
      const embedUrl = getVideoEmbedUrl(mediaUrl);
      
      if (embedUrl) {
        if (embedUrl.includes('youtube.com') || embedUrl.includes('vimeo.com')) {
          // Embedded video (YouTube/Vimeo) - match image dimensions
          return `
            <div class="video-container mb-3" style="width: 100%; height: 200px; background-color: #000; border-radius: 8px; overflow: hidden;">
              <iframe style="width: 100%; height: 100%; object-fit: cover;" 
                      src="${embedUrl}" 
                      frameborder="0" 
                      allow="autoplay; fullscreen; picture-in-picture" 
                      allowfullscreen
                      title="${storyTitle}"></iframe>
            </div>
          `;
        } else {
          // Direct video file - match image dimensions
          return `
            <div class="video-container mb-3" style="width: 100%; height: 200px; background-color: #000; border-radius: 8px; overflow: hidden;">
              <video style="width: 100%; height: 100%; object-fit: cover;" 
                     controls 
                     preload="metadata" 
                     controlsList="nodownload">
                <source src="${embedUrl}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
          `;
        }
      }
    }
    
    // Default to image
    return `<img src="${mediaUrl}?width=200&auto=webp&quality=80&optimize=high" alt="${storyTitle}" class="story-image mb-3">`;
  }

  // Subscribe to approved stories query for "Your Stories" section
  approvedStoriesQuery.subscribe((result) => {
    const approvedStoriesContainer = $("#stories-scroll");

    if (result.isLoading) {
      approvedStoriesContainer.html(`
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      `);
    } else if (result.isError) {
      console.error("Error loading approved stories:", result.error);
      approvedStoriesContainer.html(`
        <div class="text-center py-4 text-danger">
          Error loading stories. Please try again later.
        </div>
      `);
    } else if (result.isSuccess) {
      const stories = result.data?.data || [];

      approvedStoriesContainer.empty();
      if (stories.length === 0) {
        approvedStoriesContainer.html(`
          <div class="text-center py-4 text-muted">
            No approved stories yet. Start by creating your first story!
          </div>
        `);
        return;
      }

      stories.forEach((story) => {
      // Determine media URL - handle both string and object formats
      let mediaUrl = '';
      if (typeof story?.story_image === 'string') {
        mediaUrl = story.story_image || '';
      } else if (story?.story_image?.data && story.story_image.data.length > 0) {
        mediaUrl = story.story_image.data[0]?.url || '';
      }

      // Create media element (image or video)
      const mediaElement = createMediaElement(mediaUrl, story?.title || '');

      approvedStoriesContainer.append(`
      <div class="col-12 col-md-6">
        <div class="post-card h-100" onclick="window.location.href='{{ $base_url }}${story?.meta?.web?.uri}'" style="cursor: pointer;">
          <!-- Post Header -->
          <div class="post-header" onclick="event.stopPropagation();">
            <img
              src="${(() => {
                const profileImage = story.author.data[0].profile_image;
                const placeholder = "https://www.gravatar.com/avatar/?d=mp";
                if (!profileImage) return placeholder;
                if (typeof profileImage === "string") {
                  return profileImage.trim() !== "" ? `${profileImage}?width=48` : placeholder;
                } else {
                  return `${profileImage.data?.[0]?.url}?width=48` || placeholder;
                }
              })()}"
              alt="Profile"
              class="profile-img"
            />
            <div class="post-meta">
              <h5 class="mb-0 npo-name">
                <a href="{{ $base_url }}${story.author.data[0].meta?.web?.uri || ''}" 
                   class="text-decoration-none text-dark fw-medium" 
                   target="_blank" 
                   onclick="event.stopPropagation()">
                  ${story.author.data[0].first_name} ${story.author.data[0].last_name}
                </a>
              </h5>
              <small class="text-muted">${formatTimeAgo(story.createdAt || story.meta?.createdAt || story.date_published)}</small>
            </div>
          </div>

          <!-- Story Image/Video -->
          <div class="px-3" style="position: relative;">
            ${mediaElement}
            ${
              story.npo_approved === "1"
                ? `<span class="badge" style="position: absolute; bottom: 32px; right: 32px; padding: 6px 12px; font-size: 0.85rem; font-weight: 500; background: #E0FAEC; border: 1px solid #FFFFFF; color: #178C4E;">Approved</span>`
                : ""
            }
          </div>

          <!-- Post Content -->
          <div class="post-content">
            <div class="text-muted mb-3 story-subtitle">
              ${story.story_body}
            </div>
            ${generateHashtagsHtml(story.story_body || '')}
          </div>

          <!-- Action Buttons -->
          <div class="post-actions d-flex" onclick="event.stopPropagation()">
            <button class="btn flex-grow-1 action-btn" id="dashboard-like-button-${story.meta.zuid}" data-story-zuid="${story.meta.zuid}" onclick="window.handleLikeClick('${story.meta.zuid}', event)">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11.95 7H16.75C17.1478 7 17.5294 7.15804 17.8107 7.43934C18.092 7.72065 18.25 8.10218 18.25 8.5V10.078C18.2502 10.274 18.212 10.4682 18.1375 10.6495L15.8162 16.2858C15.7596 16.4232 15.6634 16.5407 15.5399 16.6233C15.4164 16.706 15.2711 16.7501 15.1225 16.75H2.5C2.30109 16.75 2.11032 16.671 1.96967 16.5303C1.82902 16.3897 1.75 16.1989 1.75 16V8.5C1.75 8.30109 1.82902 8.11033 1.96967 7.96967C2.11032 7.82902 2.30109 7.75 2.5 7.75H5.1115C5.23157 7.75003 5.3499 7.72124 5.45653 7.66603C5.56315 7.61082 5.65497 7.53082 5.72425 7.43275L9.814 1.6375C9.8657 1.56424 9.94194 1.51192 10.0289 1.49005C10.1159 1.46817 10.2078 1.47818 10.288 1.51825L11.6485 2.1985C12.0314 2.38988 12.3372 2.70649 12.5153 3.09574C12.6933 3.48499 12.7329 3.92345 12.6273 4.33825L11.95 7ZM6.25 8.941V15.25H14.62L16.75 10.078V8.5H11.95C11.7215 8.49997 11.4961 8.44776 11.2909 8.34735C11.0857 8.24694 10.9062 8.10098 10.766 7.92062C10.6257 7.74026 10.5286 7.53025 10.4819 7.30662C10.4352 7.08299 10.4402 6.85166 10.4965 6.63025L11.1737 3.96925C11.1949 3.88625 11.1871 3.79849 11.1515 3.72058C11.1159 3.64266 11.0546 3.57929 10.978 3.541L10.4822 3.2935L6.94975 8.2975C6.76225 8.563 6.52225 8.7805 6.25 8.941V8.941ZM4.75 9.25H3.25V15.25H4.75V9.25Z" fill="#99A0AE"/>
              </svg>
            </button>
            <button id="dashboard-donate-button-${story.meta.zuid}" class="btn flex-grow-1 action-btn" style="border-radius: 0;" onclick="window.handleStoryDonateClick('${story.related_npos?.data?.[0]?.meta?.zuid || ''}', '${story.related_npos?.data?.[0]?.donate_link || ''}', event)">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15.25 11.5V13.75H17.5V15.25H15.2493L15.25 17.5H13.75L13.7493 15.25H11.5V13.75H13.75V11.5H15.25ZM16.1823 4.56775C17.8788 6.26875 17.9373 8.97775 16.3593 10.744L15.2943 9.6805C16.2925 8.5375 16.24 6.745 15.1203 5.6275C13.993 4.50325 12.1803 4.45525 11.0028 5.51275L10.0015 6.41125L8.99952 5.5135C7.81827 4.4545 6.00627 4.501 4.87902 5.629C3.76152 6.7465 3.70527 8.53525 4.73502 9.71725L11.059 16.0518L10 17.1138L3.64002 10.7448C2.06202 8.97775 2.12127 6.26425 3.81702 4.56775C5.51577 2.86975 8.23302 2.81275 10 4.39675C11.7618 2.815 14.4843 2.8675 16.1815 4.56775H16.1823Z" fill="#99A0AE"/>
              </svg>
            </button>
            <button id="dashboard-comment-button-${story.meta.zuid}" class="btn flex-grow-1 action-btn" style="border-radius: 0;" onclick="event.stopPropagation(); window.location.href='{{ $base_url }}${story?.meta?.web?.uri}'">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6.46826 16.618L2.50001 17.5L3.38201 13.5317C2.80116 12.4453 2.49815 11.232 2.50001 10C2.50001 5.85775 5.85776 2.5 10 2.5C14.1423 2.5 17.5 5.85775 17.5 10C17.5 14.1422 14.1423 17.5 10 17.5C8.76802 17.5019 7.55472 17.1988 6.46826 16.618V16.618ZM6.68576 15.0332L7.17551 15.2957C8.04442 15.7601 9.0148 16.0021 10 16C11.1867 16 12.3467 15.6481 13.3334 14.9888C14.3201 14.3295 15.0892 13.3925 15.5433 12.2961C15.9974 11.1997 16.1162 9.99334 15.8847 8.82946C15.6532 7.66557 15.0818 6.59647 14.2426 5.75736C13.4035 4.91824 12.3344 4.3468 11.1705 4.11529C10.0067 3.88378 8.80026 4.0026 7.70391 4.45672C6.60755 4.91085 5.67048 5.67988 5.01119 6.66658C4.3519 7.65327 4.00001 8.81331 4.00001 10C4.00001 11.0005 4.24376 11.9635 4.70501 12.8245L4.96676 13.3142L4.47551 15.5245L6.68576 15.0332V15.0332Z" fill="#99A0AE"/>
              </svg>
            </button>
            <button class="btn flex-grow-1 action-btn" onclick="window.handleStoryShareClick('${story.meta.zuid}', event)" data-bs-toggle="modal" data-bs-target="#shareModal">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.75 3.25V4.75H4V15.25H16V8.5H17.5V16C17.5 16.1989 17.421 16.3897 17.2803 16.5303C17.1397 16.671 16.9489 16.75 16.75 16.75H3.25C3.05109 16.75 2.86032 16.671 2.71967 16.5303C2.57902 16.3897 2.5 16.1989 2.5 16V4C2.5 3.80109 2.57902 3.61032 2.71967 3.46967C2.86032 3.32902 3.05109 3.25 3.25 3.25H7.75ZM13 4.75V1.75L18.25 6.25H11.5C11.1022 6.25 10.7206 6.40804 10.4393 6.68934C10.158 6.97064 10 7.35218 10 7.75V12.25H8.5V7.75C8.5 6.95435 8.81607 6.19129 9.37868 5.62868C9.94129 5.06607 10.7044 4.75 11.5 4.75H13Z" fill="#99A0AE"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
      `);
      
      // Set up reactive like button updates for this story
      setupLikeButtonSubscription(story.meta.zuid);
      });
    }
  });

  // Helper function to format dates as time ago
  function formatTimeAgo(dateString) {
    if (!dateString) return '';
    
    try {
      let date;
      
      // Check if dateString is already in ISO format (includes 'T' and ends with 'Z' or timezone)
      if (dateString.includes('T') && (dateString.includes('Z') || dateString.includes('+') || dateString.includes('-'))) {
        // ISO format with timezone info - parse directly
        date = new Date(dateString);
      } else {
        // Legacy format without timezone - treat as UTC
        date = new Date(dateString + ' UTC');
      }
      
      // Validate the date
      if (isNaN(date.getTime())) {
        throw new Error('Invalid date');
      }
      
      const now = new Date();
      const diffInMilliseconds = now - date;
      const diffInSeconds = Math.floor(diffInMilliseconds / 1000);
      const diffInMinutes = Math.floor(diffInSeconds / 60);
      const diffInHours = Math.floor(diffInMinutes / 60);
      const diffInDays = Math.floor(diffInHours / 24);
      const diffInMonths = Math.floor(diffInDays / 30);
      const diffInYears = Math.floor(diffInDays / 365);
      
      if (diffInSeconds < 60) {
        return diffInSeconds <= 1 ? 'just now' : `${diffInSeconds}s ago`;
      } else if (diffInMinutes < 60) {
        return `${diffInMinutes}m ago`;
      } else if (diffInHours < 24) {
        return `${diffInHours}h ago`;
      } else if (diffInDays < 30) {
        return `${diffInDays}d ago`;
      } else if (diffInMonths < 12) {
        return `${diffInMonths}mo ago`;
      } else {
        return `${diffInYears}y ago`;
      }
    } catch (error) {
      console.error('Error formatting time:', error, 'Input:', dateString);
      return '';
    }
  }

  // Backward compatibility function
  function formatDate(dateString) {
    return formatTimeAgo(dateString);
  }

  // Initial document ready
  $(document).ready(function () {
    // TanStack Query automatically loads data via subscriptions
    // No need to manually trigger on tab show - staleTime handles freshness
    
    // Link checklist buttons to profile tab or other actions
    $('#completionChecklistCollapse').on('click', '.checklist-item .btn', function (e) {
      e.preventDefault();
      const item = $(this).closest('.checklist-item');

      // Handle story action
      if (item.attr('id') === 'checklist-story') {
        const $createPostBtn = $('button#\x63\x72\x65\x61\x74\x65\x2d\x70\x6f\x73\x74\x2d\x62\x74\x6e');
        if ($createPostBtn.length) {
          $createPostBtn.trigger('click');
          return;
        }
        // Fallback: try opening a modal trigger if present
        const $modalTrigger = $('[data-bs-target="#createStoryModal"]');
        if ($modalTrigger.length) {
          $modalTrigger.trigger('click');
          return;
        }
        // Last resort fallback: open create-story page
        const currentPath = window.location.pathname;
        const adminPathIndex = currentPath.lastIndexOf('/admin');
        if (adminPathIndex !== -1) {
          const basePath = currentPath.substring(0, adminPathIndex);
          const newUrl = window.location.origin + basePath + '/create-story';
          window.location.href = newUrl;
        }
        return; // Stop other handlers
      }
      
      // Handle goal action
      if (item.attr('id') === 'checklist-goal') {
        const goalTab = $('a[data-bs-toggle="tab"][href="#story-goal"]');
        if (goalTab.length) {
          const tab = bootstrap.Tab.getInstance(goalTab[0]) || new bootstrap.Tab(goalTab[0]);
          tab.show();
        }
        return;
      }

      // Handle invite action
      if (item.attr('id') === 'checklist-invite') {
        const followersTab = $('a[data-bs-toggle="tab"][href="#followers"]');
        if (followersTab.length) {
          const tab = bootstrap.Tab.getInstance(followersTab[0]) || new bootstrap.Tab(followersTab[0]);
          tab.show();
          setTimeout(() => {
            const inviteModalEl = document.getElementById('inviteModal');
            if (inviteModalEl) {
              const inviteModal = new bootstrap.Modal(inviteModalEl);
              inviteModal.show();
            }
          }, 300);
        }
        return;
      }

      //Handle profile action
      if (item.attr('id') === 'checklist-profile') {
        const profileTab = $('a[data-bs-toggle="tab"][href="#profile"]');
        if (profileTab.length) {
          const tab = bootstrap.Tab.getInstance(profileTab[0]) || new bootstrap.Tab(profileTab[0]);
          tab.show();
          const data = window.updateNPOAdminProfile(
          "{{$zuid}}",
          {
            data: {
              organization_details_verified: true
            }
          }
        );
        }
      }
      
      // Default: open Profile tab
      // const profileTabTrigger = $('a[data-bs-toggle="tab"][href="#profile"], button[data-bs-toggle="tab"][data-bs-target="#profile"]');
      // if (profileTabTrigger.length) {
      //   const tab = bootstrap.Tab.getInstance(profileTabTrigger[0]) || new bootstrap.Tab(profileTabTrigger[0]);
      //   tab.show();
      // } else {
      //   console.error('Profile tab trigger not found.');
      // }
    });
    
    // Setup for checklist collapse icon
    const checklistCollapse = $('#completionChecklistCollapse');
    const checklistChevron = $('#completionChecklistChevron');
    checklistCollapse.on('show.bs.collapse', function () {
      checklistChevron.removeClass('bi-chevron-right').addClass('bi-chevron-down');
    });
    checklistCollapse.on('hide.bs.collapse', function () {
      checklistChevron.removeClass('bi-chevron-down').addClass('bi-chevron-right');
    });
  });

  // Function to get NPO Admin Profile
  async function getNPOAdminProfile(zuid) {
    if (window.CONFIG?.API_ROUTES?.["get-npo-admin-profile"]) {
      const url = window.CONFIG.API_ROUTES["get-npo-admin-profile"];
      const response = await fetch(`${url}/${zuid}`);
      return response.json();
    }
    console.error("Missing API configuration for getNPOAdminProfile.");
    return null;
  }

  // Function to reset progress badge
  function resetProgressBadge() {
    $("#completionProgress").removeClass("bg-success bg-warning").addClass("bg-primary");
    $("#completionProgress").text("0 items remaining");
  }

  // Function to update a single checklist item UI
  function updateChecklistItemUI(id, completed, buttonTexts) {
    const container = $(`#checklist-${id}`);
    const iconContainer = container.find('.checklist-icon-container');
    const icon = container.find('.checklist-icon');
    const button = container.find('.btn');

    // Always show items; style based on completion
    container.removeClass('hidden');
    if (completed) {
      iconContainer.removeClass('bg-white icon-border').addClass('bg-success bg-opacity-10');
      // Swap to green check icon when completed
      icon.attr('class', 'checklist-icon bi bi-check-circle-fill text-success');
      button.removeClass('btn-primary').addClass('btn-secondary').text(buttonTexts.completed || 'Edit');
    } else {
      iconContainer.removeClass('bg-success bg-opacity-10').addClass('bg-white icon-border');
      // Restore base icon for each checklist item
      const baseIconById = {
        profile: 'bi-person-badge',
        story: 'bi-clock-history',
        goal: 'bi-flag',
        invite: 'bi-people'
      };
      const baseIcon = baseIconById[id] || 'bi-circle';
      icon.attr('class', `checklist-icon bi ${baseIcon} text-muted`);
      button.removeClass('btn-secondary').addClass('btn-primary').html(`<i class="bi bi-plus me-1"></i> ${buttonTexts.incomplete}`);
    }
  }

  // Function to process NPO data and update checklist
  function updateCompletionChecklist(npoData, hasStories) {
    if (!npoData) {
      console.warn('No NPO data provided to updateCompletionChecklist');
      return 0;
    }

    // Reset progress badge and show all items initially
    resetProgressBadge();
    $('.checklist-item').removeClass('hidden');

    let incompleteCount = 0;

    const checkAndUpdate = (id, condition, buttonTexts) => {
      try {
        updateChecklistItemUI(id, condition, buttonTexts);
        if (!condition) {
          incompleteCount++;
        }
      } catch (error) {
        console.error(`Error updating checklist item ${id}:`, error);
        // Still count as incomplete if there's an error
        incompleteCount++;
      }
    };

    // Composite: Profile completion (all key fields)
    const hasLogo = !!(npoData.logo && (typeof npoData.logo === 'string' || npoData.logo?.data?.[0]?.url));
    const hasBanner = !!(npoData.hero_image && (typeof npoData.hero_image === 'string' || npoData.hero_image?.data?.[0]?.url));
    const hasEin = !!npoData.ein_number;
    const hasMission = !!npoData.mission;
    const hasDescription = !!npoData.cause_description;
    const hasWebsite = !!npoData.website;
    const hasDonation = !!npoData.donate_link;
    const hasLocation = !!npoData.headquarters_address;
    const hasCauses = !!(npoData.category?.data?.length > 0);
    const isProfileVerified = npoData.organization_details_verified === "1";
    const isProfileComplete = hasLogo && hasBanner && hasEin && hasMission && hasDescription && hasWebsite && hasDonation && hasLocation && hasCauses;

    // 1. Verify profile details
    checkAndUpdate('profile', isProfileVerified, { completed: 'Edit Profile', incomplete: 'Complete Profile' });

    // 2. Add your first story
    checkAndUpdate('story', hasStories, { completed: 'Edit', incomplete: 'Post a Story' });

    // 3. Set your story goal
    const hasGoal = !!(npoData.weekly_story_goal && parseInt(npoData.weekly_story_goal) > 0);
    checkAndUpdate('goal', hasGoal, { completed: 'Edit Goal', incomplete: 'Set Goal' });

    // 4. Invite your supporters (complete if any pending invites exist)
    const pendingInvites = (npoData?.pending_follower_invite || '').split(',').map(e => e.trim()).filter(Boolean);
    const hasSupporters = pendingInvites.length > 0;
    checkAndUpdate('invite', hasSupporters, { completed: 'Invite More', incomplete: 'Invite' });

    return incompleteCount;
  }

  // Function to update completion checklist UI based on profile and stories data
  function updateCompletionChecklistUI(profileData, allStoriesData) {
    const hasStories = allStoriesData && allStoriesData.length > 0;

    if (profileData) {
      try {
        const incompleteCount = updateCompletionChecklist(profileData, hasStories);
        if (incompleteCount > 0) {
          $("#completionChecklistCard").removeClass("d-none");
          $("#completionProgress").text(`${incompleteCount} item${incompleteCount === 1 ? '' : 's'} remaining`);
        } else {
          // Hide the entire completion checklist when all items are done
          $("#completionChecklistCard").addClass("d-none");
        }
      } catch (checklistError) {
        console.error('Error updating completion checklist:', checklistError);
      }
    }
  }

  // Subscribe to both profile and all stories queries for completion checklist
  let completionChecklistData = { profile: null, stories: null };

  npoProfileQuery.subscribe((result) => {
    if (result.isSuccess) {
      completionChecklistData.profile = result.data?.data?.[0];
      if (completionChecklistData.stories !== null) {
        updateCompletionChecklistUI(completionChecklistData.profile, completionChecklistData.stories);
      }
    }
  });

  allStoriesQuery.subscribe((result) => {
    if (result.isLoading) {
      // Show skeleton
      $("#completionChecklistSkeleton").removeClass("d-none");
      $("#completionChecklistCard").addClass("d-none");
    } else if (result.isSuccess) {
      // Hide skeleton
      $("#completionChecklistSkeleton").addClass("d-none");

      completionChecklistData.stories = result.data?.data || [];
      if (completionChecklistData.profile !== null) {
        updateCompletionChecklistUI(completionChecklistData.profile, completionChecklistData.stories);
      }
    } else if (result.isError) {
      console.error('Error loading all stories:', result.error);
      $("#completionChecklistSkeleton").addClass("d-none");
      $("#completionChecklistCard").addClass("d-none");
    }
  });

  // Function to refresh completion checklist
  window.refreshCompletionChecklist = function() {
    return Promise.all([
      npoProfileQuery.refetch(),
      allStoriesQuery.refetch()
    ]);
  };

  // Add a small script to rotate the chevron icon on collapse for Completion Checklist
  $(document).ready(function () {
    const checklistCollapse = $('#completionChecklistCollapse');
    const checklistChevron = $('#completionChecklistChevron');
    checklistCollapse.on('show.bs.collapse', function () {
      checklistChevron.removeClass('bi-chevron-right').addClass('bi-chevron-down');
    });
    checklistCollapse.on('hide.bs.collapse', function () {
      checklistChevron.removeClass('bi-chevron-down').addClass('bi-chevron-right');
    });
  });

  // ========== ACTION BUTTON HANDLERS ==========
  
  // Handle like button click
  async function handleLikeClick(storyZuid, event) {
    try {
      if (event) event.stopPropagation();
      
      const user = await new Promise((resolve) => {
        const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
          unsubscribe();
          resolve(user);
        });
      });
      
      if (!user) {
        alert("Please log in to like this story.");
        return;
      }
      
      const mutation = window.createUpdateStoryLikesMutation();
      mutation.mutate(storyZuid, {
        onSuccess: () => {
          console.log('Story like updated successfully');
        },
        onError: (error) => {
          console.error("Error updating story likes:", error);
          alert('Failed to update like. Please try again.');
        }
      });
    } catch (error) {
      console.error("Error updating story likes:", error);
    }
  }

  // Handle donate button click
  async function handleStoryDonateClick(npoZuid, donateLink, event) {
    if (event) event.stopPropagation();
    
    if (npoZuid) {
      const clickNpoDonateMutation = window.createClickNpoDonateMutation();
      clickNpoDonateMutation.mutate(npoZuid, {
        onError: (error) => {
          console.error("Error updating NPO donate clicks:", error);
        }
      });
    }
    
    if (donateLink) {
      window.open(donateLink, '_blank');
    }
  }

  // Handle share button click
  async function handleStoryShareClick(storyZuid, event) {
    if (event) event.stopPropagation();
    
    const updateStorySharesMutation = window.createUpdateStorySharesMutation();
    updateStorySharesMutation.mutate(storyZuid, {
      onError: (error) => {
        console.error("Error updating story shares:", error);
      }
    });
  }

  // Function to update like button from stats data
  function updateLikeButtonFromStats(statsData, likeButton) {
    const currentUser = JSON.parse(localStorage.getItem('user'));
    const isLiked = currentUser && statsData.likedBy?.some(user => 
      (user.user_zuid && user.user_zuid === currentUser.zuid) || 
      (user.id && user.id === currentUser.zuid)
    );
    const fillColor = isLiked ? '#7b3fee' : '#99A0AE';
    const likeCount = statsData.likedBy ? statsData.likedBy.length : 0;
    
    let buttonHTML = `
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M11.95 7H16.75C17.1478 7 17.5294 7.15804 17.8107 7.43934C18.092 7.72065 18.25 8.10218 18.25 8.5V10.078C18.2502 10.274 18.212 10.4682 18.1375 10.6495L15.8162 16.2858C15.7596 16.4232 15.6634 16.5407 15.5399 16.6233C15.4164 16.706 15.2711 16.7501 15.1225 16.75H2.5C2.30109 16.75 2.11032 16.671 1.96967 16.5303C1.82902 16.3897 1.75 16.1989 1.75 16V8.5C1.75 8.30109 1.82902 8.11033 1.96967 7.96967C2.11032 7.82902 2.30109 7.75 2.5 7.75H5.1115C5.23157 7.75003 5.3499 7.72124 5.45653 7.66603C5.56315 7.61082 5.65497 7.53082 5.72425 7.43275L9.814 1.6375C9.8657 1.56424 9.94194 1.51192 10.0289 1.49005C10.1159 1.46817 10.2078 1.47818 10.288 1.51825L11.6485 2.1985C12.0314 2.38988 12.3372 2.70649 12.5153 3.09574C12.6933 3.48499 12.7329 3.92345 12.6273 4.33825L11.95 7ZM6.25 8.941V15.25H14.62L16.75 10.078V8.5H11.95C11.7215 8.49997 11.4961 8.44776 11.2909 8.34735C11.0857 8.24694 10.9062 8.10098 10.766 7.92062C10.6257 7.74026 10.5286 7.53025 10.4819 7.30662C10.4352 7.08299 10.4402 6.85166 10.4965 6.63025L11.1737 3.96925C11.1949 3.88625 11.1871 3.79849 11.1515 3.72058C11.1159 3.64266 11.0546 3.57929 10.978 3.541L10.4822 3.2935L6.94975 8.2975C6.76225 8.563 6.52225 8.7805 6.25 8.941V8.941ZM4.75 9.25H3.25V15.25H4.75V9.25Z" fill="${fillColor}"/>
      </svg>
    `;
    
    if (likeCount > 0) {
      buttonHTML += `<span class="action-counter">${likeCount}</span>`;
    }
    // No label needed as this is mobile-only view
    
    likeButton.html(buttonHTML);
    
    if (isLiked) {
      likeButton.addClass('liked');
    } else {
      likeButton.removeClass('liked');
    }
  }

  // Function to set up like button subscription for a story
  function setupLikeButtonSubscription(storyZuid) {
    const storyStatsQuery = window.createStoryStatsQuery(storyZuid);
    
    // Subscribe to changes
    const unsubscribe = storyStatsQuery.subscribe((result) => {
      if (result.isSuccess && result.data?.data) {
        const likeButton = $(`#dashboard-like-button-${storyZuid}`);
        if (likeButton.length > 0) {
          updateLikeButtonFromStats(result.data.data, likeButton);
        }
      }
    });
    
    // Trigger initial fetch to get current state
    storyStatsQuery.refetch();
    
    return unsubscribe;
  }

  // Export functions to window for global access
  window.handleLikeClick = handleLikeClick;
  window.handleStoryDonateClick = handleStoryDonateClick;
  window.handleStoryShareClick = handleStoryShareClick;
  window.setupLikeButtonSubscription = setupLikeButtonSubscription;
</script>

