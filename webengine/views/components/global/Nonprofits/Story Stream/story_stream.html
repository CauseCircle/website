<style>
  /* Theme Variables */
  :root {
    /* Light Theme (Default) */
    --bg-primary: #fefefe;
    --bg-gradient-start: rgba(123, 63, 238, 0.02);
    --bg-gradient-mid: rgba(255, 255, 255, 0.8);
    --bg-gradient-end: rgba(123, 63, 238, 0.01);
    --bg-overlay-primary: rgba(0, 0, 0, 0.02);
    --bg-overlay-secondary: rgba(0, 0, 0, 0.08);
    --bg-accent-1: rgba(123, 63, 238, 0.03);
    --bg-accent-2: rgba(123, 63, 238, 0.02);
    --bg-highlight-1: rgba(255, 255, 255, 0.4);
    --bg-highlight-2: rgba(123, 63, 238, 0.02);
    --bg-highlight-3: rgba(255, 255, 255, 0.1);
    
    /* Story Overlay Colors */
    --overlay-bg: #1a1a1a;
    --overlay-text: #ffffff;
    --overlay-text-secondary: #e0e0e0;
    --overlay-border: rgba(255, 255, 255, 0.1);
    --overlay-scrollbar-track: rgba(255, 255, 255, 0.1);
    --overlay-scrollbar-thumb: linear-gradient(180deg, rgba(123, 63, 238, 0.8) 0%, rgba(157, 94, 255, 0.6) 100%);
    
    /* Standard ambient shadows for light mode */
    --ambient-shadow-multiplier: 1;
  }

  [data-theme="dark"] {
    /* Dark Theme */
    --bg-primary: #0f0f14;
    --bg-gradient-start: rgba(20, 20, 25, 0.8);
    --bg-gradient-mid: rgba(15, 15, 20, 0.9);
    --bg-gradient-end: rgba(10, 10, 15, 0.8);
    --bg-overlay-primary: rgba(255, 255, 255, 0.02);
    --bg-overlay-secondary: rgba(255, 255, 255, 0.12);
    --bg-accent-1: rgba(123, 63, 238, 0.12);
    --bg-accent-2: rgba(157, 94, 255, 0.08);
    --bg-highlight-1: rgba(123, 63, 238, 0.05);
    --bg-highlight-2: rgba(157, 94, 255, 0.03);
    --bg-highlight-3: rgba(255, 255, 255, 0.02);
    
    /* Story Overlay Colors for Dark Theme */
    --overlay-bg: #2a2a2f;
    --overlay-text: #ffffff;
    --overlay-text-secondary: #e0e0e0;
    --overlay-border: rgba(255, 255, 255, 0.15);
    --overlay-scrollbar-track: rgba(255, 255, 255, 0.15);
    --overlay-scrollbar-thumb: linear-gradient(180deg, rgba(123, 63, 238, 0.9) 0%, rgba(157, 94, 255, 0.7) 100%);
    
    /* Enhanced ambient shadows for dark mode */
    --ambient-shadow-multiplier: 2.5;
  }

  .story-stream-background {
    min-height: 100vh;
    width: 100%;
    overflow-x: hidden;
    background: 
      linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%),
      linear-gradient(90deg, transparent 0%, var(--bg-overlay-primary) 50%, transparent 100%),
      radial-gradient(circle at 20% 80%, var(--bg-accent-1) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, var(--bg-accent-2) 0%, transparent 50%),
      var(--bg-primary);
    background-size: 100% 100%, 100% 100%, 800px 800px, 600px 600px, 100% 100%;
    position: relative;
    transition: background 0.3s ease;
  }

  .story-stream-background::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
      radial-gradient(circle at 30% 30%, var(--bg-highlight-1) 0%, transparent 40%),
      radial-gradient(circle at 70% 70%, var(--bg-highlight-2) 0%, transparent 50%),
      linear-gradient(45deg, var(--bg-highlight-3) 0%, transparent 100%);
    pointer-events: none;
    z-index: 0;
    transition: background 0.3s ease;
  }

  .story-stream-background::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
      repeating-linear-gradient(0deg, transparent, transparent 78px, var(--bg-overlay-secondary) 80px, var(--bg-overlay-secondary) 84px),
      repeating-linear-gradient(90deg, transparent, transparent 78px, var(--bg-overlay-secondary) 80px, var(--bg-overlay-secondary) 84px),
      radial-gradient(ellipse at center, transparent 30%, rgba(0, 0, 0, 0.3) 70%, rgba(0, 0, 0, 0.6) 100%);
    background-size: 80px 80px, 80px 80px, 100% 100%;
    filter: blur(2px);
    opacity: 0.6;
    pointer-events: none;
    z-index: 0;
    transition: background-image 0.3s ease, opacity 0.3s ease;
    mask: radial-gradient(ellipse at center, black 20%, rgba(0, 0, 0, 0.8) 50%, rgba(0, 0, 0, 0.3) 80%, transparent 100%);
    -webkit-mask: radial-gradient(ellipse at center, black 20%, rgba(0, 0, 0, 0.8) 50%, rgba(0, 0, 0, 0.3) 80%, transparent 100%);
  }

  .story-stream-container,
  .story-stream-loading {
    width: 100%;
    max-width: 1140px;
    margin: 0 auto;
    padding: 1rem;
    height: 100vh;
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    box-sizing: border-box;
  }

  .story-stream-loading {
    animation: skeleton-pulse 2s ease-in-out infinite;
  }
  
  .story-stream-empty {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 2rem;
    color: var(--overlay-text-secondary);
    text-align: center;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay-bg);
    z-index: 2;
    box-sizing: border-box;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  
  .story-stream-empty h3 {
    margin-bottom: 1rem;
    font-size: 1.5rem;
    color: var(--overlay-text);
    font-weight: 600;
    transition: color 0.3s ease;
  }
  
  .story-stream-empty p {
    opacity: 0.8;
    line-height: 1.5;
    max-width: 300px;
    font-size: 0.9rem;
  }
  
  .event-banner {
    background: linear-gradient(135deg, #6a35ce 0%, #8c4ee5 50%, #a36cf5 100%);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    box-shadow: 
      0 20px 40px rgba(123, 63, 238, 0.4),
      0 8px 32px rgba(123, 63, 238, 0.3),
      0 0 60px rgba(123, 63, 238, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
    width: 100%;
    max-width: 100%;
    flex-shrink: 0;
    box-sizing: border-box;
    overflow: hidden;
    position: relative;
    transition: all 0.8s ease;
    backdrop-filter: blur(10px);
  }

  .event-banner::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
      radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
      linear-gradient(45deg, transparent 0%, rgba(255, 255, 255, 0.05) 50%, transparent 100%);
    pointer-events: none;
    z-index: 1;
  }

  .event-banner::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: 
      conic-gradient(from 0deg at 50% 50%, 
        transparent 0deg, 
        rgba(255, 255, 255, 0.03) 60deg, 
        transparent 120deg, 
        rgba(255, 255, 255, 0.03) 180deg, 
        transparent 240deg, 
        rgba(255, 255, 255, 0.03) 300deg, 
        transparent 360deg);
    animation: rotate-glow 20s linear infinite;
    pointer-events: none;
    z-index: 0;
  }

  @keyframes rotate-glow {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .event-banner.ambient-glow {
    box-shadow: 
      0 20px 40px var(--ambient-color-primary, rgba(123, 63, 238, 0.4)),
      0 8px 32px var(--ambient-color-secondary, rgba(123, 63, 238, 0.3)),
      0 0 calc(60px * var(--ambient-shadow-multiplier, 1)) var(--ambient-color-tertiary, rgba(123, 63, 238, 0.2)),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }
  
  .event-banner-content {
    flex: 1;
    min-width: 0;
    padding-right: 2rem;
    position: relative;
    z-index: 2;
  }
  
  .event-date {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  
  .event-day {
    font-size: 1rem;
    font-weight: 600;
    opacity: 0.95;
    white-space: nowrap;
    letter-spacing: 0.5px;
  }
  
  .event-status {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    white-space: nowrap;
    box-shadow: 
      0 4px 8px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: hidden;
  }

  .event-status::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    animation: shimmer 2s infinite;
  }

  @keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
  }

  /* Status-specific styling */
  .event-status.status-active {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.9) 0%, rgba(16, 185, 129, 0.8) 100%);
    border-color: rgba(34, 197, 94, 0.4);
    box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
  }

  .event-status.status-upcoming {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.8) 100%);
    border-color: rgba(59, 130, 246, 0.4);
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
  }

  .event-status.status-ended {
    background: linear-gradient(135deg, rgba(107, 114, 128, 0.9) 0%, rgba(75, 85, 99, 0.8) 100%);
    border-color: rgba(107, 114, 128, 0.4);
    box-shadow: 0 0 20px rgba(107, 114, 128, 0.3);
  }

  .event-status.status-disabled {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.8) 100%);
    border-color: rgba(239, 68, 68, 0.4);
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
  }

  .event-status.status-pending {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.9) 0%, rgba(217, 119, 6, 0.8) 100%);
    border-color: rgba(245, 158, 11, 0.4);
    box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
  }
  
  .event-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin: 1rem 0;
    line-height: 1.1;
    color: white;
    word-wrap: break-word;
    overflow-wrap: break-word;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }
  
  .event-tags {
    margin-top: 1.5rem;
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }
  
  .event-tag {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.25);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .event-tag i {
    font-size: 0.8rem;
    opacity: 0.9;
  }


  
  .event-cta {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    text-align: center;
    flex-shrink: 0;
    position: relative;
    z-index: 2;
  }
  
  .event-cta-content {
    text-align: center;
  }
  
  .event-cta-content h3 {
    font-size: 1.4rem;
    font-weight: 800;
    margin: 0 0 0.75rem 0;
    color: white;
    white-space: nowrap;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }
  
  .event-cta-content p {
    font-size: 0.9rem;
    margin: 0;
    opacity: 0.95;
    line-height: 1.4;
    white-space: nowrap;
    font-weight: 500;
  }
  
  .event-qr {
    background: white;
    padding: 1rem;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
    position: relative;
  }
  
  .event-qr img {
    display: none;
  }
  
  .event-qr::after {
    content: '';
    display: block;
    width: 140px;
    height: 140px;
    border-radius: 16px;
    background: linear-gradient(135deg, #e91e63 0%, #9c27b0 25%, #673ab7 50%, #3f51b5 75%, #2196f3 100%);
    -webkit-mask: url("https://api.causecircle.org/npos/{{$zuid}}/qrcode?type=svg&mode=serve") no-repeat center;
    mask: url("https://api.causecircle.org/npos/{{$zuid}}/qrcode?type=svg&mode=serve") no-repeat center;
    -webkit-mask-size: contain;
    mask-size: contain;
    transition: all 0.3s ease;
  }

  .event-qr:hover::after {
    transform: scale(1.05);
  }
  
  .story-stream-carousel {
    height: calc(100vh - 200px);
    max-height: 600px;
    min-height: 400px;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 
      0 8px 32px rgba(0, 0, 0, 0.4),
      0 0 60px rgba(123, 63, 238, 0.15),
      0 0 120px rgba(123, 63, 238, 0.08);
    width: 100%;
    max-width: 100%;
    flex: 1;
    box-sizing: border-box;
    position: relative;
    transition: box-shadow 0.8s ease;
  }

  .story-stream-carousel.ambient-glow {
    box-shadow: 
      0 8px 32px rgba(0, 0, 0, 0.4),
      0 0 calc(60px * var(--ambient-shadow-multiplier, 1)) var(--ambient-color-primary, rgba(123, 63, 238, 0.15)),
      0 0 calc(120px * var(--ambient-shadow-multiplier, 1)) var(--ambient-color-secondary, rgba(123, 63, 238, 0.08)),
      0 0 calc(200px * var(--ambient-shadow-multiplier, 1)) var(--ambient-color-tertiary, rgba(123, 63, 238, 0.04));
  }
  
  .story-stream-carousel .carousel-inner {
    height: 100%;
  }
  
  .story-stream-carousel .carousel-item {
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    opacity: 0;
    transition: opacity 0.6s ease-in-out;
    transform: none !important;
    display: flex;
    flex-direction: row;
    background: #000;
  }
  
  .story-stream-carousel .carousel-item.active {
    position: relative;
    opacity: 1;
  }
  
  .story-media-container {
    position: relative;
    flex: 1;
    width: 60%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
  }
  
  .story-media-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    filter: blur(40px) saturate(1.5) brightness(0.5);
    transform: scale(1.1);
    z-index: 1;
  }
  
  .story-media {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    position: relative;
    z-index: 2;
  }
  
  .story-media.contain {
    object-fit: contain;
    object-position: center;
  }
  
  /* Improved image scaling for mobile */
  @media (max-width: 767px) {
    .story-media {
      object-fit: cover;
      object-position: center;
    }
    
    .story-media.contain {
      object-fit: contain;
      object-position: center;
    }
  }
  
  .story-overlay {
    position: relative;
    width: 40%;
    background: var(--overlay-bg);
    color: var(--overlay-text);
    z-index: 2;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  
  .story-header {
    padding: 1.5rem 1.5rem 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    border-bottom: 1px solid var(--overlay-border);
    flex-shrink: 0;
    transition: border-color 0.3s ease;
  }
  
  .story-scrollable-content {
    flex: 1;
    padding: 1rem 1.5rem 1.5rem 1.5rem;
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: rgba(123, 63, 238, 0.6) var(--overlay-scrollbar-track);
  }

  /* Custom Scrollbar for Webkit browsers */
  .story-scrollable-content::-webkit-scrollbar {
    width: 8px;
  }

  .story-scrollable-content::-webkit-scrollbar-track {
    background: var(--overlay-scrollbar-track);
    border-radius: 4px;
    margin: 4px 0;
    transition: background 0.3s ease;
  }

  .story-scrollable-content::-webkit-scrollbar-thumb {
    background: var(--overlay-scrollbar-thumb);
    border-radius: 4px;
    border: 1px solid var(--overlay-border);
    transition: all 0.3s ease;
  }

  .story-scrollable-content::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, rgba(123, 63, 238, 1) 0%, rgba(157, 94, 255, 0.8) 100%);
    border-color: rgba(255, 255, 255, 0.2);
    transform: scaleX(1.2);
  }

  .story-scrollable-content::-webkit-scrollbar-thumb:active {
    background: linear-gradient(180deg, rgba(123, 63, 238, 1) 0%, rgba(157, 94, 255, 1) 100%);
  }

  /* Scrollbar corner styling */
  .story-scrollable-content::-webkit-scrollbar-corner {
    background: transparent;
  }

  /* Smooth scrolling behavior */
  .story-scrollable-content,
  .skeleton-content {
    scroll-behavior: smooth;
  }

  /* Subtle gradient fade effect for scrollable content */
  .story-scrollable-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 20px;
    background: linear-gradient(180deg, var(--overlay-bg) 0%, transparent 100%);
    pointer-events: none;
    z-index: 1;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .story-scrollable-content::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 20px;
    background: linear-gradient(0deg, var(--overlay-bg) 0%, transparent 100%);
    pointer-events: none;
    z-index: 1;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  /* Show fade effects when scrolling */
  .story-scrollable-content.scrolling-top::before {
    opacity: 1;
  }

  .story-scrollable-content.scrolling-bottom::after {
    opacity: 1;
  }
  
  .story-author-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .story-author-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255, 255, 255, 0.2);
    flex-shrink: 0;
  }
  
  .story-author-details {
    min-width: 0;
    flex: 1;
  }
  
  .story-author-details h5 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .story-author-details p {
    margin: 0;
    font-size: 0.85rem;
    opacity: 0.8;
    color: #ccc;
  }
  
  .story-content h3 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    line-height: 1.3;
    color: #fff;
    word-wrap: break-word;
    overflow-wrap: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .story-content p {
    font-size: 0.9rem;
    opacity: 0.9;
    line-height: 1.5;
    margin-bottom: 1rem;
    color: #e0e0e0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 10;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .story-controls {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 1060;
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  
  .story-stream-carousel:hover .story-controls {
    opacity: 1;
    visibility: visible;
  }
  
  .story-control-btn {
    background: rgba(0, 0, 0, 0.6);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
  }
  
  .story-control-btn:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: scale(1.05);
  }
  
  .story-control-btn i {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
  }
  
  .story-control-btn.morphing i {
    transform: scale(0) rotate(180deg);
    opacity: 0;
  }
  
  .theme-toggle-btn {
    background: rgba(0, 0, 0, 0.6);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
  }

  .theme-toggle-btn:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: scale(1.05);
  }
  
  .theme-toggle-btn i {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
  }
  
  .theme-toggle-btn.morphing i {
    transform: scale(0) rotate(180deg);
    opacity: 0;
  }
  
  .story-progress-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    z-index: 1060;
  }
  
  .story-progress-fill {
    height: 100%;
    background: #7b3fee;
    width: 0%;
    transition: width 0.1s linear;
  }
  
  .story-indicators {
    position: absolute;
    top: 1rem;
    left: 1rem;
    right: 60px;
    z-index: 1060;
    display: flex;
    gap: 0.25rem;
    max-width: calc(60% - 80px);
    width: auto;
  }
  
  .story-indicator {
    flex: 1;
    height: 3px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    overflow: hidden;
    cursor: pointer;
  }
  
  .story-indicator.active .story-indicator-fill {
    width: 100%;
  }
  
  .story-indicator-fill {
    height: 100%;
    background: white;
    width: 0%;
    transition: width 7s linear;
  }
  
  .story-stats {
    display: flex;
    gap: 1rem;
    flex-shrink: 0;
  }
  
  .story-stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.85rem;
    font-weight: 500;
  }
  
  .story-stat i {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.9);
  }
  
  .story-stat-number {
    color: white;
    font-weight: 600;
  }
  
  /* Video container styling */
  .story-video-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
    z-index: 2;
  }
  
  .story-video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    position: relative;
    z-index: 2;
  }
  
  /* Hide default Bootstrap carousel controls */
  .story-stream-carousel .carousel-control-prev,
  .story-stream-carousel .carousel-control-next,
  .story-stream-carousel .carousel-indicators {
    display: none;
  }
  
  /* Custom navigation arrows */
  .story-navigation {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1060;
  }
  
  .story-nav-prev {
    left: -60px;
  }
  
  .story-nav-next {
    right: -60px;
  }
  
  .story-nav-btn {
    background: rgba(0, 0, 0, 0.6);
    border: none;
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    opacity: 0.8;
  }
  
  .story-nav-btn:hover {
    background: rgba(0, 0, 0, 0.8);
    opacity: 1;
  }

  /* Skeleton loader styles */
  .skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 4px;
  }

  @keyframes skeleton-loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  @keyframes skeleton-pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.95;
    }
  }

  /* Skeleton components */
  .skeleton-event-banner {
    background: linear-gradient(135deg, #7b3fee 0%, #9d5eff 100%);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    width: 100%;
    flex-shrink: 0;
    box-shadow: 
      0 8px 32px rgba(123, 63, 238, 0.3),
      0 0 60px rgba(123, 63, 238, 0.15),
      0 0 120px rgba(123, 63, 238, 0.08);
    box-sizing: border-box;
  }

  .skeleton-banner-text {
    background: linear-gradient(90deg, rgba(255,255,255,0.3) 25%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0.3) 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 4px;
  }

  .skeleton-banner-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    gap: 1rem;
  }

  .skeleton-banner-left {
    flex: 1;
    min-width: 0;
  }

  .skeleton-banner-right {
    display: flex;
    align-items: center;
    flex-shrink: 0;
  }

  .skeleton-banner-cta {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .skeleton-cta-text {
    text-align: center;
  }

  .skeleton-qr {
    width: 128px;
    height: 128px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    position: relative;
    flex-shrink: 0;
  }

  .skeleton-qr::after {
    content: '';
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    width: 128px;
    height: 128px;
    background: linear-gradient(90deg, #e91e63 25%, #9c27b0 50%, #673ab7 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    border-radius: 12px;
    opacity: 0.8;
  }

  .skeleton-carousel {
    width: 100%;
    height: calc(100vh - 200px);
    max-height: 600px;
    min-height: 400px;
    border-radius: 16px;
    flex: 1;
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    box-sizing: border-box;
  }

  .skeleton-carousel-layout {
    display: flex;
    height: 100%;
  }

  .skeleton-media {
    width: 60%;
    height: 100%;
    background: linear-gradient(90deg, #e0e0e0 25%, #d0d0d0 50%, #e0e0e0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
  }

  .skeleton-content {
    width: 40%;
    height: 100%;
    background: var(--overlay-bg);
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    transition: background-color 0.3s ease;
  }
  
  .skeleton-header {
    padding: 1.5rem 1.5rem 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    border-bottom: 1px solid var(--overlay-border);
    flex-shrink: 0;
    transition: border-color 0.3s ease;
  }
  
  .skeleton-scrollable-content {
    flex: 1;
    padding: 1rem 1.5rem 1.5rem 1.5rem;
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: rgba(123, 63, 238, 0.6) var(--overlay-scrollbar-track);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* Custom Scrollbar for Skeleton Content */
  .skeleton-scrollable-content::-webkit-scrollbar {
    width: 8px;
  }

  .skeleton-scrollable-content::-webkit-scrollbar-track {
    background: var(--overlay-scrollbar-track);
    border-radius: 4px;
    margin: 4px 0;
    transition: background 0.3s ease;
  }

  .skeleton-scrollable-content::-webkit-scrollbar-thumb {
    background: var(--overlay-scrollbar-thumb);
    border-radius: 4px;
    border: 1px solid var(--overlay-border);
    transition: all 0.3s ease;
  }

  .skeleton-scrollable-content::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, rgba(123, 63, 238, 1) 0%, rgba(157, 94, 255, 0.8) 100%);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .skeleton-author-section {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .skeleton-author-text {
    flex: 1;
    min-width: 0;
  }

  .skeleton-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
    flex-shrink: 0;
  }

  .skeleton-author-name {
    height: 18px;
    width: 100px;
    margin-bottom: 0.5rem;
    background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
  }

  .skeleton-author-time {
    height: 14px;
    width: 60px;
    background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
  }

  .skeleton-story-section {
    flex: 1;
  }

  .skeleton-story-title {
    height: 32px;
    width: 90%;
    margin-bottom: 0.75rem;
    background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
  }

  .skeleton-story-body {
    margin-bottom: 1rem;
  }

  .skeleton-body-line {
    height: 14px;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
  }

  .skeleton-stats {
    display: flex;
    gap: 1rem;
    margin-top: auto;
  }

  .skeleton-stat {
    height: 18px;
    width: 50px;
    background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
  }

  /* Enhanced responsive breakpoints */
  
     /* Extra Large screens (1400px+) */
   @media (min-width: 1400px) {
     .story-stream-container,
     .story-stream-loading {
       max-width: 1200px;
       padding: 2rem;
     }
     
     .event-banner,
    .skeleton-event-banner {
      padding: 2rem;
    }
    
     .event-title {
       font-size: 2.5rem;
     }
     
     .event-qr::after,
     .skeleton-qr {
       width: 140px;
       height: 140px;
     }
     
     .skeleton-qr::after {
       width: 140px;
       height: 140px;
     }
     
     .story-stream-carousel,
     .skeleton-carousel {
       height: calc(100vh - 280px);
       max-height: 700px;
     }
     
     .story-stream-carousel .carousel-item {
       height: 100%;
     }
     
     .story-overlay,
     .skeleton-content {
       padding: 2rem;
     }
     
     .story-content h3 {
       font-size: 1.75rem;
     }
     
     .story-content p {
       font-size: 1rem;
     }
   }

     /* Large screens (1200px - 1399px) */
   @media (min-width: 1200px) and (max-width: 1399px) {
     .story-stream-container,
     .story-stream-loading {
       max-width: 1140px;
       padding: 1.75rem;
     }
     
     .event-banner,
     .skeleton-event-banner {
       padding: 1.75rem;
     }
     
     .event-title {
       font-size: 2.25rem;
     }
     
     .event-qr::after,
     .skeleton-qr {
       width: 120px;
       height: 120px;
     }
     
     .skeleton-qr::after {
       width: 120px;
       height: 120px;
     }
     
     .story-stream-carousel,
     .skeleton-carousel {
       height: calc(100vh - 240px);
       max-height: 650px;
     }
     
     .story-stream-carousel .carousel-item {
       height: 100%;
     }
   }

     /* Medium Large screens (992px - 1199px) */
   @media (min-width: 992px) and (max-width: 1199px) {
     .story-stream-container,
     .story-stream-loading {
       max-width: 960px;
       padding: 1.5rem;
     }
     
     .event-banner,
     .skeleton-event-banner {
       padding: 1.5rem;
     }
     
     .event-title {
       font-size: 2rem;
     }
     
     .story-stream-carousel,
     .skeleton-carousel {
       height: calc(100vh - 220px);
       max-height: 600px;
     }
     
     .story-stream-carousel .carousel-item {
       height: 100%;
     }
   }

     /* Medium screens (768px - 991px) */
   @media (min-width: 768px) and (max-width: 991px) {
     .story-stream-container,
     .story-stream-loading {
       max-width: 720px;
       padding: 1.25rem;
       height: 100vh;
     }
     
     .event-banner,
     .skeleton-event-banner {
      flex-direction: column;
      text-align: center;
       gap: 1.25rem;
       padding: 1.25rem;
     }
     
     .event-banner-content {
       padding-right: 0;
     }
     
     .skeleton-banner-content {
       flex-direction: column;
       gap: 1.25rem;
     }
     
     .event-title {
       font-size: 1.75rem;
    }
    
     .event-tags {
      justify-content: center;
     }
    
     .event-cta,
    .skeleton-banner-cta {
      flex-direction: row;
      justify-content: center;
    }
    
         .event-qr::after,
    .skeleton-qr {
      width: 100px;
      height: 100px;
    }
    
    .skeleton-qr::after {
      width: 100px;
      height: 100px;
    }
     
     .story-stream-carousel,
    .skeleton-carousel {
       height: calc(100vh - 240px);
       max-height: 500px;
       min-height: 350px;
     }
     
     .story-stream-carousel .carousel-item {
       height: 100%;
       flex-direction: column;
    }
    
    .skeleton-carousel-layout {
      flex-direction: column;
    }
    
     .story-media-container,
    .skeleton-media {
      width: 100%;
       height: 60%;
    }
    
     .story-overlay,
    .skeleton-content {
      width: 100%;
       height: 40%;
     }
     
          .story-header,
     .skeleton-header {
       padding: 1rem 1.25rem 0.75rem 1.25rem;
     }
     
     .story-scrollable-content,
     .skeleton-scrollable-content {
       padding: 0.75rem 1.25rem 1.25rem 1.25rem;
     }
     
     .story-content h3 {
       font-size: 1.35rem;
     }
     
     .story-content p {
       font-size: 0.9rem;
     }
     
     /* Consistent button sizing for tablets */
     .story-controls {
       top: 1rem;
       right: 1rem;
     }
     
     .story-control-btn,
     .theme-toggle-btn {
       width: 40px;
       height: 40px;
     }
     
     .story-control-btn i,
     .theme-toggle-btn i {
       font-size: 1rem;
     }
     
     .story-indicators {
       top: 1rem;
       left: 1rem;
       right: 100px;
       max-width: calc(100% - 120px);
     }
     
     /* Better image scaling for tablets */
     .story-media {
       object-fit: cover;
       object-position: center;
    }
  }

     /* Small screens (576px - 767px) */
   @media (min-width: 576px) and (max-width: 767px) {
     .story-stream-container,
     .story-stream-loading {
       padding: 1rem;
       height: 100vh;
       justify-content: flex-start;
       gap: 1rem;
     }
    
    .event-banner,
    .skeleton-event-banner {
      flex-direction: column;
      text-align: center;
      gap: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .event-banner-content {
      padding-right: 0;
    }
    
    .skeleton-banner-content {
      flex-direction: column;
      gap: 1rem;
    }
    
    .event-title {
      font-size: 1.5rem;
    }
    
    .event-cta,
    .skeleton-banner-cta {
      flex-direction: row;
      gap: 1rem;
    }
    
    .event-qr::after,
    .skeleton-qr {
      width: 90px;
      height: 90px;
    }
    
    .skeleton-qr::after {
      width: 90px;
      height: 90px;
    }
    
    .story-stream-carousel,
    .skeleton-carousel {
      height: calc(100vh - 240px);
      max-height: 500px;
      min-height: 350px;
    }
    
    .story-stream-carousel .carousel-item {
      height: 100%;
      flex-direction: column;
    }
    
    .skeleton-carousel-layout {
      flex-direction: column;
    }
    
    .story-media-container,
    .skeleton-media {
      width: 100%;
      height: 55%;
    }
    
         .story-overlay,
    .skeleton-content {
      width: 100%;
       height: 45%;
     }
     
     .story-header,
     .skeleton-header {
       padding: 0.75rem 1rem 0.5rem 1rem;
     }
     
     .story-scrollable-content,
     .skeleton-scrollable-content {
       padding: 0.5rem 1rem 1rem 1rem;
    }
    
    .story-author-avatar,
    .skeleton-avatar {
      width: 40px;
      height: 40px;
    }
    
    .story-content h3 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    
    .skeleton-story-title {
      height: 26px;
    }
    
    .story-content p {
      font-size: 0.85rem;
      -webkit-line-clamp: 2;
    }
    
    .skeleton-body-line {
      height: 12px;
    }
    
        .story-stats,
    .skeleton-stats {
      margin-top: 0.75rem;
      gap: 1rem;
  }

    /* Consistent button sizing for small screens */
    .story-controls {
      top: 1rem;
      right: 1rem;
    }
    
    .story-control-btn,
    .theme-toggle-btn {
      width: 38px;
      height: 38px;
    }
    
    .story-control-btn i,
    .theme-toggle-btn i {
      font-size: 0.95rem;
    }
    
    .story-indicators {
      top: 1rem;
      left: 1rem;
      right: 95px;
      max-width: calc(100% - 115px);
    }

    /* Improved image scaling for small screens */
    .story-media {
      object-fit: cover;
      object-position: center;
      width: 100%;
      height: 100%;
    }
    
    .story-media.contain {
      object-fit: contain;
      object-position: center;
    }
  }

  /* Extra Small screens (up to 575px) */
  @media (max-width: 575px) {
    .story-stream-container,
    .story-stream-loading {
      padding: 0.75rem;
      height: 100vh;
      justify-content: flex-start;
      gap: 0.75rem;
    }
    
    .event-banner,
    .skeleton-event-banner {
      flex-direction: column;
      text-align: center;
      gap: 0.75rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      border-radius: 12px;
    }
    
    .event-banner-content {
      padding-right: 0;
    }
    
    .skeleton-banner-content {
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .event-date {
      flex-direction: column;
      gap: 0.25rem;
      align-items: center;
    }
    
    .event-title {
      font-size: 1.25rem;
      line-height: 1.2;
      margin: 0.25rem 0;
    }
    
    .event-cta,
    .skeleton-banner-cta {
      flex-direction: row;
      gap: 0.75rem;
      align-items: center;
      justify-content: center;
    }
    
    .event-cta-content h3 {
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }
    
    .event-cta-content p {
      font-size: 0.75rem;
      white-space: normal;
    }
    
    .event-qr {
      padding: 0.25rem;
    }
    
    .event-qr::after,
    .skeleton-qr {
      width: 80px;
      height: 80px;
    }
    
    .skeleton-qr::after {
      width: 80px;
      height: 80px;
    }
    
    .story-stream-carousel,
    .skeleton-carousel {
      height: calc(100vh - 240px);
      border-radius: 12px;
      flex: 1;
      min-height: 350px;
      max-height: calc(100vh - 240px);
    }
    
    .story-stream-carousel .carousel-item {
      height: 100%;
      flex-direction: column;
    }
    
    .skeleton-carousel-layout {
      flex-direction: column;
    }
    
    .story-media-container,
    .skeleton-media {
      width: 100%;
      height: 50%;
    }
    
         .story-overlay,
    .skeleton-content {
      width: 100%;
       height: 50%;
     }
     
     .story-header,
     .skeleton-header {
       padding: 0.5rem 0.75rem;
     }
     
     .story-scrollable-content,
     .skeleton-scrollable-content {
      padding: 0.75rem;
       gap: 0.5rem;
    }
    
    .story-author-avatar,
    .skeleton-avatar {
      width: 32px;
      height: 32px;
    }
    
    .story-author-details h5 {
      font-size: 0.85rem;
    }
    
    .story-author-details p {
      font-size: 0.7rem;
    }
    
    .skeleton-author-name {
      height: 14px;
      width: 80px;
    }
    
    .skeleton-author-time {
      height: 12px;
      width: 50px;
    }
    
    .story-content h3 {
      font-size: 1rem;
      margin-bottom: 0.25rem;
      line-height: 1.2;
    }
    
    .skeleton-story-title {
      height: 20px;
      margin-bottom: 0.25rem;
    }
    
    .story-content p {
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
      -webkit-line-clamp: 2;
      line-height: 1.2;
    }
    
    .skeleton-body-line {
      height: 10px;
      margin-bottom: 0.25rem;
    }
    
    .story-stats,
    .skeleton-stats {
      margin-top: 0.5rem;
      gap: 0.75rem;
    }
    
    .story-stat {
      font-size: 0.75rem;
    }
    
    .story-stat i {
      font-size: 0.9rem;
    }
    
    .skeleton-stat {
      height: 14px;
      width: 40px;
    }
    
    .story-controls {
      top: 0.5rem;
      right: 0.5rem;
    }
    
    .story-control-btn,
    .theme-toggle-btn {
      width: 36px;
      height: 36px;
    }
    
    .story-control-btn i,
    .theme-toggle-btn i {
      font-size: 0.9rem;
    }
    
    .story-indicators {
      top: 0.5rem;
      left: 0.5rem;
      right: 90px;
      max-width: calc(100% - 100px);
    }
    
         .story-navigation {
       display: none;
     }

     /* Mobile scrollbar adjustments */
     .story-scrollable-content::-webkit-scrollbar,
     .skeleton-scrollable-content::-webkit-scrollbar {
       width: 6px;
     }

     .story-scrollable-content::-webkit-scrollbar-thumb,
     .skeleton-scrollable-content::-webkit-scrollbar-thumb {
       background: linear-gradient(180deg, rgba(123, 63, 238, 0.9) 0%, rgba(157, 94, 255, 0.7) 100%);
     }

     .story-scrollable-content::-webkit-scrollbar-thumb:hover,
     .skeleton-scrollable-content::-webkit-scrollbar-thumb:hover {
       transform: none; /* Disable scaling on mobile */
     }
     
     /* Improved image scaling for extra small screens */
     .story-media {
       object-fit: cover;
       object-position: center;
       width: 100%;
       height: 100%;
     }
     
     .story-media.contain {
       object-fit: contain;
       object-position: center;
     }
   }

   /* Landscape orientation fixes for mobile */
  @media (max-width: 767px) and (orientation: landscape) {
    .story-stream-container,
    .story-stream-loading {
      height: 100vh;
      justify-content: flex-start;
    }
    
    .event-banner,
    .skeleton-event-banner {
      margin-bottom: 0.5rem;
      padding: 0.75rem;
    }
    
    .story-stream-carousel,
    .skeleton-carousel {
      height: calc(100vh - 160px);
      min-height: 300px;
      max-height: calc(100vh - 160px);
    }
  }

  /* Ultra-wide screen optimizations */
  @media (min-width: 1600px) {
    .story-stream-container,
    .story-stream-loading {
      max-width: 1400px;
    }
    
    .story-stream-carousel,
    .skeleton-carousel {
      height: calc(100vh - 320px);
      max-height: 800px;
    }
    
    .story-stream-carousel .carousel-item {
      height: 100%;
    }
  }

  /* Print styles */
  @media print {
    .story-stream-background {
      background: white !important;
    }
    
    .story-controls,
    .story-indicators,
    .story-navigation {
      display: none !important;
    }
  }
</style>

<div class="story-stream-background">
  <!-- Loading state -->
  <div class="story-stream-loading" id="storyStreamLoading">
      <!-- Skeleton Event Banner -->
      <div class="skeleton-event-banner">
        <div class="skeleton-banner-content">
          <div class="skeleton-banner-left">
            <div class="skeleton skeleton-banner-text" style="height: 16px; width: 120px; margin-bottom: 0.5rem;"></div>
            <div class="skeleton skeleton-banner-text" style="height: 24px; width: 100px; margin-bottom: 1rem;"></div>
            <div class="skeleton skeleton-banner-text" style="height: 40px; width: 280px; margin-bottom: 1rem;"></div>
            <div class="skeleton skeleton-banner-text" style="height: 24px; width: 80px;"></div>
          </div>
          <div class="skeleton-banner-right">
            <div class="skeleton-banner-cta">
              <div class="skeleton-cta-text">
                <div class="skeleton skeleton-banner-text" style="height: 24px; width: 140px; margin-bottom: 0.5rem;"></div>
                <div class="skeleton skeleton-banner-text" style="height: 16px; width: 120px;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Skeleton Story Carousel -->
      <div class="skeleton-carousel">
        <div class="skeleton-carousel-layout">
          <!-- Skeleton Media Area -->
          <div class="skeleton-media"></div>
          
          <!-- Skeleton Content Area -->
          <div class="skeleton-content">
            <!-- Skeleton Header -->
            <div class="skeleton-header">
            <div class="skeleton-author-section">
              <div class="skeleton skeleton-avatar"></div>
              <div class="skeleton-author-text">
                <div class="skeleton skeleton-text skeleton-author-name"></div>
                <div class="skeleton skeleton-text skeleton-author-time"></div>
                </div>
              </div>
              <div class="skeleton-stats">
                <div class="skeleton skeleton-text skeleton-stat"></div>
                <div class="skeleton skeleton-text skeleton-stat"></div>
              </div>
            </div>
            
            <!-- Skeleton Scrollable Content -->
            <div class="skeleton-scrollable-content">
            <div class="skeleton-story-section">
              <div class="skeleton skeleton-text skeleton-story-title"></div>
              <div class="skeleton-story-body">
                <div class="skeleton skeleton-text skeleton-body-line" style="width: 95%;"></div>
                <div class="skeleton skeleton-text skeleton-body-line" style="width: 88%;"></div>
                <div class="skeleton skeleton-text skeleton-body-line" style="width: 75%;"></div>
              </div>
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  
  <div class="story-stream-container" id="storyStreamContainer" style="display: none;">
    <!-- Event Banner -->
    <div class="event-banner" id="eventBanner">
      <div class="event-banner-content">
        <div class="event-date">
          <span class="event-day" id="eventDateRange">Loading...</span>
          <span class="event-status" id="eventStatus">Loading...</span>
        </div>
        <h1 class="event-title" id="eventTitle">Loading Stream...</h1> 
        <div class="event-tags">
          <span class="event-tag">
            <i class="bi bi-people-fill"></i>
            ALL AGES
          </span>
          <span class="event-tag">
            <i class="bi bi-heart-fill"></i>
            COMMUNITY
          </span>
        </div>
      </div>
      <div class="event-cta">
        <div class="event-cta-content">
          <h3>Get Featured!</h3>
          <p>Scan QR Code to<br>submit your Story:</p>
        </div>
        <div class="event-qr">
          <img src="https://api.causecircle.org/npos/{{$zuid}}/qrcode?type=svg&mode=serve" alt="QR Code" />
        </div>
      </div>
    </div>
    
    <!-- Bootstrap Carousel -->
    <div id="storyStreamCarousel" class="carousel slide story-stream-carousel" data-bs-ride="false" data-bs-interval="false">
      <!-- Empty state inside carousel -->
    <div class="story-stream-empty d-none" id="storyStreamEmpty">
      <h3>No Stories Available</h3>
      <p>This nonprofit hasn't shared any stories yet. Check back later for updates!</p>
    </div>
    
      <div class="carousel-inner" id="storyCarouselInner">
        <!-- Story slides will be dynamically generated here -->
      </div>
      
      <!-- Progress bar inside carousel -->
      <div class="story-progress-bar">
        <div class="story-progress-fill" id="storyProgressFill"></div>
      </div>
  
      <!-- Control buttons -->
    <div class="story-controls">
      <button class="theme-toggle-btn" id="themeToggleBtn" title="Toggle Theme">
        <i class="bi bi-moon-fill" id="themeToggleIcon"></i>
      </button>
      <button class="story-control-btn" id="pausePlayBtn" title="Pause/Play">
        <i class="bi bi-pause-fill" id="pausePlayIcon"></i>
      </button>
    </div>
    </div>
    
    <!-- Progress indicators -->
    <div class="story-indicators d-none" id="storyIndicators">
      <!-- Indicators will be dynamically generated here -->
    </div>
  </div>
</div>

<script type="module">
$(document).ready(async function() {
  const streamZuid = '{{$streamZuid}}';
  let streamData = null;
  
  // Try to get initial stream data
  try {
    streamData = await window.getStoryStream('{{$zuid}}', streamZuid);
  } catch (error) {
    console.error('Failed to get initial stream data:', error);
  }
  
  // Initialize theme
  initializeTheme();
  
  // Story stream global variables
  window.storyStreamData = {
    npoZuid: '{{$zuid}}',
    streamZuid: streamZuid,
    streamData: streamData,
    stories: [],
    currentIndex: 0,
    isPlaying: true,
    progressInterval: null,
    progressStartTime: null,
    progressDuration: 7000, // 7 seconds
    isTransitioning: false,
    carousel: null,
    refreshInterval: null,
    streamRefreshInterval: null,
    lastFetchTime: null,
    isRefreshing: false
  };
  
  // Initialize story stream function
  window.initStoryStream = function(npoZuid, containerId = 'storyStreamContainer') {
    const $container = $('#' + containerId);
    if ($container.length && npoZuid) {
      window.storyStreamData.npoZuid = npoZuid;
      // Show loading first, hide container
      $('#storyStreamLoading').show();
      $container.hide();
      initializeStoryStream();
      return true;
    }
    return false;
  };
  
  // Global close function
  window.closeStoryStream = function() {
    const $container = $('#storyStreamContainer');
    if ($container.length) {
      $container.hide();
      $('#storyStreamLoading').show();
      stopAutoPlay();
      stopAutoRefresh();
      stopStreamDataRefresh();
      $(document).off('keydown.storyStream');
    }
  };
  
  // Initialize the story stream
  function initializeStoryStream() {
    bindStoryStreamEvents();
    updateEventBanner();
    loadStories().then(() => {
      renderStoryStream();
      startAutoPlay();
      startAutoRefresh();
      startStreamDataRefresh();
    });
  }
  
  // Auto-initialize story stream if we have stream data
  if (streamData && streamData.data && window.storyStreamData.npoZuid && window.storyStreamData.npoZuid !== '') {
    initializeStoryStream();
  } else {
    // Show empty state if no valid stream data
    $('#storyStreamLoading').hide();
    $('#storyStreamContainer').show();
    updateEventBanner(); // Still show banner even if no stream data
    $('#storyStreamEmpty').removeClass('d-none');
  }
  
  // Bind all event handlers
  function bindStoryStreamEvents() {
    // Control buttons
    $('#pausePlayBtn').off('click.storyStream').on('click.storyStream', togglePlayPause);
    $('#closeStreamBtn').off('click.storyStream').on('click.storyStream', window.closeStoryStream);
    $('#prevStoryBtn').off('click.storyStream').on('click.storyStream', previousStory);
    $('#nextStoryBtn').off('click.storyStream').on('click.storyStream', nextStory);
    $('#themeToggleBtn').off('click.storyStream').on('click.storyStream', toggleTheme);
    
    // Keyboard navigation
    $(document).off('keydown.storyStream').on('keydown.storyStream', handleKeydown);
    
    // Container click events
    $('#storyStreamContainer').off('click.storyStream').on('click.storyStream', handleContainerClick);
    
    // Prevent context menu
    $('#storyStreamContainer').off('contextmenu.storyStream').on('contextmenu.storyStream', function(e) {
      e.preventDefault();
    });
    
    // Scroll fade effects for story scrollable content
    $(document).on('scroll', '.story-scrollable-content', handleOverlayScroll);
    
    // Bootstrap carousel events
    $('#storyStreamCarousel').off('slide.bs.carousel.storyStream').on('slide.bs.carousel.storyStream', function(e) {
      window.storyStreamData.isTransitioning = true;
      window.storyStreamData.currentIndex = e.to;
      updateIndicators(e.to);
      resetProgress();
    });
    
    $('#storyStreamCarousel').off('slid.bs.carousel.storyStream').on('slid.bs.carousel.storyStream', function(e) {
      window.storyStreamData.isTransitioning = false;
      startProgress();
    });
  }
  
  // Handle scroll fade effects
  function handleOverlayScroll() {
    const $overlay = $(this);
    const scrollTop = $overlay.scrollTop();
    const scrollHeight = $overlay[0].scrollHeight;
    const clientHeight = $overlay[0].clientHeight;
    const scrollBottom = scrollHeight - scrollTop - clientHeight;
    
    // Show top fade when scrolled down from top
    if (scrollTop > 10) {
      $overlay.addClass('scrolling-top');
    } else {
      $overlay.removeClass('scrolling-top');
    }
    
    // Show bottom fade when not at bottom
    if (scrollBottom > 10) {
      $overlay.addClass('scrolling-bottom');
    } else {
      $overlay.removeClass('scrolling-bottom');
    }
  }
  
  // Refresh stream data from API
  async function refreshStreamData() {
    try {
      if (!window.getStoryStream) {
        console.error('Story Stream - getStoryStream function not available');
        return false;
      }
      
      const newStreamData = await window.getStoryStream(window.storyStreamData.npoZuid, window.storyStreamData.streamZuid);
      
      if (newStreamData && newStreamData.data) {
        const oldStreamData = window.storyStreamData.streamData;
        window.storyStreamData.streamData = newStreamData;
        
        // Check if we need to reload stories due to configuration changes
        const configChanged = !oldStreamData || 
          oldStreamData.data.enable !== newStreamData.data.enable ||
          oldStreamData.data.enable_live_stream !== newStreamData.data.enable_live_stream ||
          oldStreamData.data.start_date !== newStreamData.data.start_date ||
          oldStreamData.data.end_date !== newStreamData.data.end_date;
        
        if (configChanged) {
          await loadStories(true);
        }
         
         // Update event banner with new stream data
         updateEventBanner();
         
         return true;
      }
      
      return false;
    } catch (error) {
      console.error('Story Stream - Error refreshing stream data:', error);
      return false;
    }
  }
  
  // Update event banner with stream data
  function updateEventBanner() {
    if (!window.storyStreamData.streamData || !window.storyStreamData.streamData.data) {
      $('#eventTitle').text('Stream Unavailable');
      $('#eventDateRange').text('No Data');
      $('#eventStatus').text('Offline');
      return;
    }
    
    const streamData = window.storyStreamData.streamData.data;
    const title = streamData.title || 'Story Stream';
    const startDate = streamData.start_date;
    const endDate = streamData.end_date;
    
    // Update title
    $('#eventTitle').text(title);
    
    // Format and update date range
    if (startDate && endDate) {
      const dateRange = formatDateRange(startDate, endDate);
      $('#eventDateRange').text(dateRange);
    } else {
      $('#eventDateRange').text('Date TBD');
    }
    
    // Update status
    const status = getStreamStatus(streamData);
    $('#eventStatus').text(status.text);
    $('#eventStatus').attr('class', `event-status ${status.class}`);
  }
  
  // Get stream status based on current time and stream configuration
  function getStreamStatus(streamData) {
    if (!streamData || streamData.enable !== "1") {
      return { text: 'Disabled', class: 'status-disabled' };
    }
    
    if (!streamData.start_date || !streamData.end_date) {
      return { text: 'Date TBD', class: 'status-pending' };
    }
    
    const now = new Date();
    const startDate = new Date(streamData.start_date);
    const endDate = new Date(streamData.end_date + ' 23:59:59'); // Include the entire end date
    
    if (now < startDate) {
      return { text: 'Upcoming', class: 'status-upcoming' };
    } else if (now > endDate) {
      return { text: 'Ended', class: 'status-ended' };
    } else {
      return { text: 'Happening Now!', class: 'status-active' };
    }
  }
  
  // Format date range for display
  function formatDateRange(startDateStr, endDateStr) {
    try {
      const startDate = new Date(startDateStr);
      const endDate = new Date(endDateStr);
      
      // Check if dates are valid
      if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
        return 'Invalid Date';
      }
      
      const options = { month: 'long', day: 'numeric' };
      
      // If same month and year, show "June 30 - July 1"
      if (startDate.getFullYear() === endDate.getFullYear()) {
        if (startDate.getMonth() === endDate.getMonth()) {
          // Same month: "June 30 - 31"
          if (startDate.getDate() === endDate.getDate()) {
            // Same day: "June 30"
            return startDate.toLocaleDateString('en-US', options);
          } else {
            return `${startDate.toLocaleDateString('en-US', options)} - ${endDate.getDate()}`;
          }
        } else {
          // Different months, same year: "June 30 - July 1"
          return `${startDate.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}`;
        }
      } else {
        // Different years: "Dec 30, 2023 - Jan 1, 2024"
        const optionsWithYear = { month: 'long', day: 'numeric', year: 'numeric' };
        return `${startDate.toLocaleDateString('en-US', optionsWithYear)} - ${endDate.toLocaleDateString('en-US', optionsWithYear)}`;
      }
    } catch (error) {
      console.error('Error formatting date range:', error);
      return 'Date Error';
    }
  }
  
  // Check if stream is currently active
  function isStreamActive() {
    if (!window.storyStreamData.streamData || !window.storyStreamData.streamData.data) {
      return false;
    }
    
    const streamData = window.storyStreamData.streamData.data;
    const status = getStreamStatus(streamData);
    return status.class === 'status-active';
  }
  
  // Load stories from streamData and optionally from NPO if live stream is enabled
  async function loadStories(isRefresh = false) {
    try {
      if (!isRefresh) {
        // Show skeleton, hide main container only on initial load
        $('#storyStreamLoading').show();
        $('#storyStreamContainer').hide();
      }
      
      // Check if stream is enabled and active
      if (!window.storyStreamData.streamData || window.storyStreamData.streamData.data.enable !== "1") {
        window.storyStreamData.stories = [];
        return;
      }
      
      // Check if stream is currently active (between start and end dates)
      if (!isStreamActive()) {
        const status = getStreamStatus(window.storyStreamData.streamData.data);
        window.storyStreamData.stories = [];
        return;
      }
      
      let allStories = [];
      
      // Get stories from streamData
      const streamStories = window.storyStreamData.streamData.data.stories?.data || [];
      
      // Get full story data for each stream story using their ZUIDs
      let processedStreamStories = [];
      if (streamStories.length > 0 && window.getStory) {
        
        // Filter approved stories first to avoid unnecessary API calls
        const approvedStreamStories = streamStories.filter(story => 
          story.npo_approval_status === 'approved' || story.npo_approved === "1"
        );
        
        // Get full story data for each approved story
        const storyPromises = approvedStreamStories.map(async (story) => {
          try {
            const storyZuid = story.meta?.zuid;
            if (!storyZuid) {
              console.warn('Story Stream - No ZUID found for story:', story.title);
              return { ...story, source: 'stream' };
            }
            
            const fullStory = await window.getStory(storyZuid);
            if (fullStory && fullStory.data && fullStory.data.length > 0) {
              return { ...fullStory.data[0], source: 'stream' };
            } else {
              console.warn('Story Stream - Failed to get full story data for ZUID:', storyZuid);
              return { ...story, source: 'stream' };
            }
          } catch (error) {
            console.error('Story Stream - Error fetching story:', story.meta?.zuid, error);
            return { ...story, source: 'stream' };
          }
        });
        
        processedStreamStories = await Promise.all(storyPromises);
      } else {
        // Fallback to using streamData stories as-is if getStory is not available
        processedStreamStories = streamStories
          .filter(story => story.npo_approval_status === 'approved' || story.npo_approved === "1")
          .map(story => ({
            ...story,
            source: 'stream'
          }));
      }
      
      allStories = [...processedStreamStories];
      
      // If live stream is enabled, get additional stories from NPO
      if (window.storyStreamData.streamData.data.enable_live_stream === "1") {
        
        if (!window.getStories) {
          console.error('Story Stream - getStories function not available');
        } else {
          try {
            const npoResponse = await window.getStories({ npo: window.storyStreamData.npoZuid });
            
                         if (npoResponse && npoResponse.data && npoResponse.data.length > 0) {
               const streamStartDate = new Date(window.storyStreamData.streamData.data.start_date);
               const streamEndDate = new Date(window.storyStreamData.streamData.data.end_date + ' 23:59:59');
               
               // Filter NPO stories by date range and approval status
               const filteredNpoStories = npoResponse.data
                 .filter(story => {
                   // Check approval status
                   if (story.npo_approval_status !== 'approved' && story.status !== 'approved') {
                     return false;
                   }
                   
                   // Check if story was created within the stream date range
                   const storyDate = new Date(story.meta?.createdAt || story.created_at || '1970-01-01');
                   return storyDate >= streamStartDate && storyDate <= streamEndDate;
                 })
                 .map(story => ({
                   ...story,
                   source: 'live'
                 }));
               
              
              // Merge live stories with stream stories, avoiding duplicates
              const streamStoryIds = new Set(processedStreamStories.map(story => story.meta?.zuid || story.id));
              const uniqueLiveStories = filteredNpoStories.filter(story => 
                !streamStoryIds.has(story.meta?.zuid || story.id)
              );
              
              allStories = [...processedStreamStories, ...uniqueLiveStories];
            }
          } catch (error) {
            console.error('Story Stream - Error fetching NPO stories for live stream:', error);
          }
        }
      }
      
      // Sort all stories by creation date descending (newest first)
      allStories.sort((a, b) => {
        const dateA = new Date(a.meta?.createdAt || a.created_at || '1970-01-01');
        const dateB = new Date(b.meta?.createdAt || b.created_at || '1970-01-01');
        return dateB - dateA;
      });
      
      if (isRefresh) {
        // Check for new stories and add them seamlessly
        if (window.storyStreamData.stories.length === 0) {
          // If we had no stories before, treat this as initial load
          window.storyStreamData.stories = allStories;
          window.storyStreamData.lastFetchTime = Date.now();
          // Re-render the entire stream
          renderStoryStream();
          startAutoPlay();
        } else {
          // We had stories before, just add new ones
          await handleNewStories(allStories);
        }
      } else {
        window.storyStreamData.stories = allStories;
        window.storyStreamData.lastFetchTime = Date.now();
      }
      
    } catch (error) {
      console.error('Story Stream - Error loading stories:', error);
      if (!isRefresh) {
        window.storyStreamData.stories = [];
      }
    }
  }
  
  // Handle new stories seamlessly
  async function handleNewStories(newStories) {
    if (window.storyStreamData.isRefreshing) return;
    window.storyStreamData.isRefreshing = true;
    
    try {
      const currentStoryIds = window.storyStreamData.stories.map(story => story.meta?.zuid || story.id);
      const freshStories = newStories.filter(story => !currentStoryIds.includes(story.meta?.zuid || story.id));
      
      if (freshStories.length > 0) {
        
        // Add new stories to the beginning of the array
        window.storyStreamData.stories = [...freshStories, ...window.storyStreamData.stories];
        
        // Add new slides to the carousel seamlessly
        await addNewSlidesToCarousel(freshStories);
        
        // Update indicators
        renderIndicators();
        
        
      }
    } catch (error) {
      console.error('Story Stream - Error handling new stories:', error);
    } finally {
      window.storyStreamData.isRefreshing = false;
    }
  }
  
  // Add new slides to carousel without disrupting current view
  async function addNewSlidesToCarousel(newStories) {
    const $carouselInner = $('#storyCarouselInner');
    
    // Create new slides
    const newSlides = newStories.map((story, index) => createSlideHtml(story, index));
    
    // Insert new slides at the beginning
    newSlides.reverse().forEach(slideHtml => {
      $carouselInner.prepend(slideHtml);
    });
    
    // Update all slide indices
    $carouselInner.find('.carousel-item').each(function(index) {
      $(this).attr('data-story-index', index);
    });
    
    // Adjust current index to account for new slides
    window.storyStreamData.currentIndex += newStories.length;
    
    // Re-initialize carousel to handle new slides
    if (window.storyStreamData.carousel) {
      window.storyStreamData.carousel.dispose();
    }
    
    // Small delay to ensure DOM is ready
    setTimeout(() => {
      window.storyStreamData.carousel = new bootstrap.Carousel('#storyStreamCarousel', {
        interval: false,
        wrap: true,
        touch: true,
        slide: true
      });
      
      // Go to the correct slide (accounting for new slides)
      if (window.storyStreamData.currentIndex > 0) {
        window.storyStreamData.carousel.to(window.storyStreamData.currentIndex);
      }
    }, 100);
  }
  
  // Render the story stream
  function renderStoryStream() {
    $('#storyStreamLoading').hide();
    $('#storyStreamContainer').show();
    
    // Update banner regardless of story count
    updateEventBanner();
    
    if (window.storyStreamData.stories.length === 0) {
      $('#storyStreamEmpty').removeClass('d-none');
      
      // Update empty message based on stream status
      const status = window.storyStreamData.streamData ? 
        getStreamStatus(window.storyStreamData.streamData.data) : 
        { text: 'Unavailable', class: 'status-disabled' };
      
      let emptyMessage = 'No Stories Available';
      let emptyDescription = 'This nonprofit hasn\'t shared any stories yet. Check back later for updates!';
      
      if (status.class === 'status-upcoming') {
        emptyMessage = 'Stream Starting Soon';
        emptyDescription = 'This story stream hasn\'t started yet. Come back during the event dates!';
      } else if (status.class === 'status-ended') {
        emptyMessage = 'Stream Has Ended';
        emptyDescription = 'This story stream has concluded. Thank you for participating!';
      } else if (status.class === 'status-disabled') {
        emptyMessage = 'Stream Unavailable';
        emptyDescription = 'This story stream is currently disabled or unavailable.';
      }
      
      $('#storyStreamEmpty h3').text(emptyMessage);
      $('#storyStreamEmpty p').text(emptyDescription);
      
      return;
    }
    
    $('#storyStreamEmpty').addClass('d-none');
    
    // Clear any existing carousel
    if (window.storyStreamData.carousel) {
      window.storyStreamData.carousel.dispose();
    }
    
    renderCarouselSlides();
    renderIndicators();
    
    // Small delay to ensure DOM is ready
    setTimeout(() => {
      // Initialize Bootstrap carousel
      window.storyStreamData.carousel = new bootstrap.Carousel('#storyStreamCarousel', {
        interval: false,
        wrap: true,
        touch: true,
        slide: true
      });
      
      // Show first slide and trigger ambient effect
      updateIndicators(0);
      const $firstMediaTarget = $('#storyCarouselInner .carousel-item.active').find('[data-ambient-target="true"]');
      if ($firstMediaTarget.length) {
        drawAmbientEffect($firstMediaTarget[0]);
      }
    }, 100);
  }
  
  // Render carousel slides
  function renderCarouselSlides() {
    const $carouselInner = $('#storyCarouselInner');
    $carouselInner.empty();
    
    
    window.storyStreamData.stories.forEach((story, index) => {
      const slideHtml = createSlideHtml(story, index);
      $carouselInner.append(slideHtml);
    });
    
    // Ensure only first slide is active
    $carouselInner.find('.carousel-item').removeClass('active');
    $carouselInner.find('.carousel-item:first').addClass('active');
    
  }
  
  // Create HTML for a single slide
  function createSlideHtml(story, index) {
    const mediaUrl = getFirstMediaUrl(story);
    const isVideo = isVideoUrl(mediaUrl);
    const mediaElement = createMediaElement(mediaUrl, story.title, isVideo);
    const authorInfo = getAuthorInfo(story);
    const storyStats = getStoryStats(story);
    const sourceIndicator = story.source === 'live' ? ' LIVE' : '';
    
    return `
      <div class="carousel-item" data-story-index="${index}">
        ${mediaElement}
        <div class="story-overlay">
          <div class="story-header">
          <div class="story-author-info">
            <img src="${authorInfo.avatar}" alt="${authorInfo.name}" class="story-author-avatar">
            <div class="story-author-details">
              <h5>${authorInfo.name}</h5>
              <p>${formatTimeAgo(story.meta?.createdAt || story.created_at)}</p>
            </div>
          </div>
            <div class="story-stats" data-story-zuid="${story.meta?.zuid}">
              <div class="story-stat">
                <i class="bi bi-heart"></i>
                <span class="story-stat-number" data-stat="likes">${storyStats.likes}</span>
              </div>
              <div class="story-stat">
                <i class="bi bi-chat"></i>
                <span class="story-stat-number" data-stat="comments">${storyStats.comments}</span>
              </div>
            </div>
          </div>
          <div class="story-scrollable-content">
            <div class="story-content">
              <h3>${escapeHtml(story.title || '')}</h3>
              <p>${normalizeWhitespace(stripHtml(story.story_body || ''))}</p>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  
  // Render progress indicators
  function renderIndicators() {
    const $indicatorsContainer = $('#storyIndicators');
    $indicatorsContainer.empty();
    
    window.storyStreamData.stories.forEach((_, index) => {
      const $indicator = $(`
        <div class="story-indicator" data-story-index="${index}">
          <div class="story-indicator-fill"></div>
        </div>
      `);
      
      $indicator.on('click', function() {
        goToStory(index);
      });
      
      $indicatorsContainer.append($indicator);
    });
  }
  
  // Update indicator states
  function updateIndicators(activeIndex) {
    $('#storyIndicators .story-indicator').each(function(index) {
      const $indicator = $(this);
      if (index === activeIndex) {
        $indicator.addClass('active');
      } else {
        $indicator.removeClass('active');
      }
    });
  }
  
  // Create media element HTML
  function createMediaElement(mediaUrl, title, isVideo) {
    let mediaHtml;
    let ambientTargetSrc = mediaUrl;

    if (!mediaUrl) {
      mediaHtml = `<img src="https://placehold.co/800x600?text=No+Image" alt="${escapeHtml(title)}" class="story-media" data-ambient-target="true">`;
      ambientTargetSrc = "https://placehold.co/800x600?text=No+Image";
    } else if (isVideo) {
      const embedUrl = getVideoEmbedUrl(mediaUrl);
      
      if (embedUrl && (embedUrl.includes('youtube.com') || embedUrl.includes('vimeo.com'))) {
        // YouTube and Vimeo iframes cannot be drawn to canvas directly due to cross-origin restrictions.
        // We will use the video thumbnail as the ambient background in this case.
        const youtubeId = getVideoId(mediaUrl, 'youtube');
        const thumbnailUrl = youtubeId ? `https://img.youtube.com/vi/${youtubeId}/hqdefault.jpg` : null;

        mediaHtml = `<div class="story-video-container">
            <iframe class="story-video" src="${embedUrl}" frameborder="0" 
                    allow="autoplay; fullscreen; picture-in-picture" allowfullscreen
                    title="${escapeHtml(title)}"></iframe>
        </div>`;
        // Use a hidden image for ambient effect if thumbnail exists
        if (thumbnailUrl) {
          mediaHtml += `<img src="${thumbnailUrl}" style="display:none;" class="story-media-thumbnail" data-ambient-target="true">`;
          ambientTargetSrc = thumbnailUrl;
        } else {
          // Fallback if no thumbnail can be extracted
          ambientTargetSrc = "https://placehold.co/800x600?text=No+Video+Thumbnail";
        }

      } else if (embedUrl) {
        mediaHtml = `<div class="story-video-container">
          <video class="story-video" controls preload="metadata" muted autoplay loop>
              <source src="${embedUrl}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
        </div>`;
        // Use the video itself as the ambient target if it's a direct video file
        mediaHtml += `<video src="${embedUrl}" style="display:none;" class="story-media-thumbnail" muted loop data-ambient-target="true"></video>`;
        ambientTargetSrc = embedUrl;
      }
    } else {
    // Default to image
    const imageUrl = mediaUrl.includes('?') ? `${mediaUrl}&width=1200` : `${mediaUrl}?width=1200`;
      mediaHtml = `<img src="${imageUrl}" alt="${escapeHtml(title)}" class="story-media" 
                   onload="$(this).addClass('contain')" onerror="this.src='https://placehold.co/800x600?text=Image+Not+Found'" data-ambient-target="true">`;
      ambientTargetSrc = imageUrl;
    }
    
    return `<div class="story-media-container">
      <canvas class="story-media-canvas" width="10" height="6" aria-hidden="true"></canvas>
      ${mediaHtml}
    </div>`;
  }
  
  // Utility function to get video ID for thumbnail
  function getVideoId(url, platform) {
    if (!url) return null;
    if (platform === 'youtube') {
      const match = url.match(/(?:youtube\.com\/(?:embed\/|watch\?v=|v\/)|youtu\.be\/)([a-zA-Z0-9_-]+)/);
      return match ? match[1] : null;
    }
    // Add other platforms if needed
    return null;
  }

  // Draw ambient effect on canvas
  function drawAmbientEffect(mediaElement) {
    const $mediaContainer = $(mediaElement).closest('.story-media-container');
    const canvas = $mediaContainer.find('.story-media-canvas')[0];
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    let animationFrameId;

    const draw = () => {
      if (!mediaElement || (mediaElement.tagName === 'VIDEO' && mediaElement.readyState < 2)) return;
      if (mediaElement.tagName === 'IMG' && !mediaElement.complete) return;
      
      try {
        ctx.drawImage(mediaElement, 0, 0, canvas.width, canvas.height);
        
        // Extract dominant colors for ambient effects
        extractAmbientColors(ctx, canvas);
      } catch (error) {
        console.warn('Story Stream - Could not draw ambient effect:', error);
      }
    };

    const startDrawing = () => {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }
      const loop = () => {
        draw();
        animationFrameId = requestAnimationFrame(loop);
      };
      loop();
    };

    const stopDrawing = () => {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = undefined;
      }
    };

    // Event listeners for controlling drawing
    if (mediaElement.tagName === 'VIDEO') {
      $(mediaElement).off('play.ambient').on('play.ambient', startDrawing);
      $(mediaElement).off('pause.ambient ended.ambient').on('pause.ambient ended.ambient', stopDrawing);
      // If video is already playing, start drawing
      if (!mediaElement.paused && !mediaElement.ended) {
        startDrawing();
      }
    } else if (mediaElement.tagName === 'IMG') {
      // For images, draw once when loaded
      if (mediaElement.complete) {
        draw();
      } else {
        $(mediaElement).off('load.ambient').on('load.ambient', draw);
      }
    }
  }

  // Extract dominant colors from canvas for ambient effects
  function extractAmbientColors(ctx, canvas) {
    try {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const colorCounts = {};
      
      // Sample every 4th pixel to improve performance
      for (let i = 0; i < data.length; i += 16) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const alpha = data[i + 3];
        
        // Skip transparent pixels
        if (alpha < 128) continue;
        
        // Group similar colors (reduce precision for better grouping)
        const key = `${Math.floor(r/32)*32},${Math.floor(g/32)*32},${Math.floor(b/32)*32}`;
        colorCounts[key] = (colorCounts[key] || 0) + 1;
      }
      
      // Get the most dominant colors
      const sortedColors = Object.entries(colorCounts)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 3)
        .map(([color]) => color.split(',').map(Number));
      
      if (sortedColors.length > 0) {
        applyAmbientColors(sortedColors);
      }
    } catch (error) {
      console.warn('Story Stream - Could not extract ambient colors:', error);
    }
  }

  // Apply ambient colors to carousel and event banner
  function applyAmbientColors(colors) {
    const $carousel = $('.story-stream-carousel');
    const $eventBanner = $('.event-banner');
    
    if (colors.length > 0) {
      const [r1, g1, b1] = colors[0];
      const [r2, g2, b2] = colors[1] || colors[0];
      const [r3, g3, b3] = colors[2] || colors[1] || colors[0];
      
      // Create ambient color variations with different opacities
      const primaryColor = `rgba(${r1}, ${g1}, ${b1}, 0.25)`;
      const secondaryColor = `rgba(${r2}, ${g2}, ${b2}, 0.15)`;
      const tertiaryColor = `rgba(${r3}, ${g3}, ${b3}, 0.08)`;
      
      // Apply to carousel
      $carousel.addClass('ambient-glow');
      $carousel[0].style.setProperty('--ambient-color-primary', primaryColor);
      $carousel[0].style.setProperty('--ambient-color-secondary', secondaryColor);
      $carousel[0].style.setProperty('--ambient-color-tertiary', tertiaryColor);
      
      // Apply to event banner with slightly different opacities
      const bannerPrimary = `rgba(${r1}, ${g1}, ${b1}, 0.3)`;
      const bannerSecondary = `rgba(${r2}, ${g2}, ${b2}, 0.18)`;
      const bannerTertiary = `rgba(${r3}, ${g3}, ${b3}, 0.1)`;
      
      $eventBanner.addClass('ambient-glow');
      $eventBanner[0].style.setProperty('--ambient-color-primary', bannerPrimary);
      $eventBanner[0].style.setProperty('--ambient-color-secondary', bannerSecondary);
      $eventBanner[0].style.setProperty('--ambient-color-tertiary', bannerTertiary);
    }
  }
  
  // Utility functions
  function getFirstMediaUrl(story) {
    if (typeof story.story_image === 'string') {
      return story.story_image;
    } else if (story.story_image?.data && story.story_image.data.length > 0) {
      return story.story_image.data[0]?.url || story.story_image.data[0]?.zuid || '';
    }
    return '';
  }
  
  function getAuthorInfo(story) {
    const author = story.author?.data?.[0] || {};
    const name = `${author.first_name || ''} ${author.last_name || ''}`.trim() || 'Unknown Author';
    let avatar = 'https://www.gravatar.com/avatar/?d=mp';
    
    if (typeof author.profile_image === 'string' && author.profile_image !== '') {
      avatar = author.profile_image;
    } else if (author.profile_image?.data?.[0]?.url && author.profile_image.data[0].url !== '') {
      avatar = author.profile_image.data[0].url;
    }
    
    return { name, avatar };
  }
  
  function getStoryStats(story) {
    // Extract likes and comments from the story object
    const likes = story.totalLikes || 0;
    const comments = story.comments?.length || 0;
    
    return { likes, comments };
  }
  
  function getStoryUrl(story) {
    return `{{ $base_url }}${story.meta?.web?.uri || story.path_part || ''}`;
  }
  
  function isVideoUrl(url) {
    if (!url) return false;
    const videoPatterns = [
      /vimeo\.com\/video\/\d+/i,
      /vimeo\.com\/\d+/i,
      /player\.vimeo\.com\/video\/\d+/i,
      /youtube\.com\/watch\?v=/i,
      /youtu\.be\//i,
      /\.mp4$/i,
      /\.webm$/i,
      /\.ogg$/i,
      /\.mov$/i,
      /\.avi$/i
    ];
    return videoPatterns.some(pattern => pattern.test(url));
  }
  
  function getVideoEmbedUrl(url) {
    if (!url) return null;
    
    // Vimeo player URL
    if (url.includes('player.vimeo.com/video/')) {
      return url.includes('?') ? url : `${url}?autoplay=0&loop=0&muted=1`;
    }
    
    // Vimeo regular URLs
    const vimeoMatch = url.match(/vimeo\.com\/(?:video\/)?(\d+)/i);
    if (vimeoMatch) {
      return `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=0&loop=0&muted=1`;
    }
    
    // YouTube
    const youtubeMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/i);
    if (youtubeMatch) {
      return `https://www.youtube.com/embed/${youtubeMatch[1]}?autoplay=0&loop=0&muted=1`;
    }
    
    // Direct video files
    if (/\.(mp4|webm|ogg|mov|avi)$/i.test(url)) {
      return url;
    }
    
    return null;
  }
  
  function formatTimeAgo(dateString) {
    if (!dateString) return '';
    
    try {
      let date;
      
      // Check if dateString is already in ISO format (includes 'T' and ends with 'Z' or timezone)
      if (dateString.includes('T') && (dateString.includes('Z') || dateString.includes('+') || dateString.includes('-'))) {
        // ISO format with timezone info - parse directly
        date = new Date(dateString);
      } else {
        // Legacy format without timezone - treat as UTC
        date = new Date(dateString + ' UTC');
      }
      
      // Validate the date
      if (isNaN(date.getTime())) {
        throw new Error('Invalid date');
      }
      
      const now = new Date();
      const diffInMilliseconds = now - date;
      const diffInSeconds = Math.floor(diffInMilliseconds / 1000);
      const diffInMinutes = Math.floor(diffInSeconds / 60);
      const diffInHours = Math.floor(diffInMinutes / 60);
      const diffInDays = Math.floor(diffInHours / 24);
      const diffInMonths = Math.floor(diffInDays / 30);
      const diffInYears = Math.floor(diffInDays / 365);
      
      if (diffInSeconds < 60) {
        return diffInSeconds <= 1 ? 'just now' : `${diffInSeconds}s ago`;
      } else if (diffInMinutes < 60) {
        return `${diffInMinutes}m ago`;
      } else if (diffInHours < 24) {
        return `${diffInHours}h ago`;
      } else if (diffInDays < 30) {
        return `${diffInDays}d ago`;
      } else if (diffInMonths < 12) {
        return `${diffInMonths}mo ago`;
      } else {
        return `${diffInYears}y ago`;
      }
    } catch (error) {
      console.error('Error formatting time:', error, 'Input:', dateString);
      return '';
    }
  }
  
  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
  
  function stripHtml(html) {
    if (!html) return '';
    return $('<div>').html(html).text();
  }
  
  // Normalize whitespace (remove &nbsp; and multiple spaces)
  function normalizeWhitespace(text) {
    if (!text) return '';
    let content = text.replace(/&nbsp;/g, ' '); // Replace &nbsp; with regular spaces
    content = content.replace(/\s+/g, ' ');   // Replace multiple spaces with a single space
    return content.trim(); // Trim leading/trailing whitespace
  }
  
  // Progress and navigation functions
  function startProgress() {
    if (!window.storyStreamData.isPlaying) return;
    
    window.storyStreamData.progressStartTime = Date.now();
    window.storyStreamData.progressInterval = setInterval(() => {
      const elapsed = Date.now() - window.storyStreamData.progressStartTime;
      const progress = Math.min((elapsed / window.storyStreamData.progressDuration) * 100, 100);
      
      $('#storyProgressFill').css('width', progress + '%');
      
      if (progress >= 100) {
        nextStory();
      }
    }, 50);
  }
  
  function resetProgress() {
    if (window.storyStreamData.progressInterval) {
      clearInterval(window.storyStreamData.progressInterval);
      window.storyStreamData.progressInterval = null;
    }
    $('#storyProgressFill').css('width', '0%');
  }
  
  function startAutoPlay() {
    if (window.storyStreamData.stories.length === 0) return;
    startProgress();
  }
  
  function stopAutoPlay() {
    resetProgress();
  }
  
  function togglePlayPause() {
    window.storyStreamData.isPlaying = !window.storyStreamData.isPlaying;
    
    const $btn = $('#pausePlayBtn');
    const $icon = $('#pausePlayIcon');
    const iconClass = window.storyStreamData.isPlaying ? 'bi-pause-fill' : 'bi-play-fill';
    
    // Add morphing class for animation
    $btn.addClass('morphing');
    
    // Change icon after half the animation duration
    setTimeout(() => {
      $icon.attr('class', 'bi ' + iconClass);
      $btn.removeClass('morphing');
    }, 200);
    
    if (window.storyStreamData.isPlaying) {
      startProgress();
    } else {
      resetProgress();
    }
  }
  
  function nextStory() {
    if (window.storyStreamData.carousel && !window.storyStreamData.isTransitioning) {
      window.storyStreamData.carousel.next();
    }
  }
  
  function previousStory() {
    if (window.storyStreamData.carousel && !window.storyStreamData.isTransitioning) {
      window.storyStreamData.carousel.prev();
    }
  }
  
  function goToStory(index) {
    if (window.storyStreamData.carousel && !window.storyStreamData.isTransitioning && 
        index >= 0 && index < window.storyStreamData.stories.length && 
        index !== window.storyStreamData.currentIndex) {
      window.storyStreamData.carousel.to(index);
    }
  }
  
  // Event handlers
  function handleKeydown(e) {
    switch (e.key) {
      case 'ArrowLeft':
        e.preventDefault();
        previousStory();
        break;
      case 'ArrowRight':
      case ' ':
        e.preventDefault();
        if (e.key === ' ') {
          togglePlayPause();
        } else {
          nextStory();
        }
        break;
      case 'Escape':
        e.preventDefault();
        window.closeStoryStream();
        break;
    }
  }
  
  function handleContainerClick(e) {
    // Check if click is on the right side (next) or left side (previous)
    const containerWidth = $('#storyStreamContainer').width();
    const clickX = e.offsetX || e.originalEvent.offsetX;
    
    // Don't trigger navigation if clicking on controls, overlay, or header
    if ($(e.target).closest('.story-controls, .story-indicators, .story-navigation, .story-header, .story-scrollable-content').length) {
      return;
    }
    
    if (clickX > containerWidth * 0.7) {
      nextStory();
    } else if (clickX < containerWidth * 0.3) {
      previousStory();
    } else {
      togglePlayPause();
    }
  }

  // Trigger ambient effect when carousel slides
  $('#storyStreamCarousel').off('slid.bs.carousel.ambient').on('slid.bs.carousel.ambient', function(e) {
    const $currentSlide = $(e.relatedTarget);
    const $mediaTarget = $currentSlide.find('[data-ambient-target="true"]');
    if ($mediaTarget.length) {
      drawAmbientEffect($mediaTarget[0]);
    }
  });

  // Start auto-refresh for new stories (live stream updates)
  function startAutoRefresh() {
    // Clear any existing interval
    if (window.storyStreamData.refreshInterval) {
      clearInterval(window.storyStreamData.refreshInterval);
    }
    
    window.storyStreamData.refreshInterval = setInterval(async () => {
      if (!window.storyStreamData.isRefreshing) {
        await loadStories(true);
      }
    }, 30000); // 30 seconds for story updates
    
  }
  
  // Stop auto-refresh
  function stopAutoRefresh() {
    if (window.storyStreamData.refreshInterval) {
      clearInterval(window.storyStreamData.refreshInterval);
      window.storyStreamData.refreshInterval = null;
    }
  }

  // Start stream data refresh (for configuration updates)
  function startStreamDataRefresh() {
    // Clear any existing interval
    if (window.storyStreamData.streamRefreshInterval) {
      clearInterval(window.storyStreamData.streamRefreshInterval);
    }
    
    window.storyStreamData.streamRefreshInterval = setInterval(async () => {
      await refreshStreamData();
    }, 60000); // 60 seconds for configuration updates
    
  }
  
  // Stop stream data refresh
  function stopStreamDataRefresh() {
    if (window.storyStreamData.streamRefreshInterval) {
      clearInterval(window.storyStreamData.streamRefreshInterval);
      window.storyStreamData.streamRefreshInterval = null;
    }
  }

  // Theme toggle function
  function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    const $btn = $('#themeToggleBtn');
    const $icon = $('#themeToggleIcon');
    
    // Add morphing class for animation
    $btn.addClass('morphing');
    
    // Change theme and icon after half the animation duration
    setTimeout(() => {
      document.documentElement.setAttribute('data-theme', newTheme);
      
      // Update icon
      if (newTheme === 'dark') {
        $icon.attr('class', 'bi bi-sun-fill');
      } else {
        $icon.attr('class', 'bi bi-moon-fill');
      }
      
      $btn.removeClass('morphing');
      
      // Store preference
      localStorage.setItem('storyStreamTheme', newTheme);
    }, 200);
  }

  // Initialize theme from localStorage or default to light
  function initializeTheme() {
    const savedTheme = localStorage.getItem('storyStreamTheme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    if (savedTheme === 'dark') {
      $('#themeToggleIcon').attr('class', 'bi bi-sun-fill');
    } else {
      $('#themeToggleIcon').attr('class', 'bi bi-moon-fill');
    }
  }

  // Event listener for theme toggle button
  $('#themeToggleBtn').off('click.storyStream').on('click.storyStream', toggleTheme);
});
</script>
